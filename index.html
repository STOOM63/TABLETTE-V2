<!doctype html>
<html lang="fr">
<head>

  <!--
    STOOM ‚Äì Outil Tablette PRO
    Logiciel d√©velopp√© par Arnaud BLANC
    ¬© 2024‚Äì2025 Arnaud BLANC ‚Äì Tous droits r√©serv√©s

    Ce logiciel est une ≈ìuvre originale dont Arnaud BLANC est l‚Äôauteur
    et le titulaire exclusif des droits de propri√©t√© intellectuelle.

    Toute reproduction, modification, diffusion ou utilisation,
    totale ou partielle, sans autorisation √©crite de l‚Äôauteur,
    est strictement interdite.

    Le logiciel est mis √† disposition de l‚Äôenseigne STOOM
    pour un usage interne uniquement.
  -->

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">

  <title>STOOM ¬∑ Outil Tablette PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="/TABLETTE-V2/manifest.json">

  <!-- iOS (iPad / iPhone) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="STOOM SAV">
  <link rel="apple-touch-icon" href="/TABLETTE-V2/icon-192.png">


  
  <style>
    :root{
      --bg:#070B14;
      --panel:#0B1220;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.56);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --gap: 14px;
      --accent:#3B82F6;
      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(1100px 800px at 55% 90%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, #070B14 0%, #050713 100%);
      overflow:hidden;
    }
    .app{height:100%; display:grid; grid-template-columns: 380px 1fr;}
    @media (max-width: 980px){body{overflow:auto}.app{grid-template-columns:1fr}}

    .sidebar{
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.02) 100%);
      border-right:1px solid var(--stroke);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      height:100%;
      overflow:auto;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      margin-bottom:14px;
    }
    .brand-left{display:flex; gap:12px; align-items:center;}
 
/* Logo Apple-like : wrapper + image */
.logoWrap{
  width:64px;
  height:64px;
  border-radius:20px;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:center;

  background: linear-gradient(135deg,
    rgba(255,255,255,.30),
    rgba(255,255,255,.08)
  );
  border: 1px solid rgba(255,255,255,.18);

  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  box-shadow:
    0 22px 60px rgba(0,0,0,.55),
    inset 0 1px 0 rgba(255,255,255,.35);
  position:relative;
  overflow:hidden;
}

.logoWrap::before{
  content:"";
  position:absolute;
  inset:-40%;
  background: radial-gradient(circle at 30% 20%,
    rgba(255,255,255,.55),
    transparent 55%
  );
  transform: rotate(20deg);
  opacity:.55;
}

.logoImg{
  width:100%;
  height:100%;
  object-fit:contain;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
  position:relative;
  z-index:1;
}
    .brand h1{font-size:14px; margin:0; letter-spacing:.08em; text-transform:uppercase}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 5px rgba(245,158,11,.12)}
    .dot.ok{background:var(--good);box-shadow:0 0 0 5px rgba(34,197,94,.12)}
    .pill button{
      all:unset; cursor:pointer; color:var(--text);
      padding:2px 6px; border-radius:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .pill button:hover{background:rgba(255,255,255,.10)}

    .nav{display:flex; flex-direction:column; gap:10px; margin-top:14px;}
    .navbtn{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .navbtn:hover{background: rgba(255,255,255,.06)}
    .navbtn:active{transform: scale(.99)}
    .navbtn.active{
      background: linear-gradient(135deg, rgba(59,130,246,.22), rgba(139,92,246,.12));
      border-color: rgba(59,130,246,.35);
    }
    .icon{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-family:var(--mono);
      font-size:13px;
      color:rgba(255,255,255,.85);
    }
    .navtxt{display:flex; flex-direction:column; gap:2px}
    .navtxt .t{font-size:13px; font-weight:700}
    .navtxt .s{font-size:12px; color:var(--muted)}
    .kbd{
      margin-left:auto;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted2);
      padding:4px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .side-card{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .side-card h3{margin:0 0 8px; font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted)}
    .side-card .row{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,.08)}
    .side-card .row:first-of-type{border-top:none}
    .side-card .row span{font-size:12px; color:var(--muted)}
    .side-card .row strong{font-size:12px}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .08s ease;
      font-size:12px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: scale(.99)}
    .btn.primary{border-color: rgba(59,130,246,.40); background: rgba(59,130,246,.18);}
    .btn.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12);}
    .btn.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12);}
    .btn[disabled]{opacity:.45; cursor:not-allowed}

    .main{height:100%; overflow:auto; padding:18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;}
    .search{
      flex:1; display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    .search input{all:unset; flex:1; font-size:13px; color:var(--text);}
    .search .hint{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted2);
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    @media (min-width:1180px){.grid.cols2{grid-template-columns:1.1fr .9fr;}}

    .panel{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .panel .ph h2{margin:0;font-size:14px;letter-spacing:.04em}
    .panel .ph p{margin:3px 0 0;font-size:12px;color:var(--muted)}
    .panel .pb{padding:14px;}

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      user-select:none;
    }

    .q{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
    }
    .q h3{margin:0 0 6px;font-size:14px}
    .q p{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.4}

    .two{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width:1180px){.two{grid-template-columns:1fr 1fr}}

    .choices{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;}
    @media (min-width:900px){
      .choices.cols3{grid-template-columns:repeat(3, minmax(0,1fr));}
      .choices.cols4{grid-template-columns:repeat(4, minmax(0,1fr));}
    }
    .choice{
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .choice:hover{background: rgba(255,255,255,.06)}
    .choice:active{transform: scale(.99)}
    .choice.selected{
      border-color: rgba(59,130,246,.45);
      background: rgba(59,130,246,.14);
    }
    .choice .ct{font-weight:800;font-size:13px}
    .choice .cs{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}

    textarea, select, input[type="number"], input[type="text"], input[type="password"], input[type="date"]{
      width:100%;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    textarea{min-height:96px; resize:vertical; line-height:1.4}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    .mono{font-family:var(--mono)}
    .small{font-size:11px; color:var(--muted2)}
    .hr{height:1px;background: rgba(255,255,255,.10); margin:12px 0}

    .steps{display:flex; gap:8px; flex-wrap:wrap;}
    .step{
      flex:1; min-width:120px;
      padding:10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .step.active{
      color: var(--text);
      border-color: rgba(59,130,246,.35);
      background: rgba(59,130,246,.10);
    }
    .step.done{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: var(--text);
    }

    .result{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, rgba(59,130,246,.16), rgba(139,92,246,.10));
      padding:14px;
    }
    .result h3{margin:0 0 8px;font-size:14px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
    }
    .chip b{font-weight:900}

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform: translateX(-50%);
      min-width: 280px; max-width: 92vw;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,32,.92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 20px 80px rgba(0,0,0,.6);
      display:none; z-index:9999;
    }
    .toast.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px); opacity:.2}to{transform:translateX(-50%) translateY(0); opacity:1}}
    .toast .t{font-size:12px;color:var(--text)}
    .toast .s{font-size:11px;color:var(--muted); margin-top:4px}

    .modal{
  position: fixed;
  inset: 0;
  display: none;

  /* ‚úÖ overlay au-dessus de tout */
  z-index: 10000;

  background: rgba(0,0,0,.55);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);

  /* ‚úÖ centre la carte */
  align-items: center;
  justify-content: center;

  padding: 18px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* ‚úÖ quand ouvert : FLEX (pas block) */
.modal.show{
  display: flex;
}

/* toast doit rester au-dessus si besoin */
.toast{ z-index: 11000; }
    .modal-card{
      max-width: 820px;
      margin: 40px auto;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,32,.92);
      box-shadow: 0 20px 90px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .modal-h{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal-h h3{margin:0;font-size:14px}
    .modal-b{padding:14px}
    .xbtn{
      all:unset; cursor:pointer;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--text);
    }
    .xbtn:hover{background: rgba(255,255,255,.08)}

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding:12px;
    }
    .item .top{display:flex; justify-content:space-between; gap:12px; align-items:flex-start}
    .item .top strong{font-size:13px}
    .item .top span{font-size:11px;color:var(--muted2);font-family:var(--mono)}
    .item p{margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.4}

    .dangerText{color: rgba(239,68,68,.92)}
    .goodText{color: rgba(34,197,94,.92)}
    .warnText{color: rgba(245,158,11,.92)}
    .tabSwitch{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;}
    .tabBtn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      user-select:none;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
    }
    .tabBtn:hover{background: rgba(255,255,255,.06)}
    .tabBtn:active{transform:scale(.99)}
    .tabBtn.active{border-color: rgba(59,130,246,.35); background: rgba(59,130,246,.14);}
    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .statusPill.wait{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.32); color:var(--warn);}
    .statusPill.over{background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.32); color:var(--bad);}
    .statusPill.done{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.32); color:var(--good);}
    .alertBanner{
      padding:12px;
      border-radius: var(--radius);
      border:1px solid rgba(239,68,68,.25);
      background: linear-gradient(135deg, rgba(239,68,68,.18), rgba(245,158,11,.14));
      box-shadow: var(--shadow);
      margin-bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .alertBanner strong{font-size:13px}
    .alertBanner .btnrow{margin:0}
    /* ===== FLUXA Onboarding polish ===== */
#licenseGate .modal-card, #welcomeModal .modal-card{
  animation: fluxaPop .18s ease-out;
}
@keyframes fluxaPop{
  from{ transform: translateY(10px); opacity:.2 }
  to{ transform: translateY(0); opacity:1 }
}

/* petit ‚Äúhalo‚Äù premium sur la carte */
#licenseGate .modal-card::before, #welcomeModal .modal-card::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius: var(--radius);
  background: radial-gradient(600px 240px at 20% 10%, rgba(59,130,246,.22), transparent 60%),
              radial-gradient(500px 220px at 80% 10%, rgba(236,72,153,.16), transparent 55%),
              radial-gradient(600px 260px at 50% 90%, rgba(34,197,94,.14), transparent 60%);
  pointer-events:none;
  z-index:-1;
  filter: blur(10px);
  opacity:.75;
}

/* ‚Äúconfettis‚Äù l√©ger en overlay sur le welcome */
#welcomeModal .result{
  position:relative;
  overflow:hidden;
}
#welcomeModal .result::after{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 10% 20%, rgba(255,255,255,.18), transparent 35%),
    radial-gradient(circle at 80% 30%, rgba(59,130,246,.18), transparent 35%),
    radial-gradient(circle at 30% 80%, rgba(34,197,94,.14), transparent 35%),
    radial-gradient(circle at 70% 85%, rgba(236,72,153,.14), transparent 35%);
  transform: rotate(12deg);
  opacity:.7;
  pointer-events:none;
}

  </style>
</head>
<body>
  <!-- =========================
     FLUXA ‚Ä¢ LICENCE GATE (Onboarding)
     ========================= -->
<div class="modal" id="licenseGate" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-card" style="max-width:860px">
    <div class="modal-h">
      <h3>Activation FLUXA (d√©mo)</h3>
      <button class="xbtn" onclick="/* optionnel: rien */"> </button>
    </div>

    <div class="modal-b">
      <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap">
        <div class="logoWrap" style="width:78px;height:78px;border-radius:24px">
          <img class="logoImg" src="/TABLETTE-V2/assets/logo-fluxa.png" alt="FLUXA">
        </div>

        <div style="flex:1; min-width:260px">
         <div style="font-weight:900; font-size:18px; letter-spacing:.02em">
  Activation de la d√©mo FLUXA
</div>

          <p class="muted" style="margin:8px 0 0; line-height:1.45">
            Afin d‚Äôactiver la d√©monstration de l‚Äôoutil FLUXA Tablette PRO,
merci d‚Äôindiquer la <b>cl√© de licence</b> remise par votre √©diteur.

          </p>

          <div class="chips" style="margin-top:10px">
            <span class="chip"><b>‚úî</b> Parcours client</span>
            <span class="chip"><b>‚úî</b> SAV imprimable</span>
            <span class="chip"><b>‚úî</b> Audit interne</span>
            <span class="chip"><b>‚úî</b> Donn√©es en local</span>
          </div>

          <p class="small" style="margin-top:10px; opacity:.75">
            Astuce : collez la cl√© (copier/coller) puis validez.
          </p>
        </div>
      </div>

      <div class="hr"></div>

      <label>Cl√© de licence</label>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <input id="licenseKeyInput" type="password" placeholder="Ex: FLUXA-DEMO-XXXX-XXXX" style="flex:1; min-width:260px" />
        <button class="btn primary" onclick="unlockWithLicense()">Activer</button>
      </div>

      <div class="small" style="margin-top:10px; opacity:.75">
        En cas de besoin : contactez l‚Äô√©diteur.
      </div>
    </div>
  </div>
</div>

<!-- Congrats popup -->
<div class="modal" id="welcomeModal" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-card" style="max-width:760px">
    <div class="modal-h">
      <h3>Bienvenue sur FLUXA</h3>
      <button class="xbtn" onclick="closeWelcome()">Fermer</button>
    </div>
    <div class="modal-b">
      <div class="result" style="padding:18px">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
          <div style="font-size:26px; line-height:1">üéä</div>
          <div style="flex:1; min-width:240px">
            <div style="font-weight:950; font-size:18px">
              F√©licitations, <span id="welcomeName">Isabelle</span> !
            </div>
            <p class="muted" style="margin:8px 0 0; line-height:1.45">
              Licence valid√©e ‚úÖ<br>
              Vous pouvez maintenant acc√©der √† l‚Äôoutil Tablette PRO FLUXA.
            </p>
          </div>
        </div>

        <div class="hr"></div>

        <div class="chips">
          <span class="chip"><b>Tip</b> Utilisez <span class="mono">H C S K N R A</span> pour naviguer vite</span>
          <span class="chip"><b>Tip</b> Le bouton ‚ÄúPIN‚Äù en haut sert √† connecter un vendeur</span>
        </div>

        <div class="btnrow" style="margin-top:14px">
          <button class="btn primary" onclick="enterApp()">Entrer dans FLUXA</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-left">
        <div class="logoWrap">
  <img class="logoImg" src="/TABLETTE-V2/assets/logo-fluxa.png" alt="FLUXA">
        </div>
        <div>
          <h1>STOOM</h1>
          <p>Tablette PRO ‚Ä¢ audit + SAV imprimable</p>
        </div>
      </div>
      <div class="pill" id="authPill" title="Connexion vendeur obligatoire">
        <span class="dot" id="authDot"></span>
        <span id="authLabel">Non connect√©</span>
        <button id="authBtn">PIN</button>
      </div>
    </div>

    <div class="nav" id="nav">
      <div class="navbtn active" data-view="home" tabindex="0">
        <div class="icon">01</div>
        <div class="navtxt"><div class="t">Accueil</div><div class="s">parcours + SAV + audit</div></div>
        <div class="kbd">H</div>
      </div>

      <div class="navbtn" data-view="client" tabindex="0">
        <div class="icon">CL</div>
        <div class="navtxt"><div class="t">Parcours client</div><div class="s">diagnostic + fiche</div></div>
        <div class="kbd">C</div>
      </div>

      <div class="navbtn" data-view="sav" tabindex="0">
        <div class="icon">SV</div>
        <div class="navtxt"><div class="t">SAV</div><div class="s">guid√© + fiche A4</div></div>
        <div class="kbd">S</div>
      </div>

      <div class="navbtn" data-view="calc" tabindex="0">
        <div class="icon">‚Ç¨</div>
        <div class="navtxt"><div class="t">Calculs</div><div class="s">conso & √©conomies</div></div>
        <div class="kbd">K</div>
      </div>

    <div class="navbtn" data-view="accu" tabindex="0">
  <div class="icon">üîã</div>
  <div class="navtxt">
    <div class="t">Accus &amp; S√©curit√©</div>
    <div class="s">loi d‚ÄôOhm + bonnes pratiques</div>
  </div>
  <div class="kbd">B</div>
</div>


      <div class="navbtn" data-view="notes" tabindex="0">
        <div class="icon">üìù</div>
        <div class="navtxt"><div class="t">Notes client</div><div class="s">suivi (prot√©g√©)</div></div>
        <div class="kbd">N</div>
      </div>

      <div class="navbtn" data-view="followup" tabindex="0">
        <div class="icon">üìû</div>
        <div class="navtxt"><div class="t">Rappels</div><div class="s">suivi t√©l√©phonique</div></div>
        <div class="kbd">R</div>
      </div>

      <div class="navbtn" data-view="manager" tabindex="0" id="managerNav" style="display:none">
        <div class="icon">AD</div>
        <div class="navtxt"><div class="t">Responsable</div><div class="s">r√®gles + audit + users</div></div>
        <div class="kbd">A</div>
      </div>
    </div>

    <div class="side-card">
      <h3>Session</h3>
      <div class="row"><span>Date</span> <strong id="today"></strong></div>
      <div class="row"><span>Utilisateur</span> <strong id="userMini">‚Äî</strong></div>
      <div class="row"><span>R√¥le</span> <strong id="roleMini">‚Äî</strong></div>
      <div class="row"><span>Derni√®re fiche</span> <strong id="sheetMini">‚Äî</strong></div>
      <div class="row"><span>Rappels</span> <strong id="followupMini">0</strong></div>

      <div class="btnrow">
        <button class="btn primary" id="printBtn">Imprimer fiche client</button>
        <button class="btn" id="exportStateBtn">Exporter</button>
      </div>
      <div class="btnrow">
        <button class="btn" id="importStateBtn">Importer</button>
        <button class="btn danger" id="resetBtn">R√©initialiser</button>
      </div>

      <div class="small" style="margin-top:10px">
        ‚ö†Ô∏è Export/Import/Reset : <b>Responsable uniquement</b>.<br/>
        Offline : OK (stockage appareil).<br/>
        Raccourcis : H C S K N R A ‚Ä¢ <span class="mono">Ctrl/Cmd+P</span> ‚Ä¢ <span class="mono">/</span> recherche ‚Ä¢ <span class="mono">Esc</span>.
      </div>
      <div class="small" style="margin-top:12px; opacity:.55">
  Logiciel d√©velopp√© par <b>Arnaud BLANC</b><br/>
  ¬© 2024‚Äì2025 Arnaud BLANC ‚Äì Tous droits r√©serv√©s<br/>
  Propri√©t√© intellectuelle exclusive ‚Äì usage interne STOOM<br/>
  INPI : DSO2025030622<br/>
  RGPD Ready : Les donn√©es enregistr√©es ne sont en aucun cas stock√©es par l√©diteur<br/>
  Les donn√©es sont stock√©es uniquement en local
</div>

    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="opacity:.8">üîé</span>
        <input id="searchInput" type="text" placeholder="Rechercher (ex: fuite, br√ªl√©, MTL, sel, audit...)" />
        <span class="hint">/</span>
      </div>
      <button class="btn" id="quickNew">Nouveau client</button>
      <button class="btn" id="logoutBtn">D√©connexion</button>
    </div>

    <!-- HOME -->
    <div id="view-home" class="view">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Accueil</h2>
              <p>Parcours client + SAV + tra√ßabilit√©.</p>
            </div>
            <span class="badge">Pro</span>
          </div>
          <div class="pb">
            <div class="alertBanner" id="homeFollowupBanner" style="display:none">
              <div>
                <strong id="homeFollowupText">‚Äî</strong>
                <div class="small">Les rappels en retard ou √† faire aujourd‚Äôhui sont list√©s dans l‚Äôonglet Suivis.</div>
              </div>
              <div class="btnrow">
                <button class="btn primary" onclick="openFollowupsTab()">Voir les rappels</button>
              </div>
            </div>
            <div class="two">
              <div class="result">
                <h3>‚úÖ Raccourcis</h3>
                <div class="chips">
                  <span class="chip"><b>Client</b> ‚Üí Diagnostic</span>
                  <span class="chip"><b>SAV</b> ‚Üí Fiche A4</span>
                  <span class="chip"><b>Notes</b> ‚Üí Suivi</span>
                </div>
                <p class="small" style="margin-top:10px">
                  Objectif : recommandation stable + preuve d‚Äôutilisation (audit).
                </p>
                <div class="btnrow">
                  <button class="btn primary" onclick="go('client')">D√©marrer diagnostic</button>
                  <button class="btn" onclick="go('sav')">D√©marrer SAV</button>
                  <button class="btn" onclick="setNotesTab('notes'); go('notes')">Notes</button>
                </div>
              </div>

              <div class="q">
                <h3>‚öôÔ∏è R√®gles actives (r√©sum√©)</h3>
                <p class="muted" id="rulesSummary">‚Äî</p>
                <div class="btnrow">
                  <button class="btn" onclick="toast('Info', 'Les r√®gles modifient tirage/puissance/mat√©riel/nicotine selon les r√©ponses.')">Comprendre</button>
                  <button class="btn primary" id="goManagerBtn" style="display:none" onclick="go('manager')">Modifier (responsable)</button>
                </div>
                <div class="hr"></div>
                <h3>üß† Message cl√©</h3>
                <p class="muted">
                  ‚ÄúOn vise d‚Äôabord <b>z√©ro cigarette</b>. La baisse de nicotine vient quand c‚Äôest stable et confortable.‚Äù
                </p>
              </div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>üßæ Audit (aper√ßu)</h3>
              <p class="muted">Aper√ßu 5 derni√®res actions. (Audit complet : responsable uniquement.)</p>
              <div id="auditPeek" class="list"></div>
            </div>

          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Derni√®re fiche client</h2>
              <p>Reprise auto.</p>
            </div>
            <span class="badge">Auto</span>
          </div>
          <div class="pb">
            <div id="lastSheetBox" class="q">
              <h3>‚Äî</h3>
              <p class="muted">Aucune fiche pour le moment.</p>
              <div class="btnrow"><button class="btn" onclick="go('client')">Cr√©er une fiche</button></div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>Derni√®re fiche SAV</h3>
              <p class="muted">Si tu viens de traiter un SAV, tu peux r√©-imprimer.</p>
              <div class="btnrow">
                <button class="btn" onclick="reprintLastSav()">R√©-imprimer SAV</button>
              </div>
              <div class="small">L‚Äôinfo SAV est stock√©e localement sur la tablette.</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- CLIENT -->
    <div id="view-client" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Parcours client</h2>
              <p>5 questions ‚Üí fiche claire.</p>
            </div>
            <span class="badge">Wizard</span>
          </div>
          <div class="pb">
            <div class="steps" id="clientSteps"></div>
            <div class="q" id="clientQuestionBox" style="margin-top:12px"></div>
            <div class="btnrow" style="justify-content:space-between">
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
                <button class="btn" id="clientPrev">Pr√©c√©dent</button>
                <span class="small mono">Astuce : 1/2/3/4 pour r√©pondre vite.</span>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" onclick="clientReset()">Recommencer</button>
                <button class="btn primary" id="clientNext">Suivant</button>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Fiche recommandation</h2>
              <p>Auto-g√©n√©r√©e selon les r√®gles actives.</p>
            </div>
            <span class="badge">Fiche</span>
          </div>
          <div class="pb">
            <div class="result" id="sheetBox">
              <h3>En attente‚Ä¶</h3>
              R√©ponds aux questions pour g√©n√©rer la fiche.</p>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>üó£Ô∏è Phrase pr√™te √† dire</h3>
              <p class="muted mono" id="salesLine">‚Äî</p>
              <div class="btnrow">
                <button class="btn" onclick="copySalesLine()">Copier</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

   <!-- SAV -->
<div id="view-sav" class="view" style="display:none">
  <div class="grid cols2">
    <section class="panel">
      <div class="ph">
        <div>
          <h2>SAV guid√©</h2>
          <p>Sympt√¥me ‚Üí causes ‚Üí actions ‚Üí fiche imprimable.</p>
        </div>
        <span class="badge">SAV</span>
      </div>

      <div class="pb">
        <div class="q">
          <h3>Quel probl√®me principal ?</h3>
          <p class="muted">Choisis le sympt√¥me dominant.</p>
          <div class="choices cols3" id="savChoices"></div>
        </div>

        <div class="q" id="savResult" style="margin-top:12px">
          <h3>En attente‚Ä¶</h3>
          <p class="muted">S√©lectionne un sympt√¥me.</p>
        </div>

        <div class="q" style="margin-top:12px">
          <h3>Probl√®me constat√© (par le vendeur)</h3>
          <p class="muted">Ce texte sera repris automatiquement dans la fiche SAV.</p>
          <textarea id="savVendorProblem" placeholder="Ex: ne charge plus / fuite importante / go√ªt br√ªl√© malgr√© changement de r√©sistance..."></textarea>
          <div class="btnrow" style="margin-top:10px">
            <button class="btn primary" id="createSavBtn" onclick="handleSavCreate()">Cr√©er fiche SAV imprimable</button>
            <button class="btn" onclick="clearSavProblem()">Effacer</button>
          </div>
          <div class="small">La fiche SAV sert de preuve interne + justificatif dans le colis fournisseur.</div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="ph">
        <div>
          <h2>Checklist SAV</h2>
          <p>Trame simple (60 secondes).</p>
        </div>
        <span class="badge">Pro</span>
      </div>

      <div class="pb">
        <div class="q">
          <h3>Questions √† poser</h3>
          <ul class="muted" style="margin:10px 0 0; padding-left:18px">
            <li>Depuis quand ? (aujourd‚Äôhui / 2 jours / 1 semaine)</li>
            <li>Liquide : taux / ratio / nouveaut√© ?</li>
            <li>R√©sistance : neuve ? amor√ßage ? puissance ?</li>
            <li>Airflow : trop ouvert ? tirage trop fort ?</li>
            <li>Choc / chaleur / fuite dans la poche ?</li>
          </ul>
          <div class="hr"></div>
          <h3>Conclusion</h3>
          <p class="muted">‚ÄúOn fait <b>1 changement √† la fois</b>, puis on valide. Le but : usage stable.‚Äù</p>
        </div>

        <div class="q" style="margin-top:12px">
          <h3>Historique SAV</h3>
          <p class="muted">Recherche + r√©-impression. Suppression/Export : responsable.</p>

          <label>Filtrer (produit, raison, op√©rateur...)</label>
          <input id="savHistoryFilter" type="text" placeholder="Ex: XROS, fuite, Evan..." />

          <div class="btnrow" style="margin-top:10px">
            <button class="btn" onclick="renderSavHistory()">Appliquer</button>
            <button class="btn primary" onclick="exportSavHistoryCSV()">Exporter CSV</button>
            <button class="btn danger" onclick="clearSavHistory()">Vider historique</button>
          </div>

          <div class="hr"></div>
          <div id="savHistoryList" class="list"></div>
        </div>
      </div>
    </section>
  </div>
</div>

    <!-- CALC -->
    <div id="view-calc" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Calculateur conso</h2>
              <p>Estimation flacons 10ml.</p>
            </div>
            <span class="badge">10ml</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Cigarettes / jour</label>
                  <input id="cigsPerDay" type="number" min="0" step="1" placeholder="Ex: 20" />
                </div>
                <div>
                  <label>Dur√©e (jours)</label>
                  <input id="days" type="number" min="1" step="1" value="30" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Hypoth√®se</label>
                  <select id="mlPerDayAt20">
                    <option value="3">20 cig/j ‚âà 3 ml/j</option>
                    <option value="4" selected>20 cig/j ‚âà 4 ml/j</option>
                    <option value="5">20 cig/j ‚âà 5 ml/j</option>
                  </select>
                </div>
                <div>
                  <label>Prix flacon 10ml (‚Ç¨)</label>
                  <input id="price10ml" type="number" min="0" step="0.1" placeholder="Ex: 5.9" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="calcBottles()">Calculer</button>
                <button class="btn" onclick="fillExample()">Exemple (20 cig/j)</button>
              </div>

              <div class="hr"></div>
              <div class="result" id="bottleResult">
                <h3>R√©sultat</h3>
                Renseigne les champs puis ‚ÄúCalculer‚Äù.</p>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Comparatif √©conomies</h2>
              <p>Tabac vs vape.</p>
            </div>
            <span class="badge">‚Ç¨</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Prix paquet (‚Ç¨)</label>
                  <input id="packPrice" type="number" min="0" step="0.1" placeholder="Ex: 12.5" />
                </div>
                <div>
                  <label>Paquets / jour</label>
                  <input id="packsPerDay" type="number" min="0" step="0.1" placeholder="Ex: 1" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Budget vape / mois (‚Ç¨)</label>
                  <input id="vapeMonthly" type="number" min="0" step="1" placeholder="Ex: 60" />
                </div>
                <div>
                  <label>Dur√©e (mois)</label>
                  <input id="months" type="number" min="1" step="1" value="12" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="calcSavings()">Calculer</button>
              </div>

              <div class="hr"></div>
              <div class="result" id="savingsResult">
                <h3>R√©sultat</h3>
                Renseigne puis ‚ÄúCalculer‚Äù.</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- ACCUS & S√âCURIT√â -->
<div id="view-accu" class="view" style="display:none">
  <div class="grid cols2">

    <section class="panel">
      <div class="ph">
        <div>
          <h2>Accus & S√©curit√©</h2>
          <p>Calculateur loi d‚ÄôOhm (automatique).</p>
        </div>
        <span class="badge">S√©curit√©</span>
      </div>

   <div class="pb">
  <div class="q">
    <div class="two">
      <div>
        <label>Puissance (W)</label>
        <input id="accuWatts" type="number" min="1" step="1" value="30" />
      </div>

      <div>
        <label>Box</label>
        <select id="accuCells">
          <option value="1">Simple accu (1)</option>
          <option value="2">Double accus (2)</option>
        </select>
      </div>
    </div>

    <div class="btnrow" style="margin-top:10px">
      <button class="btn primary" onclick="calcAccu()">Calculer</button>
      <button class="btn" onclick="resetAccuCalc()">Reset</button>
    </div>

    <div class="hr"></div>

    <div class="result" id="accuResult">
      <h3>R√©sultat</h3>
      <div class="small">Renseigne puis ‚ÄúCalculer‚Äù.</div>
    </div>
  </div>
</div>


    </section>

    <section class="panel">
      <div class="ph">
        <div>
          <h2>Bonnes pratiques</h2>
          <p>Rappels s√©curit√© accus.</p>
        </div>
        <span class="badge">Important</span>
      </div>

      <div class="pb">
        <div class="q">
  <h3>Rappels s√©curit√© accus</h3>
  <ul class="muted" style="margin:10px 0 0; padding-left:18px">
    <li>Accus dans un √©tui, jamais en vrac (cl√©s/monnaie = court-circuit).</li>
    <li>Wrap/isolant ab√Æm√© = stop imm√©diat (rewrap ou remplacement).</li>
    <li>Ne jamais charger un accu ab√Æm√©, chaud, ou suspect.</li>
    <li>√âviter charge ‚Äúrapide‚Äù inutile : privil√©gier charge lente / chargeur externe.</li>
    <li>Stockage : au frais, au sec, √† l‚Äôabri du soleil / voiture.</li>
    <li>On reste loin des limites : marge de s√©curit√© obligatoire.</li>
  </ul>
</div>

      </div>
    </section>

  </div>
</div>


    <!-- NOTES -->
    <div id="view-notes" class="view" style="display:none">
      <div class="tabSwitch" id="notesTabSwitch">
        <button class="tabBtn active" data-tab="notes" onclick="setNotesTab('notes')">Notes</button>
        <button class="tabBtn" data-tab="followups" onclick="setNotesTab('followups')">Suivis / Rappels</button>
      </div>

      <div id="notesTab-notes">
        <div class="grid cols2">
          <section class="panel">
            <div class="ph">
              <div>
                <h2>Notes client</h2>
                <p>Suivi local (prot√©g√©).</p>
              </div>
              <span class="badge">Local</span>
            </div>
            <div class="pb">
              <div class="q">
                <div class="two">
                  <div>
                    <label>Nom / pseudo client</label>
                    <input id="noteName" type="text" placeholder="Ex: M. Dupont" />
                  </div>
                  <div>
                    <label>T√©l√©phone (optionnel)</label>
                    <input id="notePhone" type="text" placeholder="Ex: 06..." />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Note</label>
                  <textarea id="noteText" placeholder="Ex: 20 cig/j, 10mg sel, MTL. Sensible ‚Üí baisser puissance."></textarea>
                </div>

                <div class="btnrow">
                  <button class="btn primary" onclick="saveNote()">Enregistrer</button>
                  <button class="btn" onclick="clearNoteForm()">Effacer</button>
                  <button class="btn" id="toggleMaskBtn" style="display:none" onclick="toggleMaskPhones()">Masquer/afficher num√©ros</button>
                </div>

                <div class="small" style="margin-top:10px">
                  Conseil RGPD : √©viter de stocker plus que n√©cessaire.
                </div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="ph">
              <div>
                <h2>Historique</h2>
                <p>Recherche + suppression (responsable).</p>
              </div>
              <span class="badge">CRM light</span>
            </div>
            <div class="pb">
              <div class="q">
                <label>Filtrer</label>
                <input id="noteFilter" type="text" placeholder="Nom, mot, num√©ro..." />
                <div class="hr"></div>
                <div id="notesList" class="list"></div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <div id="notesTab-followups" style="display:none">
        <div class="grid cols2">
          <section class="panel">
            <div class="ph">
              <div>
                <h2>Suivis / Rappels</h2>
                <p>Planifier et tracer les appels.</p>
              </div>
              <span class="badge">Agenda</span>
            </div>
            <div class="pb">
              <div class="q">
                <div class="two">
                  <div>
                    <label>Nom client *</label>
                    <input id="followName" type="text" placeholder="Ex: Jean Dupont" />
                  </div>
                  <div>
                    <label>T√©l√©phone</label>
                    <input id="followPhone" type="text" placeholder="Ex: 06..." />
                  </div>
                </div>

                <div class="two" style="margin-top:10px">
                  <div>
                    <label>Date de rappel *</label>
                    <input id="followDueDate" type="date" />
                  </div>
                  <div>
                    <label>Heure (optionnel)</label>
                    <input id="followDueTime" type="time" />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>R√©sum√© / fiche client</label>
                  <textarea id="followSummary" placeholder="Profil fumeur, mat√©riel propos√©, liquide/taux‚Ä¶"></textarea>
                </div>

                <div class="btnrow" style="margin-top:10px">
                  <button class="btn primary" id="followSaveBtn" onclick="saveFollowup()">Cr√©er le rappel</button>
                  <button class="btn" onclick="clearFollowupForm()">Nouvelle fiche</button>
                </div>
                <div class="small" style="margin-top:8px">Cr√©ation/√©dition vendeur OK. Suppression/export : responsable uniquement.</div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="ph">
              <div>
                <h2>Rappels programm√©s</h2>
                <p>Statuts + actions rapides.</p>
              </div>
              <span class="badge">Suivi</span>
            </div>
            <div class="pb">
              <div class="q">
                <label>Recherche</label>
                <input id="followupFilter" type="text" placeholder="Nom, t√©l√©phone, r√©sum√©, r√©sultat..." />
                <div class="btnrow" style="margin-top:10px">
                  <button class="btn" onclick="renderFollowups()">Appliquer</button>
                  <button class="btn" id="exportFollowupsBtn" onclick="exportFollowupsCSV()">Exporter CSV</button>
                  <button class="btn danger" id="clearFollowupsBtn" onclick="clearFollowups()">Vider suivis</button>
                </div>
                <div class="hr"></div>
                <div id="followList" class="list"></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- MANAGER -->
    <div id="view-manager" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Espace responsable</h2>
              <p>R√®gles + utilisateurs + audit.</p>
            </div>
            <span class="badge">Admin</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>R√®gles de recommandation</h3>
              Modifiable par responsable.</p>
              <div id="rulesEditor"></div>
              <div class="btnrow">
                <button class="btn primary" onclick="saveRulesFromUI()">Enregistrer r√®gles</button>
                <button class="btn" onclick="resetRules()">R√©initialiser r√®gles</button>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Utilisateurs & Audit</h2>
              <p>Ajouter vendeurs / export journal.</p>
            </div>
            <span class="badge">S√©curit√©</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Gestion utilisateurs</h3>
              <div id="usersList" class="list"></div>

              <div class="hr"></div>

              <h3>Ajouter un utilisateur</h3>
              <div class="two">
                <div>
                  <label>Nom</label>
                  <input id="newUserName" type="text" placeholder="Ex: Marie" />
                </div>
                <div>
                  <label>PIN (4 chiffres mini)</label>
                  <input id="newUserPin" type="password" inputmode="numeric" placeholder="Ex: 3344" />
                </div>
              </div>
              <div class="two" style="margin-top:10px">
                <div>
                  <label>R√¥le</label>
                  <select id="newUserRole">
                    <option value="seller">Vendeur</option>
                    <option value="manager">Responsable</option>
                  </select>
                </div>
                <div>
                  <label>Identifiant (auto)</label>
                  <input id="newUserId" type="text" placeholder="auto" disabled />
                </div>
              </div>
              <div class="btnrow">
                <button class="btn primary" onclick="addUser()">Ajouter</button>
              </div>
            </div>

            <div class="q" style="margin-top:12px">
              <h3>Audit (journal d‚Äôutilisation)</h3>
              Filtrable + export.</p>
              <div class="two">
                <div>
                  <label>Filtrer</label>
                  <input id="auditFilter" type="text" placeholder="Ex: Evan, FICHE, NOTE..." />
                </div>
                <div>
                  <label>Limiter (lignes)</label>
                  <select id="auditLimit">
                    <option value="50">50</option>
                    <option value="200" selected>200</option>
                    <option value="500">500</option>
                    <option value="2000">2000</option>
                  </select>
                </div>
              </div>
              <div class="btnrow">
                <button class="btn" onclick="renderAudit()">Appliquer</button>
                <button class="btn primary" onclick="exportAuditJSON()">Exporter JSON</button>
                <button class="btn" onclick="exportAuditCSV()">Exporter CSV</button>
                <button class="btn danger" onclick="clearAudit()">Vider audit</button>
              </div>
              <div class="hr"></div>
              <div id="auditList" class="list"></div>
            </div>

          </div>
        </section>
      </div>
    </div>

  </main>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastT">‚Äî</div>
  <div class="s" id="toastS">‚Äî</div>
</div>

<!-- AUTH MODAL -->
<div class="modal" id="authModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Connexion vendeur (PIN)</h3>
      <button class="xbtn" onclick="closeAuthModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">S√©lectionne ton nom puis entre ton PIN.</p>
      <div id="firstSetup" style="display:none; margin-top:12px">
  <div class="q">
    <h3>Premier lancement</h3>
    <p class="muted">Aucun utilisateur n‚Äôexiste. Cr√©e le premier <b>responsable</b> de la boutique.</p>

    <div class="two">
      <div>
        <label>Nom</label>
        <input id="firstManagerName" type="text" placeholder="Ex: Responsable Boutique" />
      </div>
      <div>
        <label>PIN (4 chiffres mini)</label>
        <input id="firstManagerPin" type="password" inputmode="numeric" placeholder="Ex: 1234" />
      </div>
    </div>

    <div class="btnrow" style="margin-top:12px">
      <button class="btn primary" onclick="createFirstManager()">Cr√©er le responsable</button>
    </div>
  </div>
</div>

<div id="authNormal">
  
      <label>Utilisateur</label>
      <select id="authUserSelect"></select>

      <div style="margin-top:10px">
        <label>PIN</label>
        <input type="password" id="authPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" />
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn primary" onclick="login()">Se connecter</button>
        <button class="btn" onclick="logout()">D√©connexion</button>
      </div>

      <div class="hr"></div>
      <p class="small mono">
        Responsable = acc√®s r√®gles + audit + export/import.
      </p>
    </div>
  </div>
</div>

<!-- IMPORT MODAL (manager only) -->
<div class="modal" id="importModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Importer un export</h3>
      <button class="xbtn" onclick="closeImportModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">Colle ici le JSON export√© (√©tat complet). Cela remplacera les donn√©es locales.</p>
      <label>JSON</label>
      <textarea id="importText" placeholder='{"exportedAt":"...","state":{...}}'></textarea>
      <div class="btnrow" style="margin-top:12px">
        <button class="btn primary" onclick="importState()">Importer maintenant</button>
      </div>
    </div>
  </div>
</div>

<!-- SAV FORM MODAL -->
<div class="modal" id="savModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Fiche SAV</h3>
      <button class="xbtn" onclick="closeSavModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">Cette fiche est imprimable et sert d‚Äôappui vendeur (acceptation/refus de garantie).</p>

      <div class="two">
        <div>
          <label>Nom & pr√©nom client</label>
          <input id="savClientName" type="text" placeholder="Ex: DUPONT Jean" />
        </div>
        <div>
          <label>Date d‚Äôachat</label>
          <input id="savPurchaseDate" type="date" />
        </div>
        
      </div>
<div class="two" style="margin-top:10px">
  <div>
    <label>R√©f√©rence produit *</label>
    <input id="savProductRef" type="text" placeholder="Ex: XROS-3 / Aegis Boost / Wenax..." />
  </div>
  <div>
    <label>Couleur *</label>
    <input id="savProductColor" type="text" placeholder="Ex: Noir, Silver, Gunmetal..." />
  </div>
</div>

<div style="margin-top:10px">
  <label>Scratch code (optionnel)</label>
  <input id="savScratchCode" type="text" placeholder="Code d‚Äôauthentification (si pr√©sent)" />
</div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Produit en bon √©tat (pas de chute / casse) ?</label>
          <select id="savGoodState">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
        <div>
          <label>Port de charge intact ?</label>
          <select id="savPortOk">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Bo√Æte produit pr√©sente ?</label>
          <select id="savBoxPresent">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
        <div>
          <label>C√¢ble de charge pr√©sent ?</label>
          <select id="savCablePresent">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Probl√®me constat√© (repris SAV)</label>
        <textarea id="savProblemText" placeholder="(repris automatiquement, modifiable si besoin)"></textarea>
        <div class="small" style="margin-top:6px">
          Sympt√¥me s√©lectionn√© : <span class="mono" id="savSymptomLabel">‚Äî</span>
        </div>
      </div>

      <div class="hr"></div>
      <div class="btnrow">
        <button class="btn primary" onclick="validateSavAndPrint()">Valider & Imprimer fiche SAV</button>
        <button class="btn" onclick="previewSavEligibility()">Voir d√©cision</button>
      </div>

      <div class="q" style="margin-top:12px">
        <h3>D√©cision</h3>
        <p class="muted" id="savDecisionBox">‚Äî</p>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   STOOM ‚Ä¢ Tablette PRO (v2)
   - PIN / r√¥les
   - export/import BLOQU√âS vendeurs
   - audit complet: responsable seulement
   - SAV: fiche imprimable A4 accept/refus + raisons
   ========================= */

const LS = { state: "stoom_tablette_v2_state" };
/* =========================
   FLUXA ‚Ä¢ Licence gate
   ========================= */
const LICENSE = {
  lsOk: "fluxa_license_ok",
  lsName: "fluxa_pilot_name",
  // ‚úÖ Mets ici la cl√© remise √† ta PDG
  allowed: ["7852-5487-7855-8254"]
};

function getPilotName(){
  return localStorage.getItem(LICENSE.lsName) || "Isabelle";
}
function setPilotName(n){
  localStorage.setItem(LICENSE.lsName, n);
}
function hasValidLicense(){
  return localStorage.getItem(LICENSE.lsOk) === "1";
}

function openLicenseGate(){
  // Nom personnalisable (tu peux changer ‚ÄúIsabelle‚Äù ici)
  const name = getPilotName();
  document.getElementById("welcomeName").textContent = name;

  document.getElementById("licenseKeyInput").value = "";
  document.getElementById("licenseGate").style.display = "block";
  document.getElementById("licenseGate").classList.add("show");

  setTimeout(()=> document.getElementById("licenseKeyInput").focus(), 50);
}

function closeLicenseGate(){
  document.getElementById("licenseGate").classList.remove("show");
  document.getElementById("licenseGate").style.display = "none";
}

function openWelcome(){
  const name = getPilotName();
  document.getElementById("welcomeName").textContent = name;

  document.getElementById("welcomeModal").style.display = "block";
  document.getElementById("welcomeModal").classList.add("show");
}

function closeWelcome(){
  document.getElementById("welcomeModal").classList.remove("show");
  document.getElementById("welcomeModal").style.display = "none";
}

function unlockWithLicense(){
  const key = (document.getElementById("licenseKeyInput").value || "").trim();

  // Option : autoriser aussi une cl√© en minuscules/espaces
  const normalized = key.replace(/\s+/g,"").toUpperCase();
  const ok = LICENSE.allowed.some(k => k.toUpperCase() === normalized);

  if(!ok){
    toast("Cl√© invalide", "V√©rifiez la licence remise par l‚Äô√©diteur.");
    return;
  }

  localStorage.setItem(LICENSE.lsOk, "1");
  closeLicenseGate();

  // petit effet ‚Äúpro‚Äù
  toast("Licence valid√©e", "Activation r√©ussie ‚úÖ");
  openWelcome();
}

function enterApp(){
  closeWelcome();
  startApp();
}


const DEFAULT_STATE = {
  settings: { shopName: "STOOM Clermont-Ferrand", maskPhones: true },
  users: [],
  currentUser: null,
  view: "home",
  notesTab: "notes",
  audit: [],
  notes: [],
  followups: [],
  sav: {
    symptom: null,
    vendorProblem: "",
    lastSavSheet: null,
    history: []   // ‚úÖ historique SAV
  },
  client: {
    step: 0,
    answers: { cigs:null, cigType:null, moments:null, goal:null, tried:null },
    sheet: null
  },

  accu: {
    vMin: 3.2,
    eff: 0.90,
    margin: 1.25,
    cells: 1,
    watts: 30,
    catalog: [
      { id:"vtc5a", name:"Sony VTC5A", cdr:25, mah:2600, notes:"Tr√®s bon pour hautes puissances" },
      { id:"vtc6",  name:"Sony VTC6",  cdr:15, mah:3000, notes:"Autonomie, puissance mod√©r√©e" },
      { id:"vtc5",  name:"Sony VTC5",  cdr:20, mah:2600, notes:"Polyvalent" },
      { id:"hg2",   name:"LG HG2",     cdr:20, mah:3000, notes:"Autonomie + bon compromis" },
      { id:"25r",   name:"Samsung 25R",cdr:15, mah:2500, notes:"Classique fiable" },
    ]
  },

   rules: {
    byCigs: {
      "5-10":  { nicotine:"3‚Äì6 mg",        tirage:"MTL (serr√© √† semi-serr√©)", power:"Mod√©r√©e",  hardware:"Pod/kit MTL fiable" },
      "10-15": { nicotine:"6‚Äì12 mg",       tirage:"MTL (serr√©)",             power:"Mod√©r√©e",  hardware:"Pod/kit MTL fiable" },
      "15-20": { nicotine:"10 mg (sels)",  tirage:"MTL (serr√©, r√©gulier)",   power:"Faible (confort)", hardware:"Pod MTL / tirage serr√©" },
      "25+":   { nicotine:"20 mg (sels)",  tirage:"MTL (serr√©, r√©gulier)",   power:"Faible (confort)", hardware:"Pod MTL / tirage serr√©" }
    }
  }

};

const state = loadState();

/* ---------- Utils ---------- */
function $(q){ return document.querySelector(q); }
function $all(q){ return Array.from(document.querySelectorAll(q)); }
function safeJsonParse(str, fallback){ try{ return JSON.parse(str); }catch(e){ return fallback; } }
function deepMerge(target, src){
  if(!src || typeof src !== "object") return target;
  for(const k of Object.keys(src)){
    const v = src[k];
    if(Array.isArray(v)) target[k] = v;
    else if(v && typeof v === "object"){
      if(!target[k] || typeof target[k] !== "object") target[k] = {};
      deepMerge(target[k], v);
    } else target[k] = v;
  }
  return target;
}
function saveState(){
  localStorage.setItem(LS.state, JSON.stringify(state));
  refreshSidebarMini();
  refreshHomeLastSheet();
  refreshRulesSummary();
  renderAuditPeek();
  updateFollowUpAlerts();
}
function loadState(){
  const raw = localStorage.getItem(LS.state);
  if(!raw) return structuredClone(DEFAULT_STATE);
  const parsed = safeJsonParse(raw, null);
  if(!parsed) return structuredClone(DEFAULT_STATE);
  const s = structuredClone(DEFAULT_STATE);
  deepMerge(s, parsed);
  return s;
}
function formatDateFR(d){
  try{ return new Intl.DateTimeFormat('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(d); }
  catch(e){ return d.toLocaleDateString('fr-FR'); }
}
function formatDateTimeFR(ts){
  const d = new Date(ts);
  try{
    return new Intl.DateTimeFormat('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
  }catch(e){ return d.toLocaleString('fr-FR'); }
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function toast(t, s){
  const el = $("#toast");
  $("#toastT").textContent = t || "Info";
  $("#toastS").textContent = s || "";
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.classList.remove("show"), 3200);
}
function download(filename, text, type="application/json"){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function copyToClipboard(text){
  if(!text) return toast("Copie", "Rien √† copier.");
  navigator.clipboard?.writeText(text).then(
    ()=> toast("Copi√©", "Copi√©."),
    ()=> toast("Copie", "Impossible de copier.")
  );
}

/* ---------- Auth + Audit ---------- */
function isManager(){ return state.currentUser?.role === "manager"; }
  let pendingAfterLogin = null;

function requireAuth(afterLoginCb = null){
  if(state.currentUser){
    return true;
  }

  // pas connect√© ‚Üí on m√©morise l'action √† faire apr√®s login
  if(typeof afterLoginCb === "function"){
    pendingAfterLogin = afterLoginCb;
  }

  openAuthModal(true);
  toast("Connexion requise", "S√©lectionne ton nom et entre ton PIN.");
  return false;
}

function audit(action, detail){
  const who = state.currentUser?.name || "INCONNU";
  state.audit.push({ who, role: state.currentUser?.role || "none", action, detail: detail||"", ts: Date.now() });
  if(state.audit.length > 2000) state.audit.shift();
  saveState();
}

/* ---------- Navigation ---------- */
function go(view){
  const requestedView = view;
  if(view === "followup"){
    state.notesTab = "followups";
    view = "notes";
  }
  if(!requireAuth()) return;
  if(view === "manager" && !isManager()){
    toast("Acc√®s refus√©", "R√©serv√© aux responsables.");
    audit("DENY_MANAGER_VIEW", "");
    return;
  }
  state.view = view;
  $all(".view").forEach(v => v.style.display = "none");
  $("#view-"+view).style.display = "block";
  $all(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.view === view || (requestedView === "followup" && b.dataset.view === "followup")));

  if(view === "client") renderClient();
  if(view === "sav"){
  renderSav();
  renderSavHistory();
  // Optionnel : si tu constates parfois un affichage vide au 1er rendu, garde √ßa :
  // setTimeout(renderSavHistory, 0);
}

  if(view === "notes") renderNotes();
  if(view === "accu") renderAccu();
  if(view === "manager") { renderRulesEditor(); renderUsers(); renderAudit(); }

  audit("NAVIGATE", requestedView);
  saveState();
}
function bindNav(){
  $("#nav").addEventListener("click", (e)=>{
    const btn = e.target.closest(".navbtn");
    if(!btn) return;
    if(btn.dataset.view === "notes") state.notesTab = "notes";
    if(btn.dataset.view === "followup") state.notesTab = "followups";
    go(btn.dataset.view);
  });
}

/* ---------- Auth Modal ---------- */
function openAuthModal(force=false){
  const hasUsers = Array.isArray(state.users) && state.users.length > 0;

  $("#firstSetup").style.display = hasUsers ? "none" : "block";
  $("#authNormal").style.display = hasUsers ? "block" : "none";

  if(hasUsers){
    const sel = $("#authUserSelect");
    sel.innerHTML = state.users
      .slice().sort((a,b)=> a.name.localeCompare(b.name,'fr'))
      .map(u=>`<option value="${u.id}">${escapeHtml(u.name)} (${u.role==="manager"?"responsable":"vendeur"})</option>`)
      .join("");
    $("#authPin").value = "";
    setTimeout(()=> $("#authPin").focus(), 50);
  } else {
    $("#firstManagerName").value = "";
    $("#firstManagerPin").value = "";
    setTimeout(()=> $("#firstManagerName").focus(), 50);
  }

  $("#authModal").classList.add("show");
}

function closeAuthModal(){
  if(!state.currentUser){
    toast("Connexion", "Connexion obligatoire.");
    return;
  }
  $("#authModal").classList.remove("show");
}
function refreshAuthUI(){
  const dot = $("#authDot");
  const label = $("#authLabel");
  if(state.currentUser){
    dot.classList.add("ok");
    label.textContent = state.currentUser.name;
    $("#logoutBtn").style.display = "inline-flex";
    $("#managerNav").style.display = isManager() ? "flex" : "none";
    $("#goManagerBtn").style.display = isManager() ? "inline-flex" : "none";
    $("#toggleMaskBtn").style.display = isManager() ? "inline-flex" : "none";
  } else {
    dot.classList.remove("ok");
    label.textContent = "Non connect√©";
    $("#logoutBtn").style.display = "none";
    $("#managerNav").style.display = "none";
    $("#goManagerBtn").style.display = "none";
    $("#toggleMaskBtn").style.display = "none";
  }
  const expFollow = $("#exportFollowupsBtn");
  const clrFollow = $("#clearFollowupsBtn");
  [expFollow, clrFollow].forEach(btn=>{
    if(!btn) return;
    const can = !!state.currentUser && isManager();
    btn.disabled = !can;
    btn.title = can ? "" : "Responsable uniquement";
  });
  refreshSidebarMini();
  updateAdminButtonsLock();
}
function login(){
  const userId = ($("#authUserSelect").value || "").trim();
  const pin = ($("#authPin").value || "").trim();
  const user = (state.users || []).find(u => u.id === userId);

  if(!user){
    toast("Erreur", "Utilisateur introuvable.");
    audit("LOGIN_FAIL", "user_not_found");
    return;
  }

  if(!pin || pin !== user.pin){
    toast("PIN incorrect", "R√©essaie.");
    audit("LOGIN_FAIL", { userId, pin_len: pin.length });
    return;
  }

  state.currentUser = { id:user.id, name:user.name, role:user.role };
  $("#authModal").classList.remove("show");
  $("#authPin").value = "";

  toast("Connect√©", user.name);
  audit("LOGIN_OK", user.name);

  refreshAuthUI();
  saveState();

  // ‚úÖ rejouer l‚Äôaction demand√©e avant login
const fn = pendingAfterLogin;
pendingAfterLogin = null;

if (typeof fn === "function") {
  setTimeout(fn, 0);
}


}



function logout(){
  if(state.currentUser) audit("LOGOUT", state.currentUser.name);
  state.currentUser = null;
  saveState();
  refreshAuthUI();
  openAuthModal(true);
}
  function createFirstManager(){
  const name = ($("#firstManagerName").value || "").trim();
  const pin  = ($("#firstManagerPin").value || "").trim();

  if(!name){ toast("Cr√©ation", "Nom requis."); return; }
  if(!pin || pin.length < 4){ toast("Cr√©ation", "PIN 4 chiffres mini."); return; }

  const id = slugifyName(name);
  if(state.users.some(u=>u.id === id)){
    toast("Cr√©ation", "Un utilisateur avec cet identifiant existe d√©j√†.");
    return;
  }

  state.users.push({ id, name, pin, role: "manager" });
  state.currentUser = { id, name, role: "manager" };

  audit("FIRST_MANAGER_CREATED", id);
  saveState();

  $("#authModal").classList.remove("show");
  refreshAuthUI();
  toast("OK", "Responsable cr√©√©. Tu es connect√©.");
}


/* ---------- BLOCK Export/Import/Reset for sellers ---------- */
function updateAdminButtonsLock(){
  const exp = $("#exportStateBtn");
  const imp = $("#importStateBtn");
  const res = $("#resetBtn");

  const can = !!state.currentUser && isManager();
  exp.disabled = !can;
  imp.disabled = !can;
  res.disabled = !can;

  exp.title = can ? "" : "R√©serv√© responsable";
  imp.title = can ? "" : "R√©serv√© responsable";
  res.title = can ? "" : "R√©serv√© responsable";
}

function exportFullState(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "Export r√©serv√© aux responsables.");
    audit("DENY_EXPORT_STATE", "");
    return;
  }
  const payload = { exportedAt: new Date().toISOString(), state };
  download(`stoom-export-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
  audit("EXPORT_STATE", "");
}
function openImportModal(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "Import r√©serv√© aux responsables.");
    audit("DENY_IMPORT", "");
    return;
  }
  $("#importText").value = "";
  $("#importModal").classList.add("show");
}
function closeImportModal(){ $("#importModal").classList.remove("show"); }
function importState(){
  if(!isManager()){ toast("Acc√®s refus√©", "R√©serv√© aux responsables."); return; }
  const payload = safeJsonParse($("#importText").value||"", null);
  if(!payload?.state){ toast("Import", "JSON invalide."); return; }
  const fresh = structuredClone(DEFAULT_STATE);
  deepMerge(fresh, payload.state);
  fresh.currentUser = null;

  for(const k of Object.keys(state)) delete state[k];
  Object.assign(state, fresh);

  saveState();
  closeImportModal();
  toast("Import OK", "Donn√©es import√©es. Reconnexion requise.");
  openAuthModal(true);
}
function clearAll(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "R√©initialisation r√©serv√©e aux responsables.");
    audit("DENY_RESET", "");
    return;
  }
  if(!confirm("R√©initialiser TOUT sur cet appareil ?")) return;
  localStorage.removeItem(LS.state);
  location.reload();
}

/* ---------- Search ---------- */
function runSearch(q){
  const query = (q||"").toLowerCase().trim();
  if(!query){ toast("Recherche", "Tape un mot-cl√©."); return; }
  const hitSav = ["fuite","glouglou","br√ªl√©","brule","toux","gorge","panne","charge"].some(k=> query.includes(k));
  const hitClient = ["nicotine","sel","mtl","rdl","dl","0mg","dosage","tirage","puissance"].some(k=> query.includes(k));
  const hitManager = ["audit","r√®gle","regle","users","utilisateur","pin","export"].some(k=> query.includes(k));

  if(hitSav){ go("sav"); toast("Recherche", "SAV ouvert."); return; }
  if(hitClient){ go("client"); toast("Recherche", "Parcours client ouvert."); return; }
  if(hitManager){ isManager() ? go("manager") : toast("Recherche", "Admin r√©serv√© responsable."); return; }
  toast("Recherche", "Aucun raccourci. Essaye: fuite, br√ªl√©, sel, MTL, audit‚Ä¶");
}

/* ---------- Client Wizard ---------- */
const clientSteps = [
  { key:"cigs", label:"Conso", desc:"cig/j" },
  { key:"cigType", label:"Cigarette", desc:"type" },
  { key:"moments", label:"Moment", desc:"d√©clencheur" },
  { key:"goal", label:"Objectif", desc:"intention" },
  { key:"tried", label:"Exp√©rience", desc:"d√©j√† essay√©" },
];

const clientQuestions = [
  { key:"cigs", title:"Combien de cigarettes par jour ?", subtitle:"On choisit d‚Äôabord un taux coh√©rent (stabilit√©).", cols:"cols4",
    choices:[
      {v:"5-10", t:"5‚Äì10 /j", s:"Souvent 3 ou 6 mg"},
      {v:"10-15", t:"10‚Äì15 /j", s:"Souvent 6 ou 12 mg"},
      {v:"15-20", t:"15‚Äì20 /j", s:"Souvent 10 mg sel"},
      {v:"25+", t:"25+ /j", s:"Souvent 20 mg sel"},
    ]},
  { key:"cigType", title:"Type de cigarette ?", subtitle:"√áa aide √† choisir sensations & saveurs.", cols:"cols3",
    choices:[
      {v:"blonde", t:"Blonde", s:"Classique / light"},
      {v:"menthol", t:"Menthol", s:"Fra√Æcheur douce"},
      {v:"roulee", t:"Roul√©e", s:"Plus aromatique / puissant"},
    ]},
  { key:"moments", title:"Moment difficile principal ?", subtitle:"On s√©curise ce moment en priorit√©.", cols:"cols3",
    choices:[
      {v:"stress", t:"Stress", s:"Pression"},
      {v:"cafe", t:"Caf√©", s:"Habitude ancr√©e"},
      {v:"soir", t:"Soir", s:"D√©tente"},
      {v:"journee", t:"Journ√©e", s:"Usage fr√©quent"},
      {v:"apresRepas", t:"Apr√®s repas", s:"Rituel"},
      {v:"matin", t:"Matin", s:"Demarrage"},
    ]},
  { key:"goal", title:"Objectif du client ?", subtitle:"L‚Äôobjectif n¬∞1 = √©viter la rechute.", cols:"cols3",
    choices:[
      {v:"arreter", t:"Arr√™ter", s:"Objectif clair"},
      {v:"reduire", t:"R√©duire", s:"√âtape"},
      {v:"remplacer", t:"Remplacer", s:"Sans pression"},
    ]},
  { key:"tried", title:"D√©j√† essay√© la vape ?", subtitle:"On corrige ce qui a bloqu√©.", cols:"cols3",
    choices:[
      {v:"non", t:"Non", s:"D√©couverte"},
      {v:"echec", t:"Oui (√©chec)", s:"On s√©curise"},
      {v:"ok", t:"Oui (√ßa marchait)", s:"On r√©plique"},
    ]},
];

function clientReset(){
  if(!requireAuth()) return;
  state.client.step = 0;
  state.client.answers = { cigs:null, cigType:null, moments:null, goal:null, tried:null };
  state.client.sheet = null;
  audit("CLIENT_RESET", "");
  saveState();
  renderClient();
}

function setAnswer(key, value){
  state.client.answers[key] = value;
  audit("CLIENT_ANSWER", `${key}=${value}`);
  saveState();
  setTimeout(()=> nextClient(), 60);
}
function prevClient(){
  state.client.step = Math.max(0, state.client.step - 1);
  audit("CLIENT_PREV", String(state.client.step));
  saveState();
  renderClient();
}
function nextClient(){
  const q = clientQuestions[state.client.step];
  if(!state.client.answers[q.key]){
    toast("R√©ponse manquante", "Choisis une option.");
    return;
  }
  if(state.client.step < clientQuestions.length-1){
    state.client.step += 1;
    audit("CLIENT_NEXT", String(state.client.step));
    saveState();
    renderClient();
  } else {
    state.client.sheet = buildSheet(state.client.answers);
    audit("SHEET_GENERATED", JSON.stringify(state.client.answers));
    saveState();
    renderSheet();
  }
}

function renderClientSteps(){
  const el = $("#clientSteps");
  el.innerHTML = "";
  clientSteps.forEach((s, i)=>{
    const div = document.createElement("div");
    div.className = "step";
    if(i === state.client.step) div.classList.add("active");
    if(state.client.answers[s.key]) div.classList.add("done");
    div.innerHTML = `<span>${i+1}. ${escapeHtml(s.label)}</span><span class="small mono">${escapeHtml(s.desc)}</span>`;
    div.onclick = ()=> { state.client.step = i; audit("CLIENT_GOTO_STEP", String(i)); saveState(); renderClient(); };
    el.appendChild(div);
  });
}
function renderClientQuestion(){
  const box = $("#clientQuestionBox");
  const q = clientQuestions[state.client.step];
  const current = state.client.answers[q.key];
  box.innerHTML = `
    <h3>${escapeHtml(q.title)}</h3>
    <p class="muted">${escapeHtml(q.subtitle)}</p>
    <div class="choices ${q.cols||""}" id="qChoices"></div>
  `;
  const ch = $("#qChoices");
  q.choices.forEach((c)=>{
    const d = document.createElement("div");
    d.className = "choice" + (current === c.v ? " selected":"");
    d.innerHTML = `<div class="ct">${escapeHtml(c.t)}</div><div class="cs">${escapeHtml(c.s||"")}</div>`;
    d.onclick = ()=> setAnswer(q.key, c.v);
    ch.appendChild(d);
  });
}
function renderClient(){
  renderClientSteps();
  renderClientQuestion();
  $("#clientPrev").onclick = prevClient;
  $("#clientNext").onclick = nextClient;
  $("#clientPrev").disabled = state.client.step === 0;
  renderSheet();
}

function calcFlavorHint(a){
  if(a.cigType === "blonde") return "Classiques (blond) ou l√©g√®rement gourmands";
  if(a.cigType === "menthol") return "Menthol doux / frais";
  if(a.cigType === "roulee") return "Classiques plus aromatiques (puissants)";
  return "Saveurs au choix";
}
function calcMomentTip(a){
  const m = a.moments;
  if(m === "stress") return "Stress : Mieux vaut vaper tranquillement quelques bouf√©es que tirer fort et creer de la frustration.";
  if(m === "cafe") return "Caf√© : Astuce, Prendre 2-3 bouf√©es de vape bien dos√©es avant la premi√®re gorg√©e de caf√©, avec un caf√© l√©germent modifi√© (allong√© ou avec du lait) pour casser le r√©flexe caf√© clope";
  if(m === "soir") return "Soir : garder une vape plud douce (moins de nicotine), essayer d'associer la vape √† un autre rituel (tisane, eau fraiche etc...) vaper dans un contexte calme.";
  if(m === "journee") return "Journ√©e : autonomie + fiabilit√© + simplicit√©, ne pas se retenir de vaper : Mieux vaut trop vaper que de rechuter sur une cigarette !";
  if(m === "apresRepas") return "Apr√®s repas : cigarette electronique toujours pr√™te, simple, toujours dispo.";
  if(m === "matin") return "Matin : Privilegier un taux de nicotine + fort le matin, .";
  return "S√©curiser les moments cl√©s avec le bon dosage de nicotine.";
}
function calcReassurance(a){
  if(a.tried === "echec") return "Si √ßa a d√©j√† √©chou√©, il s'agit souvent d'un mauvais couple taux/mat√©riel. ‚ö†Ô∏èAttention de ne pas reproduire la m√™me erreur.";
  if(a.tried === "ok") return "Si √ßa marchait, on r√©plique ce qui √©tait confortable et stable pour le client.";
  return "On ajuste si besoin, sans se pr√©cipiter.";
}
function buildSheet(a){
  const rule = state.rules.byCigs[a.cigs] || { nicotine:"‚Äî", tirage:"MTL", power:"‚Äî", hardware:"‚Äî" };

  const nicotine = rule.nicotine;
  const tirage = rule.tirage;
  const power = rule.power;
  const hardware = rule.hardware;

  const flavor = calcFlavorHint(a);
  const reassurance = calcReassurance(a);
  const momentTip = calcMomentTip(a);

 const addons = [
  "R√©sistance / cartouche de secours",
  "Affiner le r√©glage de la puissance avec le client pour trouver sa vape id√©ale",
  "Proposer syst√©matiquement un chargeur adapt√©",
  "Rappel : baisser la nicotine quand c‚Äôest stable",
  "Rappel : ‚ö†Ô∏è Au debut la sensation en gorge peut etre ressentie forte, cela est normal et passera en quelques jours ‚ö†Ô∏è",
];

  const goalLine =
    a.goal === "arreter" ? "viser d‚Äôabord z√©ro cigarette" :
    a.goal === "reduire" ? "s√©curiser le quotidien puis r√©duire doucement" :
    "remplacer sans pression (confort)";

 const salesLine = `‚ÄúJe vous propose ${tirage} avec ${nicotine}. L‚Äôobjectif, c‚Äôest de ${goalLine}. Pour l'instant il s'agit d'une phase de test, je vous propose de prendre un rendez-vous telephonique dans une semaine afin de verifier que tout se passe bien, ce service est gratuit.‚Äù`;

  return {
    title: "Recommandation STOOM (profil client)",
    tirage, nicotine, power, hardware,
    explain: [
  reassurance,
  momentTip,
  `Suggestion saveurs : ${flavor}.`
].join("\n\n"),

    addons,
    salesLine
  };
}

function renderSheet(){
  const box = $("#sheetBox");
  if(!state.client.sheet){
    box.innerHTML = `<h3>En attente‚Ä¶</h3><p class="muted">R√©ponds aux questions pour g√©n√©rer la fiche.</p>`;
    $("#salesLine").textContent = "‚Äî";
    refreshSidebarMini();
    refreshHomeLastSheet();
    return;
  }

  const sh = state.client.sheet;
  const explainHtml = escapeHtml(sh.explain).replace(/\n/g, "<br>");

  box.innerHTML = `
    <h3>${escapeHtml(sh.title)}</h3>
    <div class="chips" style="margin:8px 0 10px">
      <span class="chip"><b>Tirage</b> ${escapeHtml(sh.tirage)}</span>
      <span class="chip"><b>Nicotine</b> ${escapeHtml(sh.nicotine)}</span>
      <span class="chip"><b>Puissance</b> ${escapeHtml(sh.power)}</span>
      <span class="chip"><b>Mat√©riel</b> ${escapeHtml(sh.hardware)}</span>
    </div>

    <div class="hr"></div>

    <p class="muted">${explainHtml}</p>

    <div class="hr"></div>

    <div class="chips">
      ${sh.addons.map(a=>`<span class="chip"><b>+</b> ${escapeHtml(a)}</span>`).join("")}
    </div>
  `;

  $("#salesLine").textContent = sh.salesLine;
  refreshSidebarMini();
  refreshHomeLastSheet();
}

function copySalesLine(){
  const line = $("#salesLine").textContent;
  if(!line || line === "‚Äî") return toast("Copie", "Aucune phrase.");
  copyToClipboard(line);
  audit("COPY_SALESLINE", "");
}

function printSheet(){
  if(!requireAuth()) return;
  if(!state.client.sheet){ toast("Impression", "Aucune fiche."); return; }

  audit("PRINT_SHEET", "");
  const sh = state.client.sheet;
  const a = state.client.answers;

  const html =
`<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fiche STOOM</title>
<style>
  body{font-family: Arial, sans-serif; padding:24px; color:#0b1220}
  h1{margin:0 0 6px; font-size:18px}
  .sub{color:#334155; margin:0 0 16px; font-size:12px}
  .card{border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin:12px 0}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:12px}
  .muted{color:#475569; font-size:12px; line-height:1.45}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .hr{height:1px; background:#e2e8f0; margin:12px 0}
</style></head><body>
<h1>${escapeHtml(state.settings.shopName)} ‚Ä¢ Fiche recommandation</h1>
<p class="sub">G√©n√©r√© le ${escapeHtml(formatDateFR(new Date()))}</p>

<div class="card">
  <div class="chips">
    <span class="chip"><b>Tirage</b> ${escapeHtml(sh.tirage)}</span>
    <span class="chip"><b>Nicotine</b> ${escapeHtml(sh.nicotine)}</span>
    <span class="chip"><b>Puissance</b> ${escapeHtml(sh.power)}</span>
    <span class="chip"><b>Mat√©riel</b> ${escapeHtml(sh.hardware)}</span>
  </div>
  <div class="hr"></div>
  <p class="muted">${escapeHtml(sh.explain).replace(/\n/g,"<br>")}</p>

</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">Profil (r√©sum√©)</h2>
  <p class="muted mono" style="margin:0">
    Conso: ${escapeHtml(a.cigs||"‚Äî")} ‚Ä¢ Type: ${escapeHtml(a.cigType||"‚Äî")} ‚Ä¢ Moment: ${escapeHtml(a.moments||"‚Äî")} ‚Ä¢ Objectif: ${escapeHtml(a.goal||"‚Äî")} ‚Ä¢ D√©j√† essay√©: ${escapeHtml(a.tried||"‚Äî")}
  </p>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">Phrase pr√™te √† dire</h2>
  <p class="muted mono" style="margin:0">${escapeHtml(sh.salesLine)}</p>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">√Ä proposer (anti-panne)</h2>
  <ul class="muted" style="margin:0; padding-left:18px">
    ${sh.addons.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
  </ul>
</div>

</body></html>`;

  const w = window.open("", "_blank");
  if(!w){ toast("Impression", "Pop-up bloqu√©e."); return; }
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

/* ---------- SAV ---------- */
const savMap = [
  {
    id:"fuite",
    t:"Fuite",
    s:"liquide / glouglou",
    causes:[
      "R√©sistance en fin de vie ou mal amorc√©e",
      "Airflow trop ouvert + aspiration trop forte",
      "Liquide trop fluide / chaleur (adapter le PG/VG, Preconiser des boosters plus epais)",
      "Joint ou cartouche us√©"
    ],
    actions:[
      "Changer r√©sistance + amorcer (5‚Äì10 min)",
      "R√©duire airflow / aspiration",
      "Nettoyer et v√©rifier joints",
      "Tester autre cartouche"
    ],
    tip:"Toujours 1 changement √† la fois.",
    autoRefuse:false
  },

  {
    id:"goutBrule",
    t:"Go√ªt br√ªl√©",
    s:"dry hit",
    causes:[
      "R√©sistance cram√©e ou en fin de vie",
      "Puissance trop √©lev√©e",
      "Cha√Æne de bouff√©es"
    ],
    actions:[
      "Changer r√©sistance",
      "Baisser la puissance",
      "Espacer les bouff√©es"
    ],
    tip:"R√©sistance br√ªl√©e = non garantie.",
    autoRefuse:true
  },

  {
    id:"chipset",
    t:"Chipset HS",
    s:"ne r√©pond plus / bug",
    causes:[
      "Court-circuit",
      "Surtension",
      "D√©faut √©lectronique"
    ],
    actions:[
      "Red√©marrage 5 Pression",
      "Verifier que la box n'a pas un bouton lock / OFF",
      "En cas d'odeur de brul√© : NE PAS INSISTER ET SECURISER LE MATERIEL !"
    ],
    tip:"Garantie possible si aucun signe de liquide.",
    autoRefuse:false
  },

  {
    id:"bouton",
    t:"Bouton HS",
    s:"ne clique plus / reste bloqu√©",
    causes:[
      "Usure m√©canique",
      "Liquide infiltr√©"
    ],
    actions:[
      "Inspection bouton",
      "Test fonctionnel"
    ],
    tip:"Liquide visible = refus garantie.",
    autoRefuse:false
  },

  {
    id:"ecran",
    t:"√âcran HS",
    s:"noir / fig√©",
    causes:[
      "Choc",
      "D√©faut √©lectronique",
      "Humidit√©"
    ],
    actions:[
      "V√©rification chocs",
      "Diagnostic visuel"
    ],
    tip:"Trace de choc = refus.",
    autoRefuse:false
  },

  {
    id:"autofire",
    t:"Autofire",
    s:"d√©clenche seul sans tirer sur le mat√©riel",
    causes:[
      "Liquide dans le chipset",
      "Capteur aspiration noy√©"
    ],
    actions:[
      "Aucune r√©paration possible, enlever imm√©diatement la cartouche / r√©sistance du mat√©riel"
    ],
    tip:"AUTOFIRE = refus automatique.",
    autoRefuse:true
  },

  {
    id:"liquideAspire",
    t:"Liquide aspir√©",
    s:"Remont√©e de liquide dans la bouche",
    causes:[
      "Aspiration trop forte",
      "Condensation excessive"
    ],
    actions:[
      "Si l'aspiration est trop forte, faire un test de tirage et ajuster le mat√©riel"
    ],
    tip:"Liquide aspir√© = exclusion de garantie.",
    autoRefuse:true
  }
];


function clearSavProblem(){
  $("#savVendorProblem").value = "";
  state.sav.vendorProblem = "";
  audit("SAV_CLEAR_PROBLEM", "");
  saveState();
}
function renderSav(){
  const box = $("#savChoices");
  box.innerHTML = "";
  savMap.forEach(it=>{
    const d = document.createElement("div");
    d.className = "choice" + (state.sav.symptom === it.id ? " selected":"");
    d.innerHTML = `<div class="ct">${escapeHtml(it.t)}</div><div class="cs">${escapeHtml(it.s)}</div>`;
  d.onclick = ()=> {
  state.sav.symptom = it.id;
    const btn = $("#createSavBtn");
if(btn) btn.disabled = false;

  audit("SAV_SYMPTOM", it.id);

  // ‚úÖ met √† jour le bouton s√©lectionn√© visuellement
  $all("#savChoices .choice").forEach(x => x.classList.remove("selected"));
  d.classList.add("selected");

  saveState();
  renderSavResult();

  $("#savSymptomLabel").textContent = (savMap.find(x=>x.id===it.id)?.t || it.id);
};
    box.appendChild(d);
  });
  $("#savVendorProblem").value = state.sav.vendorProblem || "";
  renderSavResult();

  const btn = $("#createSavBtn");
if(btn) btn.disabled = !state.sav.symptom;

}
function renderSavResult(){
  const r = $("#savResult");
  const it = savMap.find(x=>x.id===state.sav.symptom);
  if(!it){
    r.innerHTML = `<h3>En attente‚Ä¶</h3><p class="muted">S√©lectionne un sympt√¥me.</p>`;
    return;
  }

  r.innerHTML = `
    <h3>‚úÖ ${escapeHtml(it.t)}</h3>
    <p class="muted">${escapeHtml(it.tip)}</p>

    <div class="hr"></div>

    <div class="two">
      <div>
        <h3>Causes probables</h3>
        <ul class="muted" style="margin:10px 0 0; padding-left:18px">
          ${it.causes.map(c=>`<li>${escapeHtml(c)}</li>`).join("")}
        </ul>
      </div>
      <div>
        <h3>Actions recommand√©es</h3>
        <ul class="muted" style="margin:10px 0 0; padding-left:18px">
          ${it.actions.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}
        </ul>
      </div>
    </div>
  `;
}



function openSavForm(){
  if(!state.sav.symptom){
    toast("SAV", "Choisis d‚Äôabord un sympt√¥me.");
    return;
  }

  state.sav.vendorProblem = ($("#savVendorProblem").value || "").trim();
  saveState();

  // reset champs
  $("#savClientName").value = "";
  $("#savPurchaseDate").value = "";
  $("#savProductRef").value = "";
  $("#savProductColor").value = "";
  $("#savScratchCode").value = "";

  $("#savGoodState").value = "yes";
  $("#savPortOk").value = "yes";
  $("#savBoxPresent").value = "yes";
  $("#savCablePresent").value = "yes";

  $("#savProblemText").value = state.sav.vendorProblem || "";
  $("#savSymptomLabel").textContent = (savMap.find(x=>x.id===state.sav.symptom)?.t || state.sav.symptom);
  $("#savDecisionBox").textContent = "‚Äî";

  const m = $("#savModal");
  if(!m){
    toast("ERREUR", "Impossible de trouver #savModal");
    return;
  }

  // ‚úÖ ouverture propre (CSS g√®re tout)
  m.style.display = "";            // ‚úÖ important si un ancien "display:none" a √©t√© pos√©
m.classList.add("show");
  m.removeAttribute("aria-hidden");

  // ‚úÖ Android: remonte en haut (optionnel)
  m.scrollTop = 0;
  }

function closeSavModal(){
  const m = $("#savModal");
  m.classList.remove("show");
  m.style.display = "";          // ‚úÖ on enl√®ve l‚Äôoverride inline
  m.setAttribute("aria-hidden","true");
        }
    
function computeSavDecision(data){
  const reasons = [];

  if(!data.clientName) reasons.push("Nom / pr√©nom client manquant");
  if(!data.purchaseDate) reasons.push("Date d‚Äôachat manquante");
  if(!data.productRef) reasons.push("R√©f√©rence produit manquante");
  if(!data.productColor) reasons.push("Couleur du produit manquante");

  if(data.goodState !== "yes") reasons.push("Produit non en bon √©tat");
  if(data.portOk !== "yes") reasons.push("Port de charge non intact");
  if(data.boxPresent !== "yes") reasons.push("Bo√Æte absente");
  if(data.cablePresent !== "yes") reasons.push("C√¢ble de charge absent");

  const symptom = savMap.find(s => s.id === data.symptom);
  if(symptom?.autoRefuse){
    reasons.push("Sympt√¥me exclu de garantie (liquide / autofire / R√©sistance non garantie)");
  }

  return { ok: reasons.length === 0, reasons };
}

function validateSavAndPrint(){
  if(!requireAuth(validateSavAndPrint)) return;

  const data = {
    clientName: ($("#savClientName").value||"").trim(),
    purchaseDate: $("#savPurchaseDate").value,
    productRef: ($("#savProductRef").value||"").trim(),
    productColor: ($("#savProductColor").value||"").trim(),
    scratchCode: ($("#savScratchCode").value||"").trim(),
    goodState: $("#savGoodState").value,
    portOk: $("#savPortOk").value,
    boxPresent: $("#savBoxPresent").value,
    cablePresent: $("#savCablePresent").value,
    problem: ($("#savProblemText").value||"").trim(),
    symptom: state.sav.symptom
  };

  const dec = computeSavDecision(data);
  const nowTs = Date.now();

  const symptomLabel = (savMap.find(x=>x.id===data.symptom)?.t || data.symptom);
  const vendor = state.currentUser?.name || "INCONNU";
  const when = formatDateTimeFR(nowTs);

  const savSheet = {
    ...data,
    symptomLabel,
    vendor,
    when,
    decision: dec.ok ? "SAV RECEVABLE" : "PRISE EN GARANTIE IMPOSSIBLE",
    reasons: dec.reasons
  };

  state.sav.lastSavSheet = savSheet;

  // ‚úÖ Historique : ON GARDE TOUT (recevable + non recevable)
  state.sav.history = state.sav.history || [];
  state.sav.history.push(savSheet);
  if(state.sav.history.length > 800) state.sav.history.shift();

  audit("SAV_DECISION", `${savSheet.decision} | ${symptomLabel}`);
  saveState();

  if(dec.ok){
    printSavSheet(savSheet);
    closeSavModal();
    renderSavHistory();
  } else {
    $("#savDecisionBox").innerHTML =
      `<span class="dangerText"><b>PRISE EN GARANTIE IMPOSSIBLE</b></span> ‚ùå<br/>
       Raisons : ${dec.reasons.map(r=>escapeHtml(r)).join(" ‚Ä¢ ")}`;
    renderSavHistory();
  }
}


function previewSavEligibility(){
  const data = {
    clientName: ($("#savClientName").value||"").trim(),
    purchaseDate: $("#savPurchaseDate").value,
    productRef: ($("#savProductRef").value||"").trim(),
    productColor: ($("#savProductColor").value||"").trim(),
    scratchCode: ($("#savScratchCode").value||"").trim(),
    goodState: $("#savGoodState").value,
    portOk: $("#savPortOk").value,
    boxPresent: $("#savBoxPresent").value,
    cablePresent: $("#savCablePresent").value,
    problem: ($("#savProblemText").value||"").trim(),
    symptom: state.sav.symptom
  };

  const dec = computeSavDecision(data);

  if(dec.ok){
    $("#savDecisionBox").innerHTML =
      `<span class="goodText"><b>SAV RECEVABLE</b></span> ‚Äì fiche imprimable autoris√©e ‚úÖ`;
  } else {
    $("#savDecisionBox").innerHTML =
      `<span class="dangerText"><b>PRISE EN GARANTIE IMPOSSIBLE</b></span> ‚ùå<br/>
       Raisons : ${dec.reasons.map(r=>escapeHtml(r)).join(" ‚Ä¢ ")}`;
  }
}
  
function printSavSheet(s){
  audit("PRINT_SAV_SHEET", s.decision);

  const yesNo = v => (v==="yes" ? "Oui" : "Non");
  const reasonsHtml = (s.reasons||[]).length
    ? `<ul>${s.reasons.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}</ul>`
    : `<p>Aucune.</p>`;

  const badgeColor = (s.decision === "SAV RECEVABLE") ? "#16a34a" : "#dc2626";

  const html =
`<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fiche SAV STOOM</title>
<style>
  body{font-family: Arial, sans-serif; padding:24px; color:#0b1220}
  h1{margin:0 0 6px; font-size:18px}
  .sub{color:#334155; margin:0 0 16px; font-size:12px}
  .card{border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin:12px 0}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1; min-width:220px}
  .k{color:#334155; font-size:12px; margin:0}
  .v{font-size:13px; margin:6px 0 0}
  .badge{display:inline-block; padding:8px 12px; border-radius:999px; color:white; font-weight:700; font-size:12px; background:${badgeColor}}
  .muted{color:#475569; font-size:12px; line-height:1.45}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
  .hr{height:1px; background:#e2e8f0; margin:12px 0}
  ul{margin:8px 0 0; padding-left:18px}
</style></head><body>

<h1>${escapeHtml(state.settings.shopName)} ‚Ä¢ FICHE SAV</h1>
<p class="sub">Pris en charge par <b>${escapeHtml(s.vendor)}</b> ‚Ä¢ ${escapeHtml(s.when)}</p>

<div class="card">
  <span class="badge">${escapeHtml(s.decision)}</span>
  <div class="hr"></div>
  <div class="row">
    <div class="col">
      <p class="k">Client</p>
      <p class="v"><b>${escapeHtml(s.clientName || "‚Äî")}</b></p>
    </div>
    <div class="col">
      <p class="k">Date d‚Äôachat</p>
      <p class="v">${escapeHtml(s.purchaseDate || "‚Äî")}</p>
    </div>
  </div>

  <div class="card">
  <b>Produit :</b><br>
  <b>R√©f√©rence :</b> ${escapeHtml(s.productRef || "‚Äî")}<br>
  <b>Couleur :</b> ${escapeHtml(s.productColor || "‚Äî")}<br>
  <b>Scratch code :</b> ${escapeHtml(s.scratchCode || "Non communiqu√©")}
</div>


  <div class="hr"></div>
  <div class="row">
    <div class="col"><p class="k">Sympt√¥me</p><p class="v">${escapeHtml(s.symptomLabel)}</p></div>
    <div class="col"><p class="k">Probl√®me constat√©</p><p class="v">${escapeHtml(s.problem || "‚Äî")}</p></div>
  </div>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">V√©rifications garantie</h2>
  <div class="row">
    <div class="col"><p class="k">Bon √©tat (pas de chute)</p><p class="v">${escapeHtml(yesNo(s.goodState))}</p></div>
    <div class="col"><p class="k">Port de charge intact</p><p class="v">${escapeHtml(yesNo(s.portOk))}</p></div>
  </div>
  <div class="row" style="margin-top:10px">
    <div class="col"><p class="k">Bo√Æte pr√©sente</p><p class="v">${escapeHtml(yesNo(s.boxPresent))}</p></div>
    <div class="col"><p class="k">C√¢ble de charge pr√©sent</p><p class="v">${escapeHtml(yesNo(s.cablePresent))}</p></div>
  </div>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">Raisons / Justification</h2>
  <p class="muted">Si un √©l√©ment requis est manquant ou non conforme : <b>prise en garantie impossible</b>.</p>
  ${reasonsHtml}
  <div class="hr"></div>
  <p class="muted mono">Signature vendeur : _____________________</p>
  <p class="muted mono">Signature client : ______________________</p>
</div>

</body></html>`;

  const w = window.open("", "_blank");
  if(!w){ toast("Impression", "Pop-up bloqu√©e."); return; }
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

function reprintLastSav(){
  if(!requireAuth()) return;
  if(!state.sav.lastSavSheet){
    toast("SAV", "Aucune fiche SAV r√©cente.");
    return;
  }
  printSavSheet(state.sav.lastSavSheet);
}
function renderSavHistory(){
  const box = $("#savHistoryList");
  if(!box) return;

  const q = ($("#savHistoryFilter")?.value || "").toLowerCase().trim();
  const history = (state.sav.history || []);
  const histRev = history.slice().reverse();
  const total = history.length;

  const filtered = histRev.filter(s=>{
    if(!q) return true;
    const hay = [
      s.when, s.vendor, s.decision, s.symptomLabel,
      s.clientName, s.purchaseDate,
      s.productRef, s.productColor, s.scratchCode,
      s.problem,
      ...(s.reasons || [])
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  if(filtered.length === 0){
    box.innerHTML = `<p class="muted">Aucun SAV dans l‚Äôhistorique.</p>`;
    return;
  }

  box.innerHTML = filtered.map((s, idx)=>{
    const decisionClass = (s.decision === "SAV RECEVABLE") ? "goodText" : "dangerText";
    const reasons = (s.reasons && s.reasons.length) ? s.reasons.join(" ‚Ä¢ ") : "‚Äî";
    const productLine = `${s.productRef || "‚Äî"} ‚Ä¢ ${s.productColor || "‚Äî"}${s.scratchCode ? " ‚Ä¢ " + s.scratchCode : ""}`;

    // index r√©el dans state.sav.history (filtered vient d‚Äôun reverse)
    const originalIndex = total - 1 - idx;

    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(s.symptomLabel || "SAV")}</strong>
          <span>${escapeHtml(s.when || "")}</span>
        </div>

        <p class="small">
          <b class="${decisionClass}">${escapeHtml(s.decision || "")}</b>
          ‚Ä¢ ${escapeHtml(s.vendor || "‚Äî")}
        </p>

        <p class="muted">
          <b>Produit :</b> ${escapeHtml(productLine)}<br/>
          <b>Client :</b> ${escapeHtml(s.clientName || "‚Äî")} ‚Ä¢ <b>Achat :</b> ${escapeHtml(s.purchaseDate || "‚Äî")}<br/>
          <b>Probl√®me :</b> ${escapeHtml(s.problem || "‚Äî")}<br/>
          <b>Raisons :</b> ${escapeHtml(reasons)}
        </p>

        <div class="btnrow" style="margin-top:10px">
          <button class="btn" onclick="printSavSheet(state.sav.history[${originalIndex}])">R√©-imprimer</button>
          ${
            isManager()
              ? `<button class="btn danger" onclick="deleteSavHistoryItem(${originalIndex})">Supprimer</button>`
              : `<span class="small">Suppression : responsable</span>`
          }
        </div>
      </div>
    `;
  }).join("");
}


function deleteSavHistoryItem(index){
  if(!isManager()){
    toast("Acc√®s refus√©", "Suppression r√©serv√©e responsable.");
    audit("DENY_SAV_HISTORY_DELETE", String(index));
    return;
  }
  if(!Array.isArray(state.sav.history)) state.sav.history = [];
  if(index < 0 || index >= state.sav.history.length) return;
  state.sav.history.splice(index, 1);
  audit("SAV_HISTORY_DELETE", String(index));
  saveState();
  renderSavHistory();
}

function clearSavHistory(){
  if(!isManager()){
    toast("Acc√®s refus√©", "Vider l‚Äôhistorique = responsable.");
    audit("DENY_SAV_HISTORY_CLEAR", "");
    return;
  }
  if(!confirm("Vider tout l‚Äôhistorique SAV sur cette tablette ?")) return;
  state.sav.history = [];
  audit("SAV_HISTORY_CLEARED", "");
  saveState();
  renderSavHistory();
}

function exportSavHistoryCSV(){
  if(!isManager()){
    toast("Acc√®s refus√©", "Export historique = responsable.");
    audit("DENY_SAV_HISTORY_EXPORT", "");
    return;
  }

  const hist = state.sav.history || [];
  const esc = (v)=> `"${String(v ?? "").replace(/"/g,'""')}"`;

  const header = [
    "when","vendor","decision","symptomLabel",
    "clientName","purchaseDate",
    "productRef","productColor","scratchCode",
    "problem","reasons"
  ];

  const lines = [header.join(",")];

  for(const s of hist){
    lines.push([
      esc(s.when),
      esc(s.vendor),
      esc(s.decision),
      esc(s.symptomLabel),
      esc(s.clientName),
      esc(s.purchaseDate),
      esc(s.productRef),
      esc(s.productColor),
      esc(s.scratchCode),
      esc(s.problem),
      esc((s.reasons || []).join(" ‚Ä¢ "))
    ].join(","));
  }

  download(`stoom-sav-historique-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
  audit("SAV_HISTORY_EXPORT_CSV", "");
}


/* ---------- Notes ---------- */
function maskPhone(p){
  if(!p) return "";
  const s = String(p).replace(/\s+/g,"");
  if(s.length <= 4) return "‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
  return "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + s.slice(-2);
}
function toggleMaskPhones(){
  if(!isManager()){ toast("Acc√®s", "R√©serv√© responsable."); return; }
  state.settings.maskPhones = !state.settings.maskPhones;
  audit("TOGGLE_MASK_PHONES", String(state.settings.maskPhones));
  saveState();
  renderNotes();
}
function saveNote(){
  if(!requireAuth()) return;
  const name = ($("#noteName").value||"").trim();
  const phone = ($("#notePhone").value||"").trim();
  const text = ($("#noteText").value||"").trim();
  if(!name && !phone && !text){ toast("Note", "Rien √† enregistrer."); return; }

  const id = (crypto?.randomUUID?.() || String(Date.now()) + Math.random().toString(16).slice(2));
  state.notes.push({ id, name, phone, text, createdAt: Date.now(), createdBy: state.currentUser?.name || "INCONNU" });
  audit("NOTE_ADD", `${name} ${phone}`.trim());
  saveState();
  clearNoteForm();
  renderNotes();
  toast("OK", "Note enregistr√©e.");
}
function clearNoteForm(){
  $("#noteName").value = "";
  $("#notePhone").value = "";
  $("#noteText").value = "";
}
function deleteNote(id){
  if(!isManager()){
    toast("Acc√®s refus√©", "Suppression r√©serv√©e responsable.");
    audit("DENY_NOTE_DELETE", id);
    return;
  }
  state.notes = state.notes.filter(n=>n.id!==id);
  audit("NOTE_DELETE", id);
  saveState();
  renderNotes();
}
function renderNotesList(){
  const list = $("#notesList");
  if(!list) return;
  const filter = ($("#noteFilter").value||"").toLowerCase().trim();
  const items = [...state.notes].sort((a,b)=> b.createdAt - a.createdAt).filter(n=>{
    if(!filter) return true;
    return (n.name||"").toLowerCase().includes(filter)
      || (n.phone||"").toLowerCase().includes(filter)
      || (n.text||"").toLowerCase().includes(filter)
      || (n.createdBy||"").toLowerCase().includes(filter);
  });

  if(items.length === 0){
    list.innerHTML = `<p class="muted">Aucune note.</p>`;
    return;
  }

  list.innerHTML = items.map(n=>{
    const d = formatDateTimeFR(n.createdAt);
    const phoneShown = state.settings.maskPhones ? maskPhone(n.phone) : (n.phone||"");
    return `
      <div class="item">
        <div class="top">
          <div>
            <strong>${escapeHtml(n.name||"Sans nom")}</strong>
            <div class="small">Par ${escapeHtml(n.createdBy||"‚Äî")} ‚Ä¢ ${escapeHtml(d)}</div>
          </div>
          <div><span>${escapeHtml(phoneShown)}</span></div>
        </div>
        <p>${escapeHtml(n.text||"")}</p>
        <div class="btnrow" style="margin-top:10px">
      ${isManager() ? `<button class="btn danger" onclick="deleteNote('${n.id}')">Supprimer</button>` : `<span class="small">Suppression : responsable uniquement</span>`}
        </div>
      </div>
    `;
  }).join("");
}
function setNotesTab(tab){
  state.notesTab = tab || "notes";
  renderNotes();
  saveState();
}
function renderNotes(){
  const tab = state.notesTab || "notes";
  $("#notesTab-notes")?.style.setProperty("display", tab === "notes" ? "block" : "none");
  $("#notesTab-followups")?.style.setProperty("display", tab === "followups" ? "block" : "none");
  $all("#notesTabSwitch .tabBtn").forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tab));
  if(tab === "notes") renderNotesList();
  if(tab === "followups") renderFollowups();
}

/* ---------- Suivi client / Rappels ---------- */
let followupEditingId = null;
function openFollowupsTab(){
  state.notesTab = "followups";
  renderNotes();
  go("notes");
}
function todayStr(){ return new Date().toISOString().slice(0,10); }
function ensureFollowups(){
  if(!Array.isArray(state.followups)) state.followups = [];
  state.followups = state.followups.map(f=>{
    const id = f.id || crypto?.randomUUID?.() || String(Date.now()) + Math.random().toString(16).slice(2);
    const baseStatus = f.status === "done" ? "done" : "wait";
    return {
      id,
      name: f.name || "",
      phone: f.phone || "",
      dueDate: f.dueDate || f.nextDate || "",
      dueTime: f.dueTime || f.nextTime || "",
      summary: f.summary ?? f.notes ?? "",
      status: baseStatus,
      createdAt: f.createdAt || Date.now(),
      createdBy: f.createdBy || state.currentUser?.name || "INCONNU",
      lastCallAt: f.lastCallAt || null,
      lastCallBy: f.lastCallBy || null,
      lastResult: f.lastResult || "",
      history: Array.isArray(f.history) ? f.history : []
    };
  });
}
function getFollowupStatus(f){
  if(f.status === "done") return "done";
  if(f.dueDate && f.dueDate < todayStr()) return "over";
  return "wait";
}
function followupStatusLabel(f){
  const s = getFollowupStatus(f);
  if(s === "done") return "üü¢ Rappel fait";
  if(s === "over") return "üî¥ En retard";
  return f.dueDate === todayStr() ? "üü° √Ä faire aujourd‚Äôhui" : "üü° En attente";
}
function formatDue(f){
  if(!f.dueDate) return "‚Äî";
  return f.dueTime ? `${f.dueDate} ${f.dueTime}` : f.dueDate;
}
function clearFollowupForm(){
  $("#followName").value = "";
  $("#followPhone").value = "";
  $("#followDueDate").value = "";
  $("#followDueTime").value = "";
  $("#followSummary").value = "";
  followupEditingId = null;
  const btn = $("#followSaveBtn");
  if(btn) btn.textContent = "Cr√©er le rappel";
}
function saveFollowup(){
  if(!requireAuth()) return;
  ensureFollowups();

  const name = ($("#followName").value||"").trim();
  const phone = ($("#followPhone").value||"").trim();
  const dueDate = $("#followDueDate").value;
  const dueTime = $("#followDueTime").value;
  const summary = ($("#followSummary").value||"").trim();
  if(!name){ toast("Suivi", "Nom obligatoire."); return; }
  if(!dueDate){ toast("Suivi", "Date de rappel obligatoire."); return; }

  const base = { name, phone, dueDate, dueTime, summary };

  if(followupEditingId){
    const idx = state.followups.findIndex(f=>f.id===followupEditingId);
    if(idx !== -1){
      const prev = state.followups[idx];
      state.followups[idx] = {
        ...prev,
        ...base,
        updatedAt: Date.now(),
        updatedBy: state.currentUser?.name || "INCONNU"
      };
      audit("FOLLOWUP_EDIT", `${name} (${followupEditingId})`);
    }
  } else {
    const id = crypto?.randomUUID?.() || String(Date.now()) + Math.random().toString(16).slice(2);
    state.followups.push({
      id,
      ...base,
      status: "wait",
      createdAt: Date.now(),
      createdBy: state.currentUser?.name || "INCONNU",
      lastCallAt: null,
      lastCallBy: null,
      lastResult: "",
      history: []
    });
    audit("FOLLOWUP_ADD", name);
  }

  saveState();
  renderFollowups();
  clearFollowupForm();
  toast("OK", "Rappel enregistr√©.");
}
function openFollowup(id){
  const f = (state.followups||[]).find(x=>x.id===id);
  if(!f) return;
  $("#followName").value = f.name || "";
  $("#followPhone").value = f.phone || "";
  $("#followDueDate").value = f.dueDate || "";
  $("#followDueTime").value = f.dueTime || "";
  $("#followSummary").value = f.summary || "";
  followupEditingId = id;
  const btn = $("#followSaveBtn");
  if(btn) btn.textContent = "Mettre √† jour";
  toast("Mode √©dition", "Modifie puis enregistre.");
}
function markFollowupDone(id){
  if(!requireAuth()) return;
  ensureFollowups();
  const f = state.followups.find(x=>x.id===id);
  if(!f) return;
  const note = prompt("Compte-rendu de l‚Äôappel ?", f.lastResult || "");
  if(note === null) return;
  const now = Date.now();
  const by = state.currentUser?.name || "INCONNU";
  f.status = "done";
  f.lastCallAt = now;
  f.lastCallBy = by;
  f.lastResult = (note||"").trim();
  f.history.push({ at: now, by, action:"done", note: f.lastResult });
  audit("FOLLOWUP_DONE", `${f.name} (${id})`);
  saveState();
  renderFollowups();
}
function reprogramFollowup(id){
  if(!requireAuth()) return;
  ensureFollowups();
  const f = state.followups.find(x=>x.id===id);
  if(!f) return;
  const newDate = prompt("Nouvelle date (YYYY-MM-DD)", f.dueDate || todayStr());
  if(newDate === null) return;
  if(!newDate.match(/^\d{4}-\d{2}-\d{2}$/)){ toast("Date", "Format attendu : YYYY-MM-DD."); return; }
  const newTime = prompt("Heure (HH:MM, optionnel)", f.dueTime || "");
  if(newTime === null) return;
  if(newTime && !newTime.match(/^\d{2}:\d{2}$/)){ toast("Heure", "Format attendu : HH:MM."); return; }
  f.dueDate = newDate;
  f.dueTime = newTime || "";
  f.status = "wait";
  const now = Date.now();
  const by = state.currentUser?.name || "INCONNU";
  f.history.push({ at: now, by, action:"reschedule", note:`Reprogramm√© au ${newDate}${newTime ? " "+newTime : ""}` });
  audit("FOLLOWUP_RESCHEDULE", `${f.name} -> ${newDate} ${newTime||""}`);
  saveState();
  renderFollowups();
}
function deleteFollowup(id){
  if(!isManager()){
    toast("Acc√®s refus√©", "Suppression r√©serv√©e responsable.");
    audit("DENY_FOLLOWUP_DELETE", id);
    return;
  }
  ensureFollowups();
  const f = state.followups.find(x=>x.id===id);
  if(!f) return;
  if(!confirm(`Supprimer le suivi de ${f.name || "ce client"} ?`)) return;
  state.followups = state.followups.filter(x=>x.id!==id);
  audit("FOLLOWUP_DELETE", `${f.name} (${id})`);
  saveState();
  renderFollowups();
}
function clearFollowups(){
  if(!isManager()){
    toast("Acc√®s refus√©", "Vider = responsable.");
    audit("DENY_FOLLOWUP_CLEAR", "");
    return;
  }
  if(!confirm("Supprimer tous les rappels sur cette tablette ?")) return;
  state.followups = [];
  audit("FOLLOWUP_CLEAR_ALL", "");
  saveState();
  renderFollowups();
}
function exportFollowupsCSV(){
  if(!isManager()){
    toast("Acc√®s refus√©", "Export = responsable.");
    audit("DENY_FOLLOWUP_EXPORT", "");
    return;
  }
  ensureFollowups();
  const esc = (v)=> `"${String(v ?? "").replace(/"/g,'""')}"`;
  const lines = [["id","nom","phone","dueDate","dueTime","status","createdAt","createdBy","lastCallAt","lastCallBy","lastResult","summary"].join(",")];
  state.followups.forEach(f=>{
    lines.push([
      esc(f.id),
      esc(f.name),
      esc(f.phone),
      esc(f.dueDate),
      esc(f.dueTime),
      esc(getFollowupStatus(f)),
      esc(f.createdAt ? formatDateTimeFR(f.createdAt) : ""),
      esc(f.createdBy),
      esc(f.lastCallAt ? formatDateTimeFR(f.lastCallAt) : ""),
      esc(f.lastCallBy || ""),
      esc(f.lastResult || ""),
      esc(f.summary || "")
    ].join(","));
  });
  download(`stoom-suivis-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
  audit("FOLLOWUP_EXPORT_CSV", "");
}
function renderFollowups(){
  ensureFollowups();
  const list = $("#followList");
  if(!list) return;
  const filter = ($("#followupFilter")?.value || "").toLowerCase().trim();

  const rows = state.followups.slice().sort((a,b)=>{
    const aDate = a.dueDate || "";
    const bDate = b.dueDate || "";
    if(aDate && bDate && aDate !== bDate) return aDate.localeCompare(bDate);
    return (b.createdAt||0) - (a.createdAt||0);
  }).filter(f=>{
    if(!filter) return true;
    const hay = [
      f.name, f.phone, f.summary, f.lastResult, f.createdBy, f.lastCallBy,
      f.dueDate, f.dueTime, followupStatusLabel(f)
    ].join(" ").toLowerCase();
    return hay.includes(filter);
  });

  if(rows.length === 0){
    list.innerHTML = `<p class="muted">Aucun rappel enregistr√©.</p>`;
    return;
  }

  list.innerHTML = rows.map(f=>{
    const status = getFollowupStatus(f);
    const statusLabel = followupStatusLabel(f);
    const phoneShown = state.settings.maskPhones ? maskPhone(f.phone) : (f.phone || "");
    const lastLine = f.lastCallAt
      ? `Dernier appel : ${formatDateTimeFR(f.lastCallAt)} ‚Ä¢ ${f.lastResult || "‚Äî"} (${f.lastCallBy || "‚Äî"})`
      : "Dernier appel : ‚Äî";
    return `
      <div class="item">
        <div class="top">
          <div>
            <strong>${escapeHtml(f.name || "Sans nom")}</strong>
            <div class="small">${escapeHtml(formatDue(f))}</div>
            <div class="small">${statusLabel ? `<span class="statusPill ${status}">${escapeHtml(statusLabel)}</span>` : ""}</div>
          </div>
          <div><span>${escapeHtml(phoneShown)}</span></div>
        </div>
        <p class="muted">${escapeHtml(f.summary || "‚Äî")}</p>
        <p class="small">${escapeHtml(lastLine)}</p>
        <div class="btnrow" style="margin-top:10px">
          <button class="btn" onclick="openFollowup('${f.id}')">Ouvrir</button>
          <button class="btn" onclick="reprogramFollowup('${f.id}')">Reprogrammer</button>
          ${status !== "done" ? `<button class="btn primary" onclick="markFollowupDone('${f.id}')">Rappel fait</button>` : `<span class="small goodText">‚úÖ Fait</span>`}
          ${isManager() ? `<button class="btn danger" onclick="deleteFollowup('${f.id}')">Supprimer</button>` : `<span class="small">Suppression : responsable</span>`}
        </div>
      </div>
    `;
  }).join("");

  const btn = $("#followSaveBtn");
  if(btn && followupEditingId) btn.textContent = "Mettre √† jour";
}
function updateFollowUpAlerts(showToast=false){
  ensureFollowups();
  const today = todayStr();
  let overdue = 0;
  let dueToday = 0;
  let waitCount = 0;

  state.followups.forEach(f=>{
    const status = getFollowupStatus(f);
    if(status === "done") return;
    if(status === "over") overdue += 1;
    if(status === "wait") waitCount += 1;
    if(status === "wait" && f.dueDate === today) dueToday += 1;
  });

  const banner = $("#homeFollowupBanner");
  if(banner){
    if(overdue > 0 || dueToday > 0){
      banner.style.display = "flex";
      const txt = overdue > 0
        ? `üî¥ ${overdue} rappel(s) en retard${dueToday ? " + üü° " + dueToday + " √† faire aujourd‚Äôhui" : ""}`
        : `üìû ${dueToday} rappel(s) √† faire aujourd‚Äôhui`;
      const txtEl = $("#homeFollowupText");
      if(txtEl) txtEl.textContent = txt;
    } else {
      banner.style.display = "none";
    }
  }

  const mini = $("#followupMini");
  if(mini){
    const pending = overdue + waitCount;
    mini.textContent = pending ? `${pending} (üî¥${overdue} / üü°${waitCount})` : "0";
  }

  if(showToast && (overdue || dueToday)){
    const t = overdue ? "Rappels en retard" : "Rappels du jour";
    const s = overdue
      ? `${overdue} en retard${dueToday ? ` ‚Ä¢ ${dueToday} aujourd‚Äôhui` : ""}`
      : `${dueToday} √† faire aujourd‚Äôhui`;
    toast(t, s);
  }
}

/* ---------- Calculators ---------- */
function fillExample(){
  $("#cigsPerDay").value = 20;
  $("#days").value = 30;
  $("#mlPerDayAt20").value = 4;
  $("#price10ml").value = 5.9;
  audit("CALC_FILL_EXAMPLE", "");
  toast("Exemple", "Valeurs remplies.");
}
function calcBottles(){
  const cigs = Number($("#cigsPerDay").value||0);
  const days = Number($("#days").value||0);
  const mlAt20 = Number($("#mlPerDayAt20").value||4);
  const price = Number($("#price10ml").value||0);
  if(days <= 0){ toast("Erreur", "Dur√©e invalide."); return; }

  const mlPerDay = (cigs/20) * mlAt20;
  const totalMl = mlPerDay * days;
  const bottles = totalMl / 10;
  const bottlesCeil = Math.max(0, Math.ceil(bottles));
  const bottlesRound = Math.max(0, Math.round(bottles*10)/10);
  let cost = null;
  if(price>0) cost = bottlesCeil * price;

  const offerText = (bottlesCeil >= 15) ? "Astuce : 15+2 offert (si applicable)." :
                    (bottlesCeil >= 10) ? "Astuce : 10+1 offert (si applicable)." :
                    "Astuce : pr√©voir 1 flacon de s√©curit√©.";

  $("#bottleResult").innerHTML = `
    <h3>R√©sultat (estimation)</h3>
    <div class="chips" style="margin:8px 0 10px">
      <span class="chip"><b>ml/j</b> ${mlPerDay.toFixed(1)}</span>
      <span class="chip"><b>Total</b> ${totalMl.toFixed(0)} ml</span>
      <span class="chip"><b>Flacons</b> ~${bottlesRound}</span>
      <span class="chip"><b>√Ä pr√©voir</b> ${bottlesCeil}</span>
    </div>
    <p class="muted">${offerText}</p>
    ${cost !== null ? `<p class="muted"><b>Budget :</b> ~${cost.toFixed(2)} ‚Ç¨</p>` : ``}
  `;
  audit("CALC_BOTTLES", `cigs=${cigs},days=${days},mlAt20=${mlAt20}`);
}
function calcSavings(){
  const packPrice = Number($("#packPrice").value||0);
  const packsPerDay = Number($("#packsPerDay").value||0);
  const vapeMonthly = Number($("#vapeMonthly").value||0);
  const months = Number($("#months").value||0);
  if(months <= 0){ toast("Erreur", "Dur√©e invalide."); return; }
  const tobaccoMonthly = packPrice * packsPerDay * 30;
  const tobaccoTotal = tobaccoMonthly * months;
  const vapeTotal = vapeMonthly * months;
  const save = tobaccoTotal - vapeTotal;

  $("#savingsResult").innerHTML = `
    <h3>R√©sultat</h3>
    <div class="chips" style="margin:8px 0 10px">
      <span class="chip"><b>Tabac/mois</b> ${tobaccoMonthly.toFixed(2)} ‚Ç¨</span>
      <span class="chip"><b>Tabac</b> ${tobaccoTotal.toFixed(2)} ‚Ç¨</span>
      <span class="chip"><b>Vape</b> ${vapeTotal.toFixed(2)} ‚Ç¨</span>
      <span class="chip"><b>√âconomie</b> ${save.toFixed(2)} ‚Ç¨</span>
    </div>
  `;
  audit("CALC_SAVINGS", `pack=${packPrice},ppd=${packsPerDay},vape=${vapeMonthly},months=${months}`);
}
/* ---------- Accus & S√©curit√© ---------- */
function renderAccu(){
  // remet l'UI d'apr√®s l'√©tat
  $("#accuWatts").value = state.accu?.watts ?? 30;
  $("#accuCells").value = String(state.accu?.cells ?? 1);

  // Si tu veux afficher direct une suggestion au chargement :
  $("#accuResult").innerHTML = `
    <h3>R√©sultat</h3>
    <div class="small">Renseigne puis ‚ÄúCalculer‚Äù.</div>
  `;
}

function calcAccu(){
  if(!requireAuth()) return;

  const watts = Math.max(1, Number($("#accuWatts").value || 0));
  const cells = Math.max(1, Number($("#accuCells").value || 1));

  // param√®tres de s√©curit√©
  const vMin   = Number(state.accu?.vMin ?? 3.2);     // tension mini par accu (sag)
  const eff    = Number(state.accu?.eff ?? 0.90);     // rendement
  const margin = Number(state.accu?.margin ?? 1.25);  // marge de s√©curit√©

  // courant approximatif (par accu)
  // I ‚âà (W / (cells * Vmin * eff)) * marge
  const iPerCell = (watts / (cells * vMin * eff)) * margin;

  // Catalogue et compatibilit√© (CDR >= courant calcul√©)
  const catalog = (state.accu?.catalog || []).slice().sort((a,b)=> b.cdr - a.cdr);
  const ok = catalog.filter(a => Number(a.cdr) >= iPerCell);

  // Sauvegarde √©tat
  state.accu.watts = watts;
  state.accu.cells = cells;
  audit("ACCU_CALC", `W=${watts} cells=${cells} I‚âà${iPerCell.toFixed(1)}A`);
  saveState();

  const chips = `
    <div class="chips" style="margin:8px 0 10px">
      <span class="chip"><b>Puissance</b> ${watts} W</span>
      <span class="chip"><b>Box</b> ${cells} accu(s)</span>
      <span class="chip"><b>Hypoth√®ses</b> Vmin=${vMin} ‚Ä¢ eff=${Math.round(eff*100)}% ‚Ä¢ marge=${margin}</span>
      <span class="chip"><b>Courant/accu</b> ~${iPerCell.toFixed(1)} A</span>
    </div>
  `;

  const listOk = ok.length
    ? `<div class="hr"></div>
       <h3>Accus compatibles (CDR ‚â• ${iPerCell.toFixed(1)}A)</h3>
       <div class="list">
         ${ok.map(a=>`
           <div class="item">
             <div class="top">
               <strong>${escapeHtml(a.name)}</strong>
               <span>CDR ${a.cdr}A ‚Ä¢ ${a.mah}mAh</span>
             </div>
             <p class="muted">${escapeHtml(a.notes || "")}</p>
           </div>
         `).join("")}
       </div>`
    : `<div class="hr"></div>
       <p class="dangerText"><b>‚ö†Ô∏è Aucun accu du catalogue ne couvre ce r√©glage avec marge.</b></p>
       <p class="muted small">Solutions : baisser la puissance, passer sur une box double accus, ou utiliser des accus avec CDR plus √©lev√©.</p>`;

  const safety = `
    <div class="hr"></div>
    <p class="small">
      ‚ö†Ô∏è Calcul ‚Äúvendeur‚Äù (approx) : d√©pend du mat√©riel, de l‚Äô√©tat des accus, de la r√©sistance, du sag, etc.
      Objectif = rester confortable et <b>loin des limites</b>.
    </p>
  `;

  $("#accuResult").innerHTML = `<h3>R√©sultat</h3>${chips}${listOk}${safety}`;
}

function resetAccuCalc(){
  if(!requireAuth()) return;
  $("#accuWatts").value = 30;
  $("#accuCells").value = "1";
  state.accu.watts = 30;
  state.accu.cells = 1;
  audit("ACCU_RESET", "");
  saveState();

  $("#accuResult").innerHTML = `
    <h3>R√©sultat</h3>
    <div class="small">Renseigne puis ‚ÄúCalculer‚Äù.</div>
  `;
}

/* ---------- Manager: Rules editor ---------- */
function refreshRulesSummary(){
  const r = state.rules?.byCigs || {};
  const parts = [];
  for(const k of ["5-10","10-15","15-20","25+"]){
    const x = r[k];
    if(!x) continue;
    parts.push(`${k}: ${x.nicotine} ‚Ä¢ ${x.tirage} ‚Ä¢ ${x.power}`);
  }
  $("#rulesSummary").textContent = parts.length ? parts.join(" | ") : "‚Äî";
}
function renderRulesEditor(){
  if(!isManager()) return;
  const wrap = $("#rulesEditor");
  const r = state.rules.byCigs;

  const row = (key, label) => {
    const x = r[key];
    return `
      <div class="item">
        <div class="top">
          <strong>${label}</strong>
          <span>${key}</span>
        </div>
        <div class="hr"></div>
        <div class="two">
          <div><label>Nicotine</label><input data-rule="${key}" data-field="nicotine" type="text" value="${escapeHtml(x.nicotine||"")}" /></div>
          <div><label>Tirage</label><input data-rule="${key}" data-field="tirage" type="text" value="${escapeHtml(x.tirage||"")}" /></div>
        </div>
        <div class="two" style="margin-top:10px">
          <div><label>Puissance</label><input data-rule="${key}" data-field="power" type="text" value="${escapeHtml(x.power||"")}" /></div>
          <div><label>Mat√©riel</label><input data-rule="${key}" data-field="hardware" type="text" value="${escapeHtml(x.hardware||"")}" /></div>
        </div>
      </div>
    `;
  };

  wrap.innerHTML = [
    row("5-10", "Profil 5‚Äì10 cig/j"),
    row("10-15","Profil 10‚Äì15 cig/j"),
    row("15-20","Profil 15‚Äì20 cig/j"),
    row("25+","Profil 25+ cig/j"),
  ].join("");
}
function saveRulesFromUI(){
  if(!isManager()) return;
  const inputs = $all("#rulesEditor input[data-rule]");
  inputs.forEach(inp=>{
    const key = inp.getAttribute("data-rule");
    const field = inp.getAttribute("data-field");
    if(!state.rules.byCigs[key]) state.rules.byCigs[key] = {};
    state.rules.byCigs[key][field] = (inp.value||"").trim();
  });
  audit("RULES_SAVE", "");
  saveState();
  toast("R√®gles", "Enregistr√©es.");
}
function resetRules(){
  if(!isManager()) return;
  if(!confirm("R√©initialiser les r√®gles par d√©faut ?")) return;
  state.rules = structuredClone(DEFAULT_STATE.rules);
  audit("RULES_RESET", "");
  saveState();
  renderRulesEditor();
  toast("R√®gles", "R√©initialis√©es.");
}

/* ---------- Manager: Users ---------- */
function slugifyName(name){
  return (name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") || ("u"+Math.random().toString(16).slice(2,7));
}
function renderUsers(){
  if(!isManager()) return;
  const wrap = $("#usersList");
  const users = state.users.slice().sort((a,b)=> a.name.localeCompare(b.name,'fr'));
  wrap.innerHTML = users.map(u=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(u.name)}</strong>
          <span>${escapeHtml(u.role)}</span>
        </div>
        <p class="small mono">id=${escapeHtml(u.id)} ‚Ä¢ PIN=‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
        <div class="btnrow">
          <button class="btn" onclick="openEditUser('${u.id}')">Modifier</button>
         <button class="btn danger" onclick="removeUser('${u.id}')">Supprimer</button>
        </div>
      </div>
    `;
  }).join("");

  $("#newUserName").addEventListener("input", ()=>{
    $("#newUserId").value = slugifyName($("#newUserName").value);
  }, { once:false });
}
function addUser(){
  if(!isManager()) return;
  const name = ($("#newUserName").value||"").trim();
  const pin = ($("#newUserPin").value||"").trim();
  const role = $("#newUserRole").value;
  const id = slugifyName(name);

  if(!name){ toast("User", "Nom requis."); return; }
  if(!pin || pin.length < 4){ toast("User", "PIN 4 chiffres mini."); return; }
  if(state.users.some(u=>u.id===id)){ toast("User", "ID existe d√©j√†."); return; }

  state.users.push({ id, name, pin, role });
  audit("USER_ADD", `${id}:${role}`);
  saveState();
  $("#newUserName").value = "";
  $("#newUserPin").value = "";
  $("#newUserId").value = "";
  renderUsers();
  toast("OK", "Utilisateur ajout√©.");
}
function removeUser(id){
  if(!isManager()) return;
  if(!confirm("Supprimer cet utilisateur ?")) return;
  state.users = state.users.filter(u=>u.id!==id);
  audit("USER_REMOVE", id);
  saveState();
  renderUsers();
}
function openEditUser(id){
  const u = state.users.find(x=>x.id===id);
  if(!u) return;

  const name = prompt("Nom", u.name);
  if(name === null) return;
  const role = prompt("R√¥le (seller/manager)", u.role);
  if(role === null) return;
  const pin = prompt("Nouveau PIN (laisser vide pour ne pas changer)", "");
  if(pin === null) return;

  u.name = name.trim() || u.name;
  u.role = (role.trim()==="manager") ? "manager" : "seller";
  if(pin.trim()){
    if(pin.trim().length < 4){ toast("PIN", "4 chiffres mini."); return; }
    u.pin = pin.trim();
  }

  if(state.currentUser?.id === u.id){
    state.currentUser.name = u.name;
    state.currentUser.role = u.role;
  }
  audit("USER_EDIT", `${u.id}:${u.role}`);
  saveState();
  renderUsers();
  refreshAuthUI();
}

/* ---------- Audit peek + full (manager only) ---------- */
function renderAuditPeek(){
  const box = $("#auditPeek");
  const last = state.audit.slice(-5).reverse();
  if(last.length === 0){
    box.innerHTML = `<div class="small">Aucune action enregistr√©e.</div>`;
    return;
  }
  box.innerHTML = last.map(e=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(e.who)} ‚Ä¢ ${escapeHtml(e.action)}</strong>
          <span>${escapeHtml(formatDateTimeFR(e.ts))}</span>
        </div>
        <p>${escapeHtml(e.detail||"")}</p>
      </div>
    `;
  }).join("");
}
function renderAudit(){
  if(!isManager()) return;
  const filter = ($("#auditFilter").value||"").toLowerCase().trim();
  const limit = Number($("#auditLimit").value||200);

  let rows = state.audit.slice().reverse();
  if(filter){
    rows = rows.filter(e =>
      (e.who||"").toLowerCase().includes(filter) ||
      (e.action||"").toLowerCase().includes(filter) ||
      (e.detail||"").toLowerCase().includes(filter)
    );
  }
  rows = rows.slice(0, limit);

  const box = $("#auditList");
  if(rows.length === 0){
    box.innerHTML = `<div class="small">Aucune ligne.</div>`;
    return;
  }
  box.innerHTML = rows.map(e=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(e.who)} <span class="small">(${escapeHtml(e.role)})</span> ‚Ä¢ ${escapeHtml(e.action)}</strong>
          <span>${escapeHtml(formatDateTimeFR(e.ts))}</span>
        </div>
        <p>${escapeHtml(e.detail||"")}</p>
      </div>
    `;
  }).join("");
}
function exportAuditJSON(){
  if(!isManager()) return;
  const payload = { exportedAt: new Date().toISOString(), audit: state.audit };
  download(`stoom-audit-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
  audit("AUDIT_EXPORT_JSON", "");
}
function exportAuditCSV(){
  if(!isManager()) return;
  const header = ["timestamp","date","who","role","action","detail"];
  const lines = [header.join(",")];
  for(const e of state.audit){
    const row = [
      e.ts,
      `"${formatDateTimeFR(e.ts).replace(/"/g,'""')}"`,
      `"${String(e.who||"").replace(/"/g,'""')}"`,
      `"${String(e.role||"").replace(/"/g,'""')}"`,
      `"${String(e.action||"").replace(/"/g,'""')}"`,
      `"${String(e.detail||"").replace(/"/g,'""')}"`,
    ];
    lines.push(row.join(","));
  }
  download(`stoom-audit-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
  audit("AUDIT_EXPORT_CSV", "");
}
function clearAudit(){
  if(!isManager()) return;
  if(!confirm("Vider le journal d‚Äôaudit ?")) return;
  state.audit = [];
  audit("AUDIT_CLEARED", "");
  saveState();
  renderAudit();
}

/* ---------- Sidebar mini + home last sheet ---------- */
function refreshSidebarMini(){
  $("#today").textContent = formatDateFR(new Date());
  $("#userMini").textContent = state.currentUser?.name || "‚Äî";
  $("#roleMini").textContent = state.currentUser ? (isManager() ? "Responsable" : "Vendeur") : "‚Äî";
  $("#sheetMini").textContent = state.client.sheet ? "OK" : "‚Äî";
}
function refreshHomeLastSheet(){
  const box = $("#lastSheetBox");
  if(!state.client.sheet){
    box.innerHTML = `<h3>‚Äî</h3><p class="muted">Aucune fiche pour le moment.</p><div class="btnrow"><button class="btn" onclick="go('client')">Cr√©er une fiche</button></div>`;
    return;
  }
  const sh = state.client.sheet;
  box.innerHTML = `
    <h3>${escapeHtml(sh.title)}</h3>
    <p class="muted">${escapeHtml(sh.tirage)} ‚Ä¢ ${escapeHtml(sh.nicotine)} ‚Ä¢ ${escapeHtml(sh.hardware)}</p>
    <div class="btnrow">
      <button class="btn primary" onclick="go('client')">Voir</button>
      <button class="btn" onclick="printSheet()">Imprimer</button>
    </div>
  `;
}

/* ---------- Keyboard shortcuts ---------- */
function bindKeys(){
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      $("#authModal").classList.remove("show");
      $("#importModal").classList.remove("show");
      $("#savModal").classList.remove("show");
      return;
    }
    if(e.key === "/" && !e.metaKey && !e.ctrlKey){
      e.preventDefault();
      $("#searchInput").focus();
      return;
    }
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    const typing = ["input","textarea","select"].includes(tag);
    if(typing) return;

    const k = e.key.toLowerCase();
    if(k==="h") go("home");
    if(k==="c") go("client");
    if(k==="s") go("sav");
    if(k==="k") go("calc");
    if(k==="b") go("accu");
    if(k==="n"){ state.notesTab = "notes"; go("notes"); }
    if(k==="r"){ state.notesTab = "followups"; go("notes"); }
    if(k==="a") isManager() ? go("manager") : null;

    if((e.ctrlKey || e.metaKey) && k==="p"){
      e.preventDefault();
      printSheet();
    }
  });
}

/* ---------- Bind buttons ---------- */
function bindButtons(){

  $("#authBtn").addEventListener("click", () => openAuthModal(false));
  $("#logoutBtn").addEventListener("click", logout);

  $("#quickNew").addEventListener("click", ()=>{
    if(!requireAuth()) return;
    clientReset();
    go("client");
  });

  $("#searchInput").addEventListener("keydown",(e)=>{
    if(e.key === "Enter") runSearch(e.target.value);
  });

  $("#noteFilter").addEventListener("input", renderNotes);
  $("#followupFilter").addEventListener("input", renderFollowups);

  $("#printBtn").addEventListener("click", printSheet);

  $("#exportStateBtn").addEventListener("click", exportFullState);
  $("#importStateBtn").addEventListener("click", openImportModal);
  $("#resetBtn").addEventListener("click", clearAll);

  $("#savVendorProblem").addEventListener("input", ()=>{
    state.sav.vendorProblem = ($("#savVendorProblem").value||"").trim();
    saveState();
  });

  $("#authModal").addEventListener("click",(e)=>{
    if(e.target.id==="authModal") closeAuthModal();
  });

  $("#importModal").addEventListener("click",(e)=>{
    if(e.target.id==="importModal") closeImportModal();
  });

  $("#savModal").addEventListener("click",(e)=>{
    if(e.target.id==="savModal") closeSavModal();
  });

  
  }





/* ---------- Init ---------- */
function startApp(){
  refreshSidebarMini();
  refreshAuthUI();
  refreshRulesSummary();
  ensureFollowups();
  clearFollowupForm();
  renderNotes();
  updateFollowUpAlerts(true);
  renderAuditPeek();
  bindNav();
  bindButtons();
  bindKeys();

  $all(".view").forEach(v => v.style.display = "none");
  $("#view-home").style.display = "block";

  if(!state.currentUser) openAuthModal(true);
}
function handleSavCreate(){
  if(!state.sav?.symptom){
    toast("SAV", "S√©lectionne d‚Äôabord un sympt√¥me.");
    return;
  }

  // ‚úÖ On passe openSavForm en callback post-auth
  if(!requireAuth(openSavForm)) return;

  openSavForm();
}

  // IMPORTANT : on passe openSavForm comme callback ‚Üí apr√®s login √ßa s'ouvre tout seul
  if(!requireAuth(openSavForm)) return;

  // D√©j√† connect√© ‚Üí on ouvre direct
  openSavForm();
}

// üîì Rendre les fonctions accessibles aux onclick=""
window.go = go;
window.openSavForm = openSavForm;
window.validateSavAndPrint = validateSavAndPrint;
window.previewSavEligibility = previewSavEligibility;
window.closeSavModal = closeSavModal;
window.reprintLastSav = reprintLastSav;
window.printSavSheet = printSavSheet;

window.setNotesTab = setNotesTab;
window.openFollowupsTab = openFollowupsTab;

window.calcBottles = calcBottles;
window.calcSavings = calcSavings;
window.calcAccu = calcAccu;
window.resetAccuCalc = resetAccuCalc;

window.login = login;
window.logout = logout;
window.closeAuthModal = closeAuthModal;
window.openImportModal = openImportModal;
window.closeImportModal = closeImportModal;
window.importState = importState;
window.exportFullState = exportFullState;
window.clearAll = clearAll;
  // üîß Fonctions appel√©es par onclick mais pas encore expos√©es
window.handleSavCreate = handleSavCreate;

window.unlockWithLicense = unlockWithLicense;
window.enterApp = enterApp;
window.closeWelcome = closeWelcome;

// (optionnel mais recommand√© si tu utilises ces onclick ailleurs)
window.clientReset = clientReset;
window.printSheet = printSheet;
window.renderSavHistory = renderSavHistory;
window.exportSavHistoryCSV = exportSavHistoryCSV;
window.clearSavHistory = clearSavHistory;
window.clearSavProblem = clearSavProblem;
window.toast = toast;
window.saveNote = saveNote;
window.clearNoteForm = clearNoteForm;
window.copySalesLine = copySalesLine;
window.fillExample = fillExample;


function init(){
  if(!hasValidLicense()){
    openLicenseGate();
    return;
  }
  startApp();
}

init();

</script>
</body>
</html>
