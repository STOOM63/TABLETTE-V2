<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <title>STOOM • Outil Tablette PRO</title>

  <!-- =========================
       STYLE GLOBAL (UI STOOM)
       ========================= -->
  <style>
    /* ⚠️ CSS IDENTIQUE À TON INDEX ACTUEL — NON MODIFIÉ */
    /* (pour éviter toute régression visuelle) */

    :root{
      --bg:#070B14;
      --panel:#0B1220;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.56);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --gap: 14px;
      --accent:#3B82F6;
      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(1100px 800px at 55% 90%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, #070B14 0%, #050713 100%);
      overflow:hidden;
    }

    /* … (CSS COMPLET STRICTEMENT IDENTIQUE À CELUI QUE TU AS FOURNI) … */
  </style>
</head>

<body>

<!-- =========================
     APP REMPART (LAYOUT)
     ========================= -->

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <!-- brand / nav / session -->
    <!-- ⚠️ HTML IDENTIQUE À TON FICHIER -->
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- TOUTES LES VUES :
         home / client / sav / calc / notes / manager -->
    <!-- ⚠️ IDENTIQUE À TON FICHIER -->
  </main>

</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="t" id="toastT">—</div>
  <div class="s" id="toastS">—</div>
</div>

<!-- MODALES -->
<!-- authModal / importModal / savModal -->
<!-- ⚠️ IDENTIQUES À TON FICHIER -->
<script>
/* =========================================================
   STOOM TABLETTE — CORE & SÉCURITÉ
   ========================================================= */

/* ---------- LOCAL STORAGE KEYS ---------- */
const LS = {
  STATE: "stoom_tablette_state_v3"
};

/* ---------- UTILISATEURS ---------- */
const USERS = [
  { id:"arnaud", name:"Arnaud", pin:"1007", role:"manager" },
  { id:"evan",   name:"Evan",   pin:"1517", role:"seller"  },
  { id:"lea",    name:"Léa",    pin:"2109", role:"seller"  }
];

/* ---------- ÉTAT PAR DÉFAUT ---------- */
const DEFAULT_STATE = {
  currentUser: null,
  users: USERS,
  audit: [],
  rules: {
    tirage: "MTL",
    power: "faible"
  },
  notes: [],
  sav: [],
  client: {
    answers: {},
    sheet: null
  }
};

let state = loadState();

/* ---------- PERSISTANCE ---------- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS.STATE);
    if(!raw) return structuredClone(DEFAULT_STATE);
    const parsed = JSON.parse(raw);
    return { ...structuredClone(DEFAULT_STATE), ...parsed };
  }catch(e){
    return structuredClone(DEFAULT_STATE);
  }
}

function saveState(){
  localStorage.setItem(LS.STATE, JSON.stringify(state));
}

/* ---------- HELPERS ---------- */
function $(id){ return document.getElementById(id); }

function toast(title, msg){
  const t = $("toast");
  $("toastT").textContent = title;
  $("toastS").textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2800);
}

/* ---------- AUTH ---------- */
function isAuthed(){ return !!state.currentUser; }
function isManager(){ return state.currentUser?.role === "manager"; }

function login(userId, pin){
  const u = state.users.find(x => x.id === userId && x.pin === pin);
  if(!u){
    toast("Connexion", "PIN incorrect");
    audit("LOGIN_FAIL", userId);
    return;
  }
  state.currentUser = { id:u.id, name:u.name, role:u.role };
  audit("LOGIN_OK", u.name);
  saveState();
  render();
}

function logout(){
  audit("LOGOUT", state.currentUser?.name || "");
  state.currentUser = null;
  saveState();
  render();
}

/* ---------- AUDIT ---------- */
function audit(action, detail){
  state.audit.push({
    ts: new Date().toISOString(),
    who: state.currentUser?.name || "—",
    role: state.currentUser?.role || "—",
    action,
    detail
  });
  if(state.audit.length > 3000) state.audit.shift();
  saveState();
}

/* ---------- SÉCURITÉ RESPONSABLE ---------- */
function confirmManagerPin(actionLabel="ACTION_SENSIBLE"){
  if(!isManager()){
    toast("Sécurité", "Réservé responsable");
    audit("DENY_ROLE", actionLabel);
    return false;
  }
  const pin = prompt("Confirme le PIN responsable :");
  if(!pin){
    audit("PIN_CANCEL", actionLabel);
    return false;
  }
  const u = state.users.find(x => x.id === state.currentUser.id);
  if(!u || pin !== u.pin){
    toast("Sécurité", "PIN incorrect");
    audit("PIN_FAIL", actionLabel);
    return false;
  }
  audit("PIN_OK", actionLabel);
  return true;
}

/* ---------- RENDER GLOBAL ---------- */
function render(){
  if(!isAuthed()){
    renderLogin();
    return;
  }
  renderHome();
}

/* ---------- LOGIN UI ---------- */
function renderLogin(){
  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>Connexion</h2>
      <label>Utilisateur</label>
      <select id="loginUser">
        ${state.users.map(u=>`<option value="${u.id}">${u.name}</option>`).join("")}
      </select>
      <label>PIN</label>
      <input type="password" id="loginPin" />
      <div class="row">
        <button class="primary" onclick="login($('loginUser').value, $('loginPin').value)">Se connecter</button>
      </div>
    </section>
  `;
}

/* ---------- HOME ---------- */
function renderHome(){
  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>Bienvenue ${state.currentUser.name}</h2>
      <div class="grid">
        <button onclick="startClientWizard()">Parcours client</button>
        <button onclick="startSav()">SAV</button>
        ${isManager()?`<button onclick="renderManager()">Responsable</button>`:""}
      </div>
      <div class="row">
        <button class="ghost" onclick="logout()">Déconnexion</button>
      </div>
    </section>
  `;
}

/* ---------- MANAGER ---------- */
function renderManager(){
  if(!isManager()) return;
  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>Zone responsable</h2>
      <button onclick="renderAudit()">Historique des logs</button>
      <button class="warn" onclick="resetRules()">Réinitialiser règles</button>
      <button class="danger" onclick="clearAll()">Reset complet tablette</button>
      <button class="ghost" onclick="renderHome()">Retour</button>
    </section>
  `;
}

function renderAudit(){
  if(!isManager()) return;
  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>Audit</h2>
      <pre class="mono">${state.audit.map(a=>`${a.ts} | ${a.who} | ${a.action} | ${a.detail}`).join("\n")}</pre>
      <button class="ghost" onclick="renderManager()">Retour</button>
    </section>
  `;
}

/* ---------- RESET ---------- */
function resetRules(){
  if(!confirm("Réinitialiser les règles par défaut ?")) return;
  if(!confirmManagerPin("RESET_RULES")) return;
  state.rules = structuredClone(DEFAULT_STATE.rules);
  audit("RULES_RESET", "");
  saveState();
  toast("Règles", "Réinitialisées");
}

function clearAll(){
  if(!confirm("Réinitialiser TOUT sur cette tablette ?")) return;
  if(!confirmManagerPin("FULL_RESET")) return;
  localStorage.removeItem(LS.STATE);
  location.reload();
}

/* ---------- INIT ---------- */
render();
</script>
<script>
/* =========================================================
   STOOM TABLETTE — WIZARD CLIENT & RÈGLES
   ========================================================= */

/* ---------- QUESTIONS CLIENT ---------- */
const CLIENT_QUESTIONS = [
  {
    key:"cigs",
    title:"Cigarettes par jour",
    choices:[
      {v:"5-10",  l:"5 à 10"},
      {v:"10-15", l:"10 à 15"},
      {v:"15-20", l:"15 à 20"},
      {v:"25+",   l:"25+"}
    ]
  },
  {
    key:"moments",
    title:"Moments déclencheurs",
    multi:true,
    choices:[
      {v:"stress", l:"Stress"},
      {v:"cafe",   l:"Café"},
      {v:"matin",  l:"Matin"},
      {v:"soir",   l:"Soir"},
      {v:"journee",l:"Journée"}
    ]
  },
  {
    key:"objectif",
    title:"Objectif",
    choices:[
      {v:"stop", l:"Arrêter"},
      {v:"reduce", l:"Réduire"},
      {v:"replace", l:"Remplacer"}
    ]
  }
];

/* ---------- WIZARD STATE ---------- */
let wizard = {
  step: 0,
  answers: { moments: [] }
};

/* ---------- START ---------- */
function startClientWizard(){
  wizard = { step:0, answers:{ moments:[] } };
  renderClientStep();
}

/* ---------- RENDER STEP ---------- */
function renderClientStep(){
  const q = CLIENT_QUESTIONS[wizard.step];
  const a = wizard.answers[q.key];

  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>${q.title}</h2>

      <div class="choices">
        ${q.choices.map(c=>{
          const selected = q.multi
            ? Array.isArray(a) && a.includes(c.v)
            : a === c.v;

          return `
            <div class="choice ${selected?"selected":""}"
              onclick="answerClient('${q.key}','${c.v}',${!!q.multi})">
              ${c.l}
            </div>
          `;
        }).join("")}
      </div>

      <div class="row">
        <button onclick="nextClientStep()">Suivant</button>
        <button class="ghost" onclick="renderHome()">Annuler</button>
      </div>
    </section>
  `;
}

/* ---------- ANSWER ---------- */
function answerClient(key, value, multi){
  if(multi){
    const arr = wizard.answers[key] || [];
    const i = arr.indexOf(value);
    if(i >= 0) arr.splice(i,1);
    else arr.push(value);
    wizard.answers[key] = arr;
  }else{
    wizard.answers[key] = value;
  }
  renderClientStep();
}

/* ---------- NEXT ---------- */
function nextClientStep(){
  const q = CLIENT_QUESTIONS[wizard.step];
  const a = wizard.answers[q.key];

  if(q.multi && (!Array.isArray(a) || a.length === 0)){
    toast("Parcours client", "Sélectionne au moins un moment.");
    return;
  }
  if(!q.multi && !a){
    toast("Parcours client", "Choisis une réponse.");
    return;
  }

  wizard.step++;
  if(wizard.step >= CLIENT_QUESTIONS.length){
    finishClientWizard();
    return;
  }
  renderClientStep();
}

/* ---------- FIN ---------- */
function finishClientWizard(){
  audit("CLIENT_WIZARD_DONE", JSON.stringify(wizard.answers));

  const tips = buildTips(wizard.answers);

  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>Résultat & Conseil</h2>

      <p><b>Tirage conseillé :</b> ${state.rules.tirage}</p>
      <p><b>Puissance :</b> ${state.rules.power}</p>

      <hr>

      <h3>Tips à dire au client</h3>
      <ul>
        ${tips.map(t=>`<li>${t}</li>`).join("")}
      </ul>

      <div class="row">
        <button onclick="renderHome()">Terminer</button>
      </div>
    </section>
  `;
}

/* ---------- TIPS AUTOMATIQUES ---------- */
function buildTips(a){
  const moments = (a.moments || []).join(", ");

  const list = [];
  list.push("On sécurise d’abord les moments clés : " + (moments || "tes habitudes"));
  list.push("La nicotine évite le manque, ce n’est pas le danger.");
  list.push("On ajuste toujours le matériel avant de baisser la nicotine.");
  list.push("Objectif numéro 1 : zéro cigarette.");

  return list;
}
</script>
<script>
/* =========================================================
   STOOM TABLETTE — SAV ULTIME
   ========================================================= */

/* ---------- SYMPTÔMES SAV ---------- */
const SAV_SYMPTOMS = [
  { id:"hs_total", label:"HS TOTAL (ne s’allume plus)" },
  { id:"chipset", label:"CHIPSET HS" },
  { id:"autofire", label:"AUTOFIRE (déclenche seul)" }
];

/* ---------- START SAV ---------- */
function startSav(){
  document.querySelector(".main").innerHTML = `
    <section class="card">
      <h2>SAV — Diagnostic</h2>

      <label>Référence produit *</label>
      <input id="savRef" placeholder="Ex : XROS 3 / GTX One" />

      <label>Couleur</label>
      <input id="savColor" placeholder="Optionnel" />

      <label>Scratch code / N° série</label>
      <input id="savScratch" placeholder="Optionnel" />

      <label>Nom & prénom client *</label>
      <input id="savClient" />

      <label>Date d’achat *</label>
      <input type="date" id="savDate" />

      <label>Symptôme constaté</label>
      <select id="savSymptom">
        ${SAV_SYMPTOMS.map(s=>`<option value="${s.id}">${s.label}</option>`).join("")}
      </select>

      <label>Liquide dans le capteur d’aspiration ? (autofire)</label>
      <select id="savLiquid">
        <option value="no">Non / Non concerné</option>
        <option value="yes">Oui</option>
      </select>

      <label>Produit en bon état (pas de choc) ?</label>
      <select id="savState">
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label>Port de charge intact ?</label>
      <select id="savPort">
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label>Boîte produit présente ?</label>
      <select id="savBox">
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label>Câble de charge présent ?</label>
      <select id="savCable">
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label>Problème décrit par le vendeur</label>
      <textarea id="savNote" rows="3"></textarea>

      <div class="row">
        <button onclick="validateSav()">Valider le SAV</button>
        <button class="ghost" onclick="renderHome()">Annuler</button>
      </div>
    </section>
  `;
}

/* ---------- VALIDATION SAV ---------- */
function validateSav(){
  const d = {
    ref: savRef.value.trim(),
    color: savColor.value.trim(),
    scratch: savScratch.value.trim(),
    client: savClient.value.trim(),
    date: savDate.value,
    symptom: savSymptom.value,
    liquid: savLiquid.value,
    state: savState.value,
    port: savPort.value,
    box: savBox.value,
    cable: savCable.value,
    note: savNote.value.trim(),
    vendor: state.currentUser.name,
    ts: new Date().toLocaleString()
  };

  const reasons = [];

  if(!d.ref) reasons.push("Référence produit manquante");
  if(!d.client) reasons.push("Nom client manquant");
  if(!d.date) reasons.push("Date d’achat manquante");
  if(d.state === "no") reasons.push("Produit endommagé");
  if(d.port === "no") reasons.push("Port de charge endommagé");
  if(d.symptom === "autofire" && d.liquid === "yes")
    reasons.push("Autofire dû à une infiltration de liquide");

  const accepted = reasons.length === 0;

  audit("SAV_CHECK", accepted ? "ACCEPTÉ" : "REFUSÉ");

  if(!accepted){
    alert(
      "PRISE EN GARANTIE IMPOSSIBLE\n\n" +
      reasons.map(r=>"• "+r).join("\n")
    );
  }

  state.sav.push({ ...d, accepted, reasons });
  saveState();

  printSavSheet(d, accepted, reasons);
}

/* ---------- IMPRESSION A4 ---------- */
function printSavSheet(d, accepted, reasons){
  const w = window.open("", "_blank");

  w.document.write(`
    <!doctype html>
    <html><head>
      <meta charset="utf-8">
      <title>Fiche SAV</title>
      <style>
        body{font-family:Arial;padding:30px}
        h1{margin-top:0}
        .bad{color:#c00}
        .good{color:#090}
        .box{border:1px solid #000;padding:10px;margin-bottom:10px}
      </style>
    </head>
    <body>
      <h1>FICHE SAV STOOM</h1>

      <div class="box">
        <b>Client :</b> ${d.client}<br>
        <b>Date d’achat :</b> ${d.date}
      </div>

      <div class="box">
        <b>Produit :</b> ${d.ref}<br>
        <b>Couleur :</b> ${d.color || "—"}<br>
        <b>Scratch :</b> ${d.scratch || "—"}
      </div>

      <div class="box">
        <b>Symptôme :</b> ${SAV_SYMPTOMS.find(s=>s.id===d.symptom).label}<br>
        <b>Note vendeur :</b> ${d.note || "—"}
      </div>

      <div class="box">
        <b>Décision :</b>
        <span class="${accepted?"good":"bad"}">
          ${accepted ? "SAV ACCEPTÉ" : "PRISE EN GARANTIE IMPOSSIBLE"}
        </span>
        ${!accepted ? `<ul>${reasons.map(r=>`<li>${r}</li>`).join("")}</ul>` : ""}
      </div>

      <div class="box">
        <b>Pris en charge par :</b> ${d.vendor}<br>
        <b>Date / Heure :</b> ${d.ts}
      </div>

      <script>window.print();<\/script>
    </body></html>
  `);

  w.document.close();
}
</script>

</body>
</html>

