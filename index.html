<!doctype html>
<html lang="fr">
<head>

  <!--
    STOOM ‚Äì Outil Tablette PRO
    Logiciel d√©velopp√© par Arnaud BLANC
    ¬© 2024‚Äì2025 Arnaud BLANC ‚Äì Tous droits r√©serv√©s

    Ce logiciel est une ≈ìuvre originale dont Arnaud BLANC est l‚Äôauteur
    et le titulaire exclusif des droits de propri√©t√© intellectuelle.

    Toute reproduction, modification, diffusion ou utilisation,
    totale ou partielle, sans autorisation √©crite de l‚Äôauteur,
    est strictement interdite.

    Le logiciel est mis √† disposition de l‚Äôenseigne STOOM
    pour un usage interne uniquement.
  -->

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220">

  <title>STOOM ¬∑ Outil Tablette PRO</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- iOS (iPad / iPhone) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="STOOM SAV">
  <link rel="apple-touch-icon" href="icon-192.png">


  <title>STOOM ‚Ä¢ Outil Tablette PRO</title>
  <style>
    :root{
      --bg:#070B14;
      --panel:#0B1220;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.56);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --gap: 14px;
      --accent:#3B82F6;
      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(1100px 800px at 55% 90%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, #070B14 0%, #050713 100%);
      overflow:hidden;
    }
    .app{height:100%; display:grid; grid-template-columns: 380px 1fr;}
    @media (max-width: 980px){body{overflow:auto}.app{grid-template-columns:1fr}}

    .sidebar{
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.02) 100%);
      border-right:1px solid var(--stroke);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      height:100%;
      overflow:auto;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      margin-bottom:14px;
    }
    .brand-left{display:flex; gap:12px; align-items:center;}
 
/* Logo Apple-like : wrapper + image */
.logoWrap{
  width:64px;
  height:64px;
  border-radius:20px;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:center;

  background: linear-gradient(135deg,
    rgba(255,255,255,.30),
    rgba(255,255,255,.08)
  );
  border: 1px solid rgba(255,255,255,.18);

  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  box-shadow:
    0 22px 60px rgba(0,0,0,.55),
    inset 0 1px 0 rgba(255,255,255,.35);
  position:relative;
  overflow:hidden;
}

.logoWrap::before{
  content:"";
  position:absolute;
  inset:-40%;
  background: radial-gradient(circle at 30% 20%,
    rgba(255,255,255,.55),
    transparent 55%
  );
  transform: rotate(20deg);
  opacity:.55;
}

.logoImg{
  width:100%;
  height:100%;
  object-fit:contain;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
  position:relative;
  z-index:1;
}
    .brand h1{font-size:14px; margin:0; letter-spacing:.08em; text-transform:uppercase}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 5px rgba(245,158,11,.12)}
    .dot.ok{background:var(--good);box-shadow:0 0 0 5px rgba(34,197,94,.12)}
    .pill button{
      all:unset; cursor:pointer; color:var(--text);
      padding:2px 6px; border-radius:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .pill button:hover{background:rgba(255,255,255,.10)}

    .nav{display:flex; flex-direction:column; gap:10px; margin-top:14px;}
    .navbtn{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .navbtn:hover{background: rgba(255,255,255,.06)}
    .navbtn:active{transform: scale(.99)}
    .navbtn.active{
      background: linear-gradient(135deg, rgba(59,130,246,.22), rgba(139,92,246,.12));
      border-color: rgba(59,130,246,.35);
    }
    .icon{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-family:var(--mono);
      font-size:13px;
      color:rgba(255,255,255,.85);
    }
    .navtxt{display:flex; flex-direction:column; gap:2px}
    .navtxt .t{font-size:13px; font-weight:700}
    .navtxt .s{font-size:12px; color:var(--muted)}
    .kbd{
      margin-left:auto;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted2);
      padding:4px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .side-card{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .side-card h3{margin:0 0 8px; font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted)}
    .side-card .row{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,.08)}
    .side-card .row:first-of-type{border-top:none}
    .side-card .row span{font-size:12px; color:var(--muted)}
    .side-card .row strong{font-size:12px}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .08s ease;
      font-size:12px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: scale(.99)}
    .btn.primary{border-color: rgba(59,130,246,.40); background: rgba(59,130,246,.18);}
    .btn.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12);}
    .btn.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12);}
    .btn[disabled]{opacity:.45; cursor:not-allowed}

    .main{height:100%; overflow:auto; padding:18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;}
    .search{
      flex:1; display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    .search input{all:unset; flex:1; font-size:13px; color:var(--text);}
    .search .hint{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted2);
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    @media (min-width:1180px){.grid.cols2{grid-template-columns:1.1fr .9fr;}}

    .panel{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .panel .ph h2{margin:0;font-size:14px;letter-spacing:.04em}
    .panel .ph p{margin:3px 0 0;font-size:12px;color:var(--muted)}
    .panel .pb{padding:14px;}

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      user-select:none;
    }

    .q{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
    }
    .q h3{margin:0 0 6px;font-size:14px}
    .q p{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.4}

    .two{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width:1180px){.two{grid-template-columns:1fr 1fr}}

    .choices{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;}
    @media (min-width:900px){
      .choices.cols3{grid-template-columns:repeat(3, minmax(0,1fr));}
      .choices.cols4{grid-template-columns:repeat(4, minmax(0,1fr));}
    }
    .choice{
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .choice:hover{background: rgba(255,255,255,.06)}
    .choice:active{transform: scale(.99)}
    .choice.selected{
      border-color: rgba(59,130,246,.45);
      background: rgba(59,130,246,.14);
    }
    .choice .ct{font-weight:800;font-size:13px}
    .choice .cs{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}

    textarea, select, input[type="number"], input[type="text"], input[type="password"], input[type="date"]{
      width:100%;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    textarea{min-height:96px; resize:vertical; line-height:1.4}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    .mono{font-family:var(--mono)}
    .small{font-size:11px; color:var(--muted2)}
    .hr{height:1px;background: rgba(255,255,255,.10); margin:12px 0}

    .steps{display:flex; gap:8px; flex-wrap:wrap;}
    .step{
      flex:1; min-width:120px;
      padding:10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .step.active{
      color: var(--text);
      border-color: rgba(59,130,246,.35);
      background: rgba(59,130,246,.10);
    }
    .step.done{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: var(--text);
    }

    .result{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, rgba(59,130,246,.16), rgba(139,92,246,.10));
      padding:14px;
    }
    .result h3{margin:0 0 8px;font-size:14px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
    }
    .chip b{font-weight:900}

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform: translateX(-50%);
      min-width: 280px; max-width: 92vw;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,32,.92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 20px 80px rgba(0,0,0,.6);
      display:none; z-index:9999;
    }
    .toast.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px); opacity:.2}to{transform:translateX(-50%) translateY(0); opacity:1}}
    .toast .t{font-size:12px;color:var(--text)}
    .toast .s{font-size:11px;color:var(--muted); margin-top:4px}

    .modal{
      position:fixed; inset:0;
      display:none; z-index:9998;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      padding:18px; overflow:auto;
    }
    .modal.show{display:block}
    .modal-card{
      max-width: 820px;
      margin: 40px auto;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,32,.92);
      box-shadow: 0 20px 90px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .modal-h{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal-h h3{margin:0;font-size:14px}
    .modal-b{padding:14px}
    .xbtn{
      all:unset; cursor:pointer;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--text);
    }
    .xbtn:hover{background: rgba(255,255,255,.08)}

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding:12px;
    }
    .item .top{display:flex; justify-content:space-between; gap:12px; align-items:flex-start}
    .item .top strong{font-size:13px}
    .item .top span{font-size:11px;color:var(--muted2);font-family:var(--mono)}
    .item p{margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.4}

    .dangerText{color: rgba(239,68,68,.92)}
    .goodText{color: rgba(34,197,94,.92)}
    .warnText{color: rgba(245,158,11,.92)}
    .tabSwitch{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;}
    .tabBtn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      user-select:none;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
    }
    .tabBtn:hover{background: rgba(255,255,255,.06)}
    .tabBtn:active{transform:scale(.99)}
    .tabBtn.active{border-color: rgba(59,130,246,.35); background: rgba(59,130,246,.14);}
    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .statusPill.wait{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.32); color:var(--warn);}
    .statusPill.over{background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.32); color:var(--bad);}
    .statusPill.done{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.32); color:var(--good);}
    .alertBanner{
      padding:12px;
      border-radius: var(--radius);
      border:1px solid rgba(239,68,68,.25);
      background: linear-gradient(135deg, rgba(239,68,68,.18), rgba(245,158,11,.14));
      box-shadow: var(--shadow);
      margin-bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .alertBanner strong{font-size:13px}
    .alertBanner .btnrow{margin:0}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-left">
        <div class="logoWrap">
  <img class="logoImg" src="/TABLETTE-V2/assets/logo-fluxa.png" alt="FLUXA">
        </div>
        <div>
          <h1>STOOM</h1>
          <p>Tablette PRO ‚Ä¢ audit + SAV imprimable</p>
        </div>
      </div>
      <div class="pill" id="authPill" title="Connexion vendeur obligatoire">
        <span class="dot" id="authDot"></span>
        <span id="authLabel">Non connect√©</span>
        <button id="authBtn">PIN</button>
      </div>
    </div>

    <div class="nav" id="nav">
      <div class="navbtn active" data-view="home" tabindex="0">
        <div class="icon">01</div>
        <div class="navtxt"><div class="t">Accueil</div><div class="s">parcours + SAV + audit</div></div>
        <div class="kbd">H</div>
      </div>

      <div class="navbtn" data-view="client" tabindex="0">
        <div class="icon">CL</div>
        <div class="navtxt"><div class="t">Parcours client</div><div class="s">diagnostic + fiche</div></div>
        <div class="kbd">C</div>
      </div>

      <div class="navbtn" data-view="sav" tabindex="0">
        <div class="icon">SV</div>
        <div class="navtxt"><div class="t">SAV</div><div class="s">guid√© + fiche A4</div></div>
        <div class="kbd">S</div>
      </div>

      <div class="navbtn" data-view="calc" tabindex="0">
        <div class="icon">‚Ç¨</div>
        <div class="navtxt"><div class="t">Calculs</div><div class="s">conso & √©conomies</div></div>
        <div class="kbd">K</div>
      </div>

      <div class="navbtn" data-view="batt" tabindex="0">
        <div class="icon">Œ©</div>
        <div class="navtxt"><div class="t">Accus</div><div class="s">s√©curit√© & charge</div></div>
        <div class="kbd">B</div>
      </div>

      <div class="navbtn" data-view="notes" tabindex="0">
        <div class="icon">üìù</div>
        <div class="navtxt"><div class="t">Notes client</div><div class="s">suivi (prot√©g√©)</div></div>
        <div class="kbd">N</div>
      </div>

      <div class="navbtn" data-view="followup" tabindex="0">
        <div class="icon">üìû</div>
        <div class="navtxt"><div class="t">Rappels</div><div class="s">suivi t√©l√©phonique</div></div>
        <div class="kbd">R</div>
      </div>

      <div class="navbtn" data-view="manager" tabindex="0" id="managerNav" style="display:none">
        <div class="icon">AD</div>
        <div class="navtxt"><div class="t">Responsable</div><div class="s">r√®gles + audit + users</div></div>
        <div class="kbd">A</div>
      </div>
    </div>

    <div class="side-card">
      <h3>Session</h3>
      <div class="row"><span>Date</span> <strong id="today"></strong></div>
      <div class="row"><span>Utilisateur</span> <strong id="userMini">‚Äî</strong></div>
      <div class="row"><span>R√¥le</span> <strong id="roleMini">‚Äî</strong></div>
      <div class="row"><span>Derni√®re fiche</span> <strong id="sheetMini">‚Äî</strong></div>
      <div class="row"><span>Rappels</span> <strong id="followupMini">0</strong></div>

      <div class="btnrow">
        <button class="btn primary" id="printBtn">Imprimer fiche client</button>
        <button class="btn" id="exportStateBtn">Exporter</button>
      </div>
      <div class="btnrow">
        <button class="btn" id="importStateBtn">Importer</button>
        <button class="btn danger" id="resetBtn">R√©initialiser</button>
      </div>

      <div class="small" style="margin-top:10px">
        ‚ö†Ô∏è Export/Import/Reset : <b>Responsable uniquement</b>.<br/>
        Offline : OK (stockage appareil).<br/>
        Raccourcis : H C S K B N R A ‚Ä¢ <span class="mono">Ctrl/Cmd+P</span> ‚Ä¢ <span class="mono">/</span> recherche ‚Ä¢ <span class="mono">Esc</span>.
      </div>
      <div class="small" style="margin-top:12px; opacity:.55">
  Logiciel d√©velopp√© par <b>Arnaud BLANC</b><br/>
  ¬© 2024‚Äì2025 Arnaud BLANC ‚Äì Tous droits r√©serv√©s<br/>
  Propri√©t√© intellectuelle exclusive ‚Äì usage interne STOOM
</div>

    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="opacity:.8">üîé</span>
        <input id="searchInput" type="text" placeholder="Rechercher (ex: fuite, br√ªl√©, MTL, sel, audit...)" />
        <span class="hint">/</span>
      </div>
      <button class="btn" id="quickNew">Nouveau client</button>
      <button class="btn" id="logoutBtn">D√©connexion</button>
    </div>

    <!-- HOME -->
    <div id="view-home" class="view">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Accueil</h2>
              <p>Parcours client + SAV + tra√ßabilit√©.</p>
            </div>
            <span class="badge">Pro</span>
          </div>
          <div class="pb">
            <div class="alertBanner" id="homeFollowupBanner" style="display:none">
              <div>
                <strong id="homeFollowupText">‚Äî</strong>
                <div class="small">Les rappels en retard ou √† faire aujourd‚Äôhui sont list√©s dans l‚Äôonglet Suivis.</div>
              </div>
              <div class="btnrow">
                <button class="btn primary" onclick="openFollowupsTab()">Voir les rappels</button>
              </div>
            </div>
            <div class="two">
              <div class="result">
                <h3>‚úÖ Raccourcis</h3>
                <div class="chips">
                  <span class="chip"><b>Client</b> ‚Üí Diagnostic</span>
                  <span class="chip"><b>SAV</b> ‚Üí Fiche A4</span>
                  <span class="chip"><b>Notes</b> ‚Üí Suivi</span>
                </div>
                <p class="small" style="margin-top:10px">
                  Objectif : recommandation stable + preuve d‚Äôutilisation (audit).
                </p>
                <div class="btnrow">
                  <button class="btn primary" onclick="go('client')">D√©marrer diagnostic</button>
                  <button class="btn" onclick="go('sav')">D√©marrer SAV</button>
                  <button class="btn" onclick="setNotesTab('notes'); go('notes')">Notes</button>
                </div>
              </div>

              <div class="q">
                <h3>‚öôÔ∏è R√®gles actives (r√©sum√©)</h3>
                <p class="muted" id="rulesSummary">‚Äî</p>
                <div class="btnrow">
                  <button class="btn" onclick="toast('Info', 'Les r√®gles modifient tirage/puissance/mat√©riel/nicotine selon les r√©ponses.')">Comprendre</button>
                  <button class="btn primary" id="goManagerBtn" style="display:none" onclick="go('manager')">Modifier (responsable)</button>
                </div>
                <div class="hr"></div>
                <h3>üß† Message cl√©</h3>
                <p class="muted">
                  ‚ÄúOn vise d‚Äôabord <b>z√©ro cigarette</b>. La baisse de nicotine vient quand c‚Äôest stable et confortable.‚Äù
                </p>
              </div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>üßæ Audit (aper√ßu)</h3>
              <p class="muted">Aper√ßu 5 derni√®res actions. (Audit complet : responsable uniquement.)</p>
              <div id="auditPeek" class="list"></div>
            </div>

          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Derni√®re fiche client</h2>
              <p>Reprise auto.</p>
            </div>
            <span class="badge">Auto</span>
          </div>
          <div class="pb">
            <div id="lastSheetBox" class="q">
              <h3>‚Äî</h3>
              <p class="muted">Aucune fiche pour le moment.</p>
              <div class="btnrow"><button class="btn" onclick="go('client')">Cr√©er une fiche</button></div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>Derni√®re fiche SAV</h3>
              <p class="muted">Si tu viens de traiter un SAV, tu peux r√©-imprimer.</p>
              <div class="btnrow">
                <button class="btn" onclick="reprintLastSav()">R√©-imprimer SAV</button>
              </div>
              <div class="small">L‚Äôinfo SAV est stock√©e localement sur la tablette.</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- CLIENT -->
    <div id="view-client" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Parcours client</h2>
              <p>5 questions ‚Üí fiche claire.</p>
            </div>
            <span class="badge">Wizard</span>
          </div>
          <div class="pb">
            <div class="steps" id="clientSteps"></div>
            <div class="q" id="clientQuestionBox" style="margin-top:12px"></div>
            <div class="btnrow" style="justify-content:space-between">
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
                <button class="btn" id="clientPrev">Pr√©c√©dent</button>
                <span class="small mono">Astuce : 1/2/3/4 pour r√©pondre vite.</span>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" onclick="clientReset()">Recommencer</button>
                <button class="btn primary" id="clientNext">Suivant</button>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Fiche recommandation</h2>
              <p>Auto-g√©n√©r√©e selon les r√®gles actives.</p>
            </div>
            <span class="badge">Fiche</span>
          </div>
          <div class="pb">
            <div class="result" id="sheetBox">
              <h3>En attente‚Ä¶</h3>
              R√©ponds aux questions pour g√©n√©rer la fiche.</p>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>üó£Ô∏è Phrase pr√™te √† dire</h3>
              <p class="muted mono" id="salesLine">‚Äî</p>
              <div class="btnrow">
                <button class="btn" onclick="copySalesLine()">Copier</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- SAV -->
    <div id="view-sav" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>SAV guid√©</h2>
              <p>Sympt√¥me ‚Üí causes ‚Üí actions ‚Üí fiche imprimable.</p>
            </div>
            <span class="badge">SAV</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Quel probl√®me principal ?</h3>
              Choisis le sympt√¥me dominant.</p>
              <div class="choices cols3" id="savChoices"></div>
            </div>

           <div class="q" id="savResult" style="margin-top:12px">
  <h3>En attente‚Ä¶</h3>
  S√©lectionne un sympt√¥me.</p>
</div>

<div class="q" style="margin-top:12px">
  <h3>Probl√®me constat√© (par le vendeur)</h3>
  Ce texte sera repris automatiquement dans la fiche SAV.</p>
  <textarea id="savVendorProblem" placeholder="Ex: ne charge plus / fuite importante / go√ªt br√ªl√© malgr√© changement de r√©sistance..."></textarea>
  <div class="btnrow" style="margin-top:10px">
    <button class="btn primary" onclick="openSavForm()">Cr√©er fiche SAV imprimable</button>
    <button class="btn" onclick="clearSavProblem()">Effacer</button>
  </div>
  <div class="small">La fiche SAV sert de preuve interne + justificatif dans le colis fournisseur.</div>
</div>


            <div class="q" id="savResult" style="margin-top:12px">
              <h3>En attente‚Ä¶</h3>
              S√©lectionne un sympt√¥me.</p>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Checklist SAV</h2>
              <p>Trame simple (60 secondes).</p>
            </div>
            <span class="badge">Pro</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Questions √† poser</h3>
              <ul class="muted" style="margin:10px 0 0; padding-left:18px">
                <li>Depuis quand ? (aujourd‚Äôhui / 2 jours / 1 semaine)</li>
                <li>Liquide : taux / ratio / nouveaut√© ?</li>
                <li>R√©sistance : neuve ? amor√ßage ? puissance ?</li>
                <li>Airflow : trop ouvert ? tirage trop fort ?</li>
                <li>Choc / chaleur / fuite dans la poche ?</li>
              </ul>
              <div class="hr"></div>
              <h3>Conclusion</h3>
              ‚ÄúOn fait <b>1 changement √† la fois</b>, puis on valide. Le but : usage stable.‚Äù</p>
            </div>
            <div class="q" style="margin-top:12px">
  <h3>Historique SAV</h3>
  <p class="muted">Recherche + r√©-impression. Suppression/Export : responsable.</p>

  <label>Filtrer (produit, raison, op√©rateur...)</label>
  <input id="savHistoryFilter" type="text" placeholder="Ex: XROS, fuite, Evan..." />

  <div class="btnrow" style="margin-top:10px">
    <button class="btn" onclick="renderSavHistory()">Appliquer</button>
    <button class="btn primary" onclick="exportSavHistoryCSV()">Exporter CSV</button>
    <button class="btn danger" onclick="clearSavHistory()">Vider historique</button>
  </div>

  <div class="hr"></div>
  <div id="savHistoryList" class="list"></div>
</div>

          </div>
        </section>
      </div>
    </div>

    <!-- CALC -->
    <div id="view-calc" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Calculateur conso</h2>
              <p>Estimation flacons 10ml.</p>
            </div>
            <span class="badge">10ml</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Cigarettes / jour</label>
                  <input id="cigsPerDay" type="number" min="0" step="1" placeholder="Ex: 20" />
                </div>
                <div>
                  <label>Dur√©e (jours)</label>
                  <input id="days" type="number" min="1" step="1" value="30" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Hypoth√®se</label>
                  <select id="mlPerDayAt20">
                    <option value="3">20 cig/j ‚âà 3 ml/j</option>
                    <option value="4" selected>20 cig/j ‚âà 4 ml/j</option>
                    <option value="5">20 cig/j ‚âà 5 ml/j</option>
                  </select>
                </div>
                <div>
                  <label>Prix flacon 10ml (‚Ç¨)</label>
                  <input id="price10ml" type="number" min="0" step="0.1" placeholder="Ex: 5.9" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="calcBottles()">Calculer</button>
                <button class="btn" onclick="fillExample()">Exemple (20 cig/j)</button>
              </div>

              <div class="hr"></div>
              <div class="result" id="bottleResult">
                <h3>R√©sultat</h3>
                Renseigne les champs puis ‚ÄúCalculer‚Äù.</p>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Comparatif √©conomies</h2>
              <p>Tabac vs vape.</p>
            </div>
            <span class="badge">‚Ç¨</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Prix paquet (‚Ç¨)</label>
                  <input id="packPrice" type="number" min="0" step="0.1" placeholder="Ex: 12.5" />
                </div>
                <div>
                  <label>Paquets / jour</label>
                  <input id="packsPerDay" type="number" min="0" step="0.1" placeholder="Ex: 1" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Budget vape / mois (‚Ç¨)</label>
                  <input id="vapeMonthly" type="number" min="0" step="1" placeholder="Ex: 60" />
                </div>
                <div>
                  <label>Dur√©e (mois)</label>
                  <input id="months" type="number" min="1" step="1" value="12" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="calcSavings()">Calculer</button>
              </div>

              <div class="hr"></div>
              <div class="result" id="savingsResult">
                <h3>R√©sultat</h3>
                Renseigne puis ‚ÄúCalculer‚Äù.</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- BATT -->
    <div id="view-batt" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Accus & s√©curit√©</h2>
              <p>Dimensionner selon la puissance r√©gl√©e.</p>
            </div>
            <span class="badge">S√©curit√©</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Type de box</label>
                  <select id="battBoxType">
                    <option value="single">Simple accu</option>
                    <option value="dual" selected>Double accus (s√©rie typique)</option>
                  </select>
                </div>
                <div>
                  <label>Mode</label>
                  <div class="pill">Wattage (TC non g√©r√©)</div>
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Puissance r√©gl√©e (W)</label>
                  <input id="battPower" type="number" min="1" step="1" placeholder="Ex: 60" />
                </div>
                <div>
                  <label>R√©sistance (Œ©) <span class="muted">(optionnel)</span></label>
                  <input id="battRes" type="number" min="0.05" step="0.01" placeholder="Ex: 0.18" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Niveau batterie minimal (V)</label>
                  <input id="battMinV" type="number" min="2.8" max="3.4" step="0.05" />
                </div>
                <div>
                  <label>Marge s√©curit√© (ratio CDR)</label>
                  <input id="battMargin" type="number" min="0.5" max="1" step="0.05" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" id="battCalcBtn">Calculer / Conseiller</button>
                <button class="btn" onclick="copyBatteryAdvice()">Copier r√©sultats</button>
              </div>

              <div class="small" style="margin-top:6px">P√©dagogique uniquement. Valeurs indicatives, v√©rifier fiche fabricant. Outil offline (stockage local).</div>

              <div class="hr"></div>
              <div class="result" id="battResults">
                <h3>Pr√™t</h3>
                Renseigne la puissance pour obtenir des accus adapt√©s + rappels de s√©curit√©.</p>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Charge & entretien</h2>
              <p>Charge externe, adaptateur et checklist.</p>
            </div>
            <span class="badge">Conseils</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Chargeurs recommand√©s</h3>
              <p class="muted">Pr√©f√©rence : chargeur externe 0.5‚Äì1A, slots adapt√©s. √âviter charge directe si port ab√Æm√©.</p>
              <div id="chargerList" class="list"></div>
              <div class="chip" style="margin-top:10px"><b>Adaptateur secteur</b> 5V / 2A ou + (marque fiable, c√¢ble intact)</div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>Entretien & s√©curit√©</h3>
              <div class="list">
                <label class="checkbox"><input type="checkbox" id="wrapOk" checked /> <span>Wrap intact (sinon <b>ne pas utiliser</b>)</span></label>
                <label class="checkbox"><input type="checkbox" id="wrapDamaged" /> <span>Wrap ab√Æm√© / perc√©</span></label>
                <label class="checkbox"><input type="checkbox" id="transportCase" /> <span>Transport en bo√Ætier d√©di√© (aucune pi√®ce m√©tallique)</span></label>
                <label class="checkbox"><input type="checkbox" id="pocketWarning" /> <span>Jamais en poche avec cl√©s/monnaie</span></label>
                <label class="checkbox"><input type="checkbox" id="tempWarning" /> <span>Temp√©rature : √©viter soleil / voiture chaude</span></label>
                <label class="checkbox"><input type="checkbox" id="storageMid" /> <span>Stockage long : 40‚Äì60% / recharger tous les 2‚Äì3 mois</span></label>
              </div>
              <div class="alertBanner danger" id="wrapAlert" style="display:none; margin-top:10px">
                <div>
                  <strong>Wrap ab√Æm√© = <u>usage interdit</u></strong>
                  <div class="small">Ne pas ins√©rer dans une box. Remplacer ou re-wrapper avant toute utilisation.</div>
                </div>
              </div>
              <div class="small" style="margin-top:10px">
                Authentique uniquement, √©viter rewraps douteux. V√©rifier CDR, pas de promesse m√©dicale, outil p√©dagogique.
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- NOTES -->
    <div id="view-notes" class="view" style="display:none">
      <div class="tabSwitch" id="notesTabSwitch">
        <button class="tabBtn active" data-tab="notes" onclick="setNotesTab('notes')">Notes</button>
        <button class="tabBtn" data-tab="followups" onclick="setNotesTab('followups')">Suivis / Rappels</button>
      </div>

      <div id="notesTab-notes">
        <div class="grid cols2">
          <section class="panel">
            <div class="ph">
              <div>
                <h2>Notes client</h2>
                <p>Suivi local (prot√©g√©).</p>
              </div>
              <span class="badge">Local</span>
            </div>
            <div class="pb">
              <div class="q">
                <div class="two">
                  <div>
                    <label>Nom / pseudo client</label>
                    <input id="noteName" type="text" placeholder="Ex: M. Dupont" />
                  </div>
                  <div>
                    <label>T√©l√©phone (optionnel)</label>
                    <input id="notePhone" type="text" placeholder="Ex: 06..." />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Note</label>
                  <textarea id="noteText" placeholder="Ex: 20 cig/j, 10mg sel, MTL. Sensible ‚Üí baisser puissance."></textarea>
                </div>

                <div class="btnrow">
                  <button class="btn primary" onclick="saveNote()">Enregistrer</button>
                  <button class="btn" onclick="clearNoteForm()">Effacer</button>
                  <button class="btn" id="toggleMaskBtn" style="display:none" onclick="toggleMaskPhones()">Masquer/afficher num√©ros</button>
                </div>

                <div class="small" style="margin-top:10px">
                  Conseil RGPD : √©viter de stocker plus que n√©cessaire.
                </div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="ph">
              <div>
                <h2>Historique</h2>
                <p>Recherche + suppression (responsable).</p>
              </div>
              <span class="badge">CRM light</span>
            </div>
            <div class="pb">
              <div class="q">
                <label>Filtrer</label>
                <input id="noteFilter" type="text" placeholder="Nom, mot, num√©ro..." />
                <div class="hr"></div>
                <div id="notesList" class="list"></div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <div id="notesTab-followups" style="display:none">
        <div class="grid cols2">
          <section class="panel">
            <div class="ph">
              <div>
                <h2>Suivis / Rappels</h2>
                <p>Planifier et tracer les appels.</p>
              </div>
              <span class="badge">Agenda</span>
            </div>
            <div class="pb">
              <div class="q">
                <div class="two">
                  <div>
                    <label>Nom client *</label>
                    <input id="followName" type="text" placeholder="Ex: Jean Dupont" />
                  </div>
                  <div>
                    <label>T√©l√©phone</label>
                    <input id="followPhone" type="text" placeholder="Ex: 06..." />
                  </div>
                </div>

                <div class="two" style="margin-top:10px">
                  <div>
                    <label>Date de rappel *</label>
                    <input id="followDueDate" type="date" />
                  </div>
                  <div>
                    <label>Heure (optionnel)</label>
                    <input id="followDueTime" type="time" />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>R√©sum√© / fiche client</label>
                  <textarea id="followSummary" placeholder="Profil fumeur, mat√©riel propos√©, liquide/taux‚Ä¶"></textarea>
                </div>

                <div class="btnrow" style="margin-top:10px">
                  <button class="btn primary" id="followSaveBtn" onclick="saveFollowup()">Cr√©er le rappel</button>
                  <button class="btn" onclick="clearFollowupForm()">Nouvelle fiche</button>
                </div>
                <div class="small" style="margin-top:8px">Cr√©ation/√©dition vendeur OK. Suppression/export : responsable uniquement.</div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="ph">
              <div>
                <h2>Rappels programm√©s</h2>
                <p>Statuts + actions rapides.</p>
              </div>
              <span class="badge">Suivi</span>
            </div>
            <div class="pb">
              <div class="q">
                <label>Recherche</label>
                <input id="followupFilter" type="text" placeholder="Nom, t√©l√©phone, r√©sum√©, r√©sultat..." />
                <div class="btnrow" style="margin-top:10px">
                  <button class="btn" onclick="renderFollowups()">Appliquer</button>
                  <button class="btn" id="exportFollowupsBtn" onclick="exportFollowupsCSV()">Exporter CSV</button>
                  <button class="btn danger" id="clearFollowupsBtn" onclick="clearFollowups()">Vider suivis</button>
                </div>
                <div class="hr"></div>
                <div id="followList" class="list"></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- MANAGER -->
    <div id="view-manager" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Espace responsable</h2>
              <p>R√®gles + utilisateurs + audit.</p>
            </div>
            <span class="badge">Admin</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>R√®gles de recommandation</h3>
              Modifiable par responsable.</p>
              <div id="rulesEditor"></div>
              <div class="btnrow">
                <button class="btn primary" onclick="saveRulesFromUI()">Enregistrer r√®gles</button>
                <button class="btn" onclick="resetRules()">R√©initialiser r√®gles</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="q" id="battAdminBox">
              <h3>Base accus & chargeurs</h3>
              <p class="muted">Catalogue local, responsable uniquement. Valeurs CDR indicatives, v√©rifier fiche constructeur.</p>

              <div class="two">
                <div>
                  <label>Vmin (pire cas)</label>
                  <input id="adminBattMin" type="number" min="2.8" max="3.4" step="0.05" />
                </div>
                <div>
                  <label>Marge s√©curit√© (ex: 0.8)</label>
                  <input id="adminBattMargin" type="number" min="0.5" max="1" step="0.05" />
                </div>
              </div>
              <div class="btnrow">
                <button class="btn" id="saveBattSettingsBtn">Sauver param√®tres</button>
                <button class="btn" id="exportBattCsvBtn">Exporter Accus CSV</button>
                <button class="btn" id="exportChargerCsvBtn">Exporter Chargeurs CSV</button>
              </div>

              <div class="hr"></div>
              <h4>Accus</h4>
              <div class="two">
                <div>
                  <label>Marque</label><input id="battBrand" type="text" placeholder="Ex: Molicel" />
                  <label>Mod√®le</label><input id="battModel" type="text" placeholder="Ex: P26A" />
                </div>
                <div>
                  <label>Format</label><input id="battSize" type="text" placeholder="18650 / 21700" />
                  <label>Chimie</label><input id="battChem" type="text" placeholder="INR/IMR..." />
                </div>
              </div>
              <div class="two" style="margin-top:10px">
                <div><label>CDR (A)</label><input id="battCdr" type="number" min="5" max="50" step="1" /></div>
                <div><label>Capacit√© (mAh)</label><input id="battCapacity" type="number" min="1000" max="6000" step="50" /></div>
              </div>
              <div style="margin-top:10px">
                <label>Notes</label><input id="battNotes" type="text" placeholder="Ex: privil√©gier vendeur officiel" />
              </div>
              <label class="checkbox" style="margin-top:8px"><input type="checkbox" id="battTrusted" checked /> <span>Source fiable (authentique)</span></label>
              <div class="btnrow">
                <button class="btn primary" id="addBattBtn">Ajouter/mettre √† jour</button>
              </div>
              <div id="battCatalogList" class="list"></div>

              <div class="hr"></div>
              <h4>Chargeurs / adaptateurs</h4>
              <div class="two">
                <div>
                  <label>Marque</label><input id="chargerBrand" type="text" placeholder="Ex: Nitecore" />
                  <label>Mod√®le</label><input id="chargerModel" type="text" placeholder="Ex: i4" />
                </div>
                <div>
                  <label>Slots</label><input id="chargerSlots" type="number" min="1" max="8" step="1" />
                  <label>Courant max (A)</label><input id="chargerCurrent" type="number" min="0.5" max="4" step="0.1" />
                </div>
              </div>
              <div style="margin-top:10px">
                <label>Notes</label><input id="chargerNotes" type="text" placeholder="Ex: privil√©gier 0.5‚Äì1A" />
              </div>
              <div class="btnrow">
                <button class="btn primary" id="addChargerBtn">Ajouter/mettre √† jour</button>
              </div>
              <div id="chargerCatalogList" class="list"></div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Utilisateurs & Audit</h2>
              <p>Ajouter vendeurs / export journal.</p>
            </div>
            <span class="badge">S√©curit√©</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Gestion utilisateurs</h3>
              <div id="usersList" class="list"></div>

              <div class="hr"></div>

              <h3>Ajouter un utilisateur</h3>
              <div class="two">
                <div>
                  <label>Nom</label>
                  <input id="newUserName" type="text" placeholder="Ex: Marie" />
                </div>
                <div>
                  <label>PIN (4 chiffres mini)</label>
                  <input id="newUserPin" type="password" inputmode="numeric" placeholder="Ex: 3344" />
                </div>
              </div>
              <div class="two" style="margin-top:10px">
                <div>
                  <label>R√¥le</label>
                  <select id="newUserRole">
                    <option value="seller">Vendeur</option>
                    <option value="manager">Responsable</option>
                  </select>
                </div>
                <div>
                  <label>Identifiant (auto)</label>
                  <input id="newUserId" type="text" placeholder="auto" disabled />
                </div>
              </div>
              <div class="btnrow">
                <button class="btn primary" onclick="addUser()">Ajouter</button>
              </div>
            </div>

            <div class="q" style="margin-top:12px">
              <h3>Audit (journal d‚Äôutilisation)</h3>
              Filtrable + export.</p>
              <div class="two">
                <div>
                  <label>Filtrer</label>
                  <input id="auditFilter" type="text" placeholder="Ex: Evan, FICHE, NOTE..." />
                </div>
                <div>
                  <label>Limiter (lignes)</label>
                  <select id="auditLimit">
                    <option value="50">50</option>
                    <option value="200" selected>200</option>
                    <option value="500">500</option>
                    <option value="2000">2000</option>
                  </select>
                </div>
              </div>
              <div class="btnrow">
                <button class="btn" onclick="renderAudit()">Appliquer</button>
                <button class="btn primary" onclick="exportAuditJSON()">Exporter JSON</button>
                <button class="btn" onclick="exportAuditCSV()">Exporter CSV</button>
                <button class="btn danger" onclick="clearAudit()">Vider audit</button>
              </div>
              <div class="hr"></div>
              <div id="auditList" class="list"></div>
            </div>

          </div>
        </section>
      </div>
    </div>

  </main>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastT">‚Äî</div>
  <div class="s" id="toastS">‚Äî</div>
</div>

<!-- AUTH MODAL -->
<div class="modal" id="authModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Connexion vendeur (PIN)</h3>
      <button class="xbtn" onclick="closeAuthModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">S√©lectionne ton nom puis entre ton PIN.</p>
      <label>Utilisateur</label>
      <select id="authUserSelect"></select>

      <div style="margin-top:10px">
        <label>PIN</label>
        <input type="password" id="authPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" />
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn primary" onclick="login()">Se connecter</button>
        <button class="btn" onclick="logout()">D√©connexion</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="modal" id="importModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Importer un √©tat complet</h3>
      <button class="xbtn" onclick="closeImportModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">Responsable uniquement. Colle le JSON export√©.</p>
      <textarea id="importText" placeholder="{...}"></textarea>
      <div class="btnrow" style="margin-top:10px">
        <button class="btn primary" onclick="importState()">Importer</button>
      </div>
    </div>
  </div>
</div>

<!-- SAV MODAL (PRINTABLE FORM) -->
<div class="modal" id="savModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Fiche SAV imprimable</h3>
      <button class="xbtn" onclick="closeSavModal()">Fermer</button>
    </div>
    <div class="modal-b" id="savForm"></div>
  </div>
</div>

<script>
/* =========================
   STOOM ‚Ä¢ Tablette PRO (v2)
   - PIN / r√¥les
   - export/import BLOQU√âS vendeurs
   - audit complet: responsable seulement
   - SAV: fiche imprimable A4 accept/refus + raisons
   ========================= */

const LS = { state: "stoom_tablette_v2_state" };

const DEFAULT_STATE = {
  settings: { shopName: "STOOM Clermont-Ferrand", maskPhones: true },
  users: [
    { id:"arnaud", name:"Arnaud", pin:"1007", role:"manager" },
    { id:"evan",   name:"Evan",   pin:"1517", role:"seller"  },
    { id:"lea",    name:"L√©a",    pin:"2109", role:"seller"  },
  ],
  currentUser: null,
  view: "home",
  notesTab: "notes",
  audit: [],
  notes: [],
  followups: [],
  battSettings: { battMinV: 3.2, safetyMargin: 0.8 },
  batt: { boxType:"dual", powerW:60, resistance:0.18, battMinV:3.2, safetyMargin:0.8, lastResult:null },
  batteriesCatalog: [
    { id:"molicel-p26a", brand:"Molicel", model:"P26A", size:"18650", chemistry:"INR", cdrA:25, capacitymAh:2600, notes:"Bon compromis, courant √©lev√©", trusted:true },
    { id:"molicel-p28a", brand:"Molicel", model:"P28A", size:"18650", chemistry:"INR", cdrA:25, capacitymAh:2800, notes:"Polyvalent, v√©rifier authenticit√©", trusted:true },
    { id:"sony-vtc5a", brand:"Sony/Murata", model:"VTC5A", size:"18650", chemistry:"INR", cdrA:25, capacitymAh:2600, notes:"R√©f√©rence courant fort", trusted:true },
    { id:"samsung-25r", brand:"Samsung", model:"25R", size:"18650", chemistry:"INR", cdrA:20, capacitymAh:2500, notes:"Classique robuste", trusted:true },
    { id:"samsung-30q", brand:"Samsung", model:"30Q", size:"18650", chemistry:"INR", cdrA:15, capacitymAh:3000, notes:"Usage mod√©r√© <50W", trusted:true },
    { id:"molicel-p42a", brand:"Molicel", model:"P42A", size:"21700", chemistry:"INR", cdrA:30, capacitymAh:4200, notes:"Tr√®s bon courant + autonomie", trusted:true },
    { id:"samsung-40t", brand:"Samsung", model:"40T", size:"21700", chemistry:"INR", cdrA:30, capacitymAh:4000, notes:"Rester raisonnable <30A", trusted:true },
    { id:"sony-vtc6a", brand:"Sony/Murata", model:"VTC6A", size:"21700", chemistry:"INR", cdrA:25, capacitymAh:4100, notes:"Capacit√© √©lev√©e, courant correct", trusted:true },
    { id:"rewrap-generic", brand:"Rewrap", model:"40A marketing", size:"18650", chemistry:"?", cdrA:10, capacitymAh:2000, notes:"Donn√©es marketing douteuses", trusted:false }
  ],
  chargersCatalog: [
    { id:"nitecore-i2", brand:"Nitecore", model:"i2", slots:2, maxCurrentA:1, usbInput:"5V", notes:"Charge douce s√©curitaire" },
    { id:"nitecore-i4", brand:"Nitecore", model:"i4", slots:4, maxCurrentA:1, usbInput:"5V", notes:"4 slots pratique, rester √† 1A" },
    { id:"xtar-vc2s", brand:"XTAR", model:"VC2S", slots:2, maxCurrentA:2, usbInput:"5V", notes:"Pr√©f√©rer 0.5‚Äì1A par prudence" },
    { id:"xtar-x4", brand:"XTAR", model:"X4", slots:4, maxCurrentA:2, usbInput:"5V", notes:"Mode 1A conseill√©" },
    { id:"liitokala-lii500", brand:"LiitoKala", model:"Lii-500", slots:4, maxCurrentA:1, usbInput:"5V", notes:"Polyvalent, rester 0.5‚Äì1A" }
  ],
  sav: {
    symptom: null,
    vendorProblem: "",
    lastSavSheet: null,
    history: []   // ‚úÖ historique SAV
  },
  client: {
    step: 0,
    answers: { cigs:null, cigType:null, moments:null, goal:null, tried:null },
    sheet: null
  },
  rules: {
    byCigs: {
      "5-10":  { nicotine:"3‚Äì6 mg",        tirage:"MTL (serr√© √† semi-serr√©)", power:"Mod√©r√©e",  hardware:"Pod/kit MTL fiable" },
      "10-15": { nicotine:"6‚Äì12 mg",       tirage:"MTL (serr√©)",             power:"Mod√©r√©e",  hardware:"Pod/kit MTL fiable" },
      "15-20": { nicotine:"10 mg (sels)",  tirage:"MTL (serr√©, r√©gulier)",   power:"Faible (confort)", hardware:"Pod MTL / tirage serr√©" },
      "25+":   { nicotine:"20 mg (sels)",  tirage:"MTL (serr√©, r√©gulier)",   power:"Faible (confort)", hardware:"Pod MTL / tirage serr√©" }
    }
  }
};

const state = loadState();

/* ---------- Utils ---------- */
function $(q){ return document.querySelector(q); }
function $all(q){ return Array.from(document.querySelectorAll(q)); }
function safeJsonParse(str, fallback){ try{ return JSON.parse(str); }catch(e){ return fallback; } }
function deepMerge(target, src){
  if(!src || typeof src !== "object") return target;
  for(const k of Object.keys(src)){
    const v = src[k];
    if(Array.isArray(v)) target[k] = v;
    else if(v && typeof v === "object"){
      if(!target[k] || typeof target[k] !== "object") target[k] = {};
      deepMerge(target[k], v);
    } else target[k] = v;
  }
  return target;
}
function saveState(){
  localStorage.setItem(LS.state, JSON.stringify(state));
  refreshSidebarMini();
  refreshHomeLastSheet();
  refreshRulesSummary();
  renderAuditPeek();
  updateFollowUpAlerts();
}
function loadState(){
  const raw = localStorage.getItem(LS.state);
  if(!raw) return structuredClone(DEFAULT_STATE);
  const parsed = safeJsonParse(raw, null);
  if(!parsed) return structuredClone(DEFAULT_STATE);
  const s = structuredClone(DEFAULT_STATE);
  deepMerge(s, parsed);
  return s;
}
function ensureBattState(){
  if(!state.batt) state.batt = structuredClone(DEFAULT_STATE.batt);
  if(!state.battSettings) state.battSettings = structuredClone(DEFAULT_STATE.battSettings);
  if(!state.batteriesCatalog) state.batteriesCatalog = structuredClone(DEFAULT_STATE.batteriesCatalog);
  if(!state.chargersCatalog) state.chargersCatalog = structuredClone(DEFAULT_STATE.chargersCatalog);
}
function formatDateFR(d){
  try{ return new Intl.DateTimeFormat('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(d); }
  catch(e){ return d.toLocaleDateString('fr-FR'); }
}
function formatDateTimeFR(ts){
  const d = new Date(ts);
  try{
    return new Intl.DateTimeFormat('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
  }catch(e){ return d.toLocaleString('fr-FR'); }
}
function escapeHtml(s){
  const map = { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" };
  return String(s||"").replace(/[&<>"']/g, (m)=> map[m] || m);
}
function toast(t, s){
  const el = $("#toast");
  $("#toastT").textContent = t || "Info";
  $("#toastS").textContent = s || "";
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.classList.remove("show"), 3200);
}
function download(filename, text, type="application/json"){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function copyToClipboard(text){
  if(!text) return toast("Copie", "Rien √† copier.");
  navigator.clipboard?.writeText(text).then(
    ()=> toast("Copi√©", "Copi√©."),
    ()=> toast("Copie", "Impossible de copier.")
  );
}

/* ---------- Auth + Audit ---------- */
function isManager(){ return state.currentUser?.role === "manager"; }
function requireAuth(){
  if(!state.currentUser){
    openAuthModal(true);
    toast("Connexion requise", "S√©lectionne ton nom et entre ton PIN.");
    return false;
  }
  return true;
}
function audit(action, detail){
  const who = state.currentUser?.name || "INCONNU";
  state.audit.push({ who, role: state.currentUser?.role || "none", action, detail: detail||"", ts: Date.now() });
  if(state.audit.length > 2000) state.audit.shift();
  saveState();
}

/* ---------- Navigation ---------- */
function go(view){
  const requestedView = view;
  if(view === "followup"){
    state.notesTab = "followups";
    view = "notes";
  }
  if(!requireAuth()) return;
  if(view === "manager" && !isManager()){
    toast("Acc√®s refus√©", "R√©serv√© aux responsables.");
    audit("DENY_MANAGER_VIEW", "");
    return;
  }
  state.view = view;
  $all(".view").forEach(v => v.style.display = "none");
  $("#view-"+view).style.display = "block";
  $all(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.view === view || (requestedView === "followup" && b.dataset.view === "followup")));

  if(view === "client") renderClient();
  if(view === "sav") renderSav();
  if(view === "sav") { renderSav(); renderSavHistory(); }
  if(view === "sav") setTimeout(renderSavHistory, 0);
  if(view === "notes") renderNotes();
  if(view === "batt") renderBattView();
  if(view === "manager") { renderRulesEditor(); renderUsers(); renderAudit(); renderBatteryAdmin(); }

  audit("NAVIGATE", requestedView);
  saveState();
}
function bindNav(){
  $("#nav").addEventListener("click", (e)=>{
    const btn = e.target.closest(".navbtn");
    if(!btn) return;
    if(btn.dataset.view === "notes") state.notesTab = "notes";
    if(btn.dataset.view === "followup") state.notesTab = "followups";
    go(btn.dataset.view);
  });
}

/* ---------- Auth Modal ---------- */
function openAuthModal(force=false){
  const sel = $("#authUserSelect");
  sel.innerHTML = state.users
    .slice().sort((a,b)=> a.name.localeCompare(b.name,'fr'))
    .map(u=>`<option value="${u.id}">${escapeHtml(u.name)} (${u.role==="manager"?"responsable":"vendeur"})</option>`)
    .join("");
  $("#authPin").value = "";
  $("#authModal").classList.add("show");
  setTimeout(()=> $("#authPin").focus(), 50);
}
function closeAuthModal(){
  if(!state.currentUser){
    toast("Connexion", "Connexion obligatoire.");
    return;
  }
  $("#authModal").classList.remove("show");
}
function refreshAuthUI(){
  const dot = $("#authDot");
  const label = $("#authLabel");
  if(state.currentUser){
    dot.classList.add("ok");
    label.textContent = state.currentUser.name;
    $("#logoutBtn").style.display = "inline-flex";
    $("#managerNav").style.display = isManager() ? "flex" : "none";
    $("#goManagerBtn").style.display = isManager() ? "inline-flex" : "none";
    $("#toggleMaskBtn").style.display = isManager() ? "inline-flex" : "none";
  } else {
    dot.classList.remove("ok");
    label.textContent = "Non connect√©";
    $("#logoutBtn").style.display = "none";
    $("#managerNav").style.display = "none";
    $("#goManagerBtn").style.display = "none";
    $("#toggleMaskBtn").style.display = "none";
  }
  const expFollow = $("#exportFollowupsBtn");
  const clrFollow = $("#clearFollowupsBtn");
  [expFollow, clrFollow].forEach(btn=>{
    if(!btn) return;
    const can = !!state.currentUser && isManager();
    btn.disabled = !can;
    btn.title = can ? "" : "Responsable uniquement";
  });
  refreshSidebarMini();
  updateAdminButtonsLock();
}
function login(){
  const userId = $("#authUserSelect").value;
  const pin = ($("#authPin").value || "").trim();
  const user = state.users.find(u=>u.id===userId);
  if(!user){ toast("Erreur", "Utilisateur introuvable."); return; }
  if(!pin || pin !== user.pin){
    toast("PIN incorrect", "R√©essaie.");
    audit("LOGIN_FAIL", userId);
    return;
  }
  state.currentUser = { id:user.id, name:user.name, role:user.role };
  $("#authModal").classList.remove("show");
  audit("LOGIN_OK", user.name);
  refreshAuthUI();
  saveState();
}
function logout(){
  if(state.currentUser) audit("LOGOUT", state.currentUser.name);
  state.currentUser = null;
  saveState();
  refreshAuthUI();
  openAuthModal(true);
}

/* ---------- BLOCK Export/Import/Reset for sellers ---------- */
function updateAdminButtonsLock(){
  const exp = $("#exportStateBtn");
  const imp = $("#importStateBtn");
  const res = $("#resetBtn");

  const can = !!state.currentUser && isManager();
  exp.disabled = !can;
  imp.disabled = !can;
  res.disabled = !can;

  exp.title = can ? "" : "R√©serv√© responsable";
  imp.title = can ? "" : "R√©serv√© responsable";
  res.title = can ? "" : "R√©serv√© responsable";
}

function exportFullState(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "Export r√©serv√© aux responsables.");
    audit("DENY_EXPORT_STATE", "");
    return;
  }
  const payload = { exportedAt: new Date().toISOString(), state };
  download(`stoom-export-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
  audit("EXPORT_STATE", "");
}
function openImportModal(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "Import r√©serv√© aux responsables.");
    audit("DENY_IMPORT", "");
    return;
  }
  $("#importText").value = "";
  $("#importModal").classList.add("show");
}
function closeImportModal(){ $("#importModal").classList.remove("show"); }
function importState(){
  if(!isManager()){ toast("Acc√®s refus√©", "R√©serv√© aux responsables."); return; }
  const payload = safeJsonParse($("#importText").value||"", null);
  if(!payload?.state){ toast("Import", "JSON invalide."); return; }
  const fresh = structuredClone(DEFAULT_STATE);
  deepMerge(fresh, payload.state);
  fresh.currentUser = null;

  for(const k of Object.keys(state)) delete state[k];
  Object.assign(state, fresh);

  saveState();
  closeImportModal();
  toast("Import OK", "Donn√©es import√©es. Reconnexion requise.");
  openAuthModal(true);
}
function clearAll(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "R√©initialisation r√©serv√©e aux responsables.");
    audit("DENY_RESET", "");
    return;
  }
  if(!confirm("R√©initialiser TOUT sur cet appareil ?")) return;
  localStorage.removeItem(LS.state);
  location.reload();
}

/* ---------- Search ---------- */
function runSearch(q){
  const query = (q||"").toLowerCase().trim();
  if(!query){ toast("Recherche", "Tape un mot-cl√©."); return; }
  const hitSav = ["fuite","glouglou","br√ªl√©","brule","toux","gorge","panne","charge"].some(k=> query.includes(k));
  const hitClient = ["nicotine","sel","mtl","rdl","dl","0mg","dosage","tirage","puissance"].some(k=> query.includes(k));
  const hitManager = ["audit","r√®gle","regle","users","utilisateur","pin","export"].some(k=> query.includes(k));

  if(hitSav){ go("sav"); toast("Recherche", "SAV ouvert."); return; }
  if(hitClient){ go("client"); toast("Recherche", "Parcours client ouvert."); return; }
  if(hitManager){ isManager() ? go("manager") : toast("Recherche", "Admin r√©serv√© responsable."); return; }
  toast("Recherche", "Aucun raccourci. Essaye: fuite, br√ªl√©, sel, MTL, audit‚Ä¶");
}

/* ---------- Client Wizard ---------- */
const clientSteps = [
  { key:"cigs", label:"Conso", desc:"cig/j" },
  { key:"cigType", label:"Cigarette", desc:"type" },
  { key:"moments", label:"Moment", desc:"d√©clencheur" },
  { key:"goal", label:"Objectif", desc:"intention" },
  { key:"tried", label:"Exp√©rience", desc:"d√©j√† essay√©" },
];

const clientQuestions = [
  { key:"cigs", title:"Combien de cigarettes par jour ?", subtitle:"On choisit d‚Äôabord un taux coh√©rent (stabilit√©).", cols:"cols4",
    choices:[
      {v:"5-10", t:"5‚Äì10 /j", s:"Souvent 3 ou 6 mg"},
      {v:"10-15", t:"10‚Äì15 /j", s:"Souvent 6 ou 12 mg"},
      {v:"15-20", t:"15‚Äì20 /j", s:"Souvent 10 mg sel"},
      {v:"25+", t:"25+ /j", s:"Souvent 20 mg sel"},
    ]},
  { key:"cigType", title:"Type de cigarette ?", subtitle:"√áa aide √† choisir sensations & saveurs.", cols:"cols3",
    choices:[
      {v:"blonde", t:"Blonde", s:"Classique / light"},
      {v:"menthol", t:"Menthol", s:"Fra√Æcheur douce"},
      {v:"roulee", t:"Roul√©e", s:"Plus aromatique / puissant"},
    ]},
  { key:"moments", title:"Moment difficile principal ?", subtitle:"On s√©curise ce moment en priorit√©.", cols:"cols3",
    choices:[
      {v:"stress", t:"Stress", s:"Nerfs / pression"},
      {v:"cafe", t:"Caf√©", s:"Habitude ancr√©e"},
      {v:"soir", t:"Soir", s:"D√©tente"},
      {v:"journee", t:"Journ√©e", s:"Usage fr√©quent"},
      {v:"apresRepas", t:"Apr√®s repas", s:"Rituel"},
      {v:"matin", t:"Matin", s:"Dmarrage"},
    ]},
  { key:"goal", title:"Objectif du client ?", subtitle:"L‚Äôobjectif n¬∞1 = √©viter la rechute.", cols:"cols3",
    choices:[
      {v:"arreter", t:"Arr√™ter", s:"Objectif clair"},
      {v:"reduire", t:"R√©duire", s:"√âtape"},
      {v:"remplacer", t:"Remplacer", s:"Sans pression"},
    ]},
  { key:"tried", title:"D√©j√† essay√© la vape ?", subtitle:"On corrige ce qui a bloqu√©.", cols:"cols3",
    choices:[
      {v:"non", t:"Non", s:"D√©couverte"},
      {v:"echec", t:"Oui (√©chec)", s:"On s√©curise"},
      {v:"ok", t:"Oui (√ßa marchait)", s:"On r√©plique"},
    ]},
];

function clientReset(){
  if(!requireAuth()) return;
  state.client.step = 0;
  state.client.answers = { cigs:null, cigType:null, moments:null, goal:null, tried:null };
  state.client.sheet = null;
  audit("CLIENT_RESET", "");
  saveState();
  renderClient();
}

function setAnswer(key, value){
  state.client.answers[key] = value;
  audit("CLIENT_ANSWER", `${key}=${value}`);
  saveState();
  setTimeout(()=> nextClient(), 60);
}
function prevClient(){
  state.client.step = Math.max(0, state.client.step - 1);
  audit("CLIENT_PREV", String(state.client.step));
  saveState();
  renderClient();
}
function nextClient(){
  const q = clientQuestions[state.client.step];
  if(!state.client.answers[q.key]){
    toast("R√©ponse manquante", "Choisis une option.");
    return;
  }
  if(state.client.step < clientQuestions.length-1){
    state.client.step += 1;
    audit("CLIENT_NEXT", String(state.client.step));
    saveState();
    renderClient();
  } else {
    state.client.sheet = buildSheet(state.client.answers);
    audit("SHEET_GENERATED", JSON.stringify(state.client.answers));
    saveState();
    renderSheet();
  }
}

function renderClientSteps(){
  const el = $("#clientSteps");
  el.innerHTML = "";
  clientSteps.forEach((s, i)=>{
    const div = document.createElement("div");
    div.className = "step";
    if(i === state.client.step) div.classList.add("active");
    if(state.client.answers[s.key]) div.classList.add("done");
    div.innerHTML = `<span>${i+1}. ${escapeHtml(s.label)}</span><span class="small mono">${escapeHtml(s.desc)}</span>`;
    div.onclick = ()=> { state.client.step = i; audit("CLIENT_GOTO_STEP", String(i)); saveState(); renderClient(); };
    el.appendChild(div);
  });
}
function renderClientQuestion(){
  const box = $("#clientQuestionBox");
  const q = clientQuestions[state.client.step];
  const current = state.client.answers[q.key];
  box.innerHTML = `
    <h3>${escapeHtml(q.title)}</h3>
    <p class="muted">${escapeHtml(q.subtitle)}</p>
    <div class="choices ${q.cols||""}" id="qChoices"></div>
  `;
  const ch = $("#qChoices");
  q.choices.forEach((c)=>{
    const d = document.createElement("div");
    d.className = "choice" + (current === c.v ? " selected":"");
    d.innerHTML = `<div class="ct">${escapeHtml(c.t)}</div><div class="cs">${escapeHtml(c.s||"")}</div>`;
    d.onclick = ()=> setAnswer(q.key, c.v);
    ch.appendChild(d);
  });
}
function renderClient(){
  renderClientSteps();
  renderClientQuestion();
  $("#clientPrev").onclick = prevClient;
  $("#clientNext").onclick = nextClient;
  $("#clientPrev").disabled = state.client.step === 0;
  renderSheet();
}

function calcFlavorHint(a){
  if(a.cigType === "blonde") return "Classiques (blond) ou l√©g√®rement gourmands";
  if(a.cigType === "menthol") return "Menthol doux / frais";
  if(a.cigType === "roulee") return "Classiques plus aromatiques (puissants)";
  return "Saveurs au choix";
}
function calcMomentTip(a){
  const m = a.moments;
  if(m === "stress") return "Stress : tirage stable + dosage coh√©rent pour √©viter la frustration.";
  if(m === "cafe") return "Caf√© : routine simple (m√™me liquide / m√™me tirage) pour remplacer le rituel.";
  if(m === "soir") return "Soir : garder le confort (ne pas baisser trop vite).";
  if(m === "journee") return "Journ√©e : autonomie + fiabilit√© + simplicit√©.";
  if(m === "apresRepas") return "Apr√®s repas : setup pr√™t, simple, toujours dispo.";
  if(m === "matin") return "Matin : dosage suffisant (sinon manque imm√©diat).";
  return "S√©curiser les moments cl√©s avec le bon dosage.";
}
function calcReassurance(a){
  if(a.tried === "echec") return "Si √ßa a d√©j√† √©chou√©, c‚Äôest souvent un mauvais couple taux/mat√©riel. On s√©curise.";
  if(a.tried === "ok") return "Si √ßa marchait, on r√©plique ce qui √©tait confortable et stable.";
  return "On ajuste si besoin, sans se pr√©cipiter.";
}
function buildSheet(a){
  const rule = state.rules.byCigs[a.cigs] || { nicotine:"‚Äî", tirage:"MTL", power:"‚Äî", hardware:"‚Äî" };

  const nicotine = rule.nicotine;
  const tirage = rule.tirage;
  const power = rule.power;
  const hardware = rule.hardware;

  const flavor = calcFlavorHint(a);
  const reassurance = calcReassurance(a);
  const momentTip = calcMomentTip(a);

  const addons = ["R√©sistance/cartouche de secours", "R√©glage puissance (confort)", "Rappel : baisser la nicotine quand c‚Äôest stable"];

  const goalLine =
    a.goal === "arreter" ? "viser d‚Äôabord z√©ro cigarette" :
    a.goal === "reduire" ? "s√©curiser le quotidien puis r√©duire doucement" :
    "remplacer sans pression (confort)";

 const salesLine = `‚ÄúJe vous propose ${tirage} avec ${nicotine}. L‚Äôobjectif, c‚Äôest de ${goalLine}. Pour l'instant il s'agit d'une phase de test, je vous propose de prendre un rendez-vous telephonique dans une semaine afin de verifier que tout se passe bien, ce service est gratuit.‚Äù`;

  return {
    title: "Recommandation STOOM (profil client)",
    tirage, nicotine, power, hardware,
    explain: `${reassurance} ${momentTip} Suggestion saveurs : ${flavor}.`,
    addons,
    salesLine
  };
}

function renderSheet(){
  const box = $("#sheetBox");
  if(!state.client.sheet){
    box.innerHTML = `<h3>En attente‚Ä¶</h3><p class="muted">R√©ponds aux questions pour g√©n√©rer la fiche.</p>`;
    $("#salesLine").textContent = "‚Äî";
    refreshSidebarMini();
    refreshHomeLastSheet();
    return;
  }
  const sh = state.client.sheet;
  box.innerHTML = `
    <h3>${escapeHtml(sh.title)}</h3>
    <div class="chips" style="margin:8px 0 10px">
      <span class="chip"><b>Tirage</b> ${escapeHtml(sh.tirage)}</span>
      <span class="chip"><b>Nicotine</b> ${escapeHtml(sh.nicotine)}</span>
      <span class="chip"><b>Puissance</b> ${escapeHtml(sh.power)}</span>
      <span class="chip"><b>Mat√©riel</b> ${escapeHtml(sh.hardware)}</span>
    </div>
    <p class="muted">${escapeHtml(sh.explain)}</p>
    <div class="hr"></div>
    <div class="chips">
      ${sh.addons.map(a=>`<span class="chip"><b>+</b> ${escapeHtml(a)}</span>`).join("")}
    </div>
    <p class="small" style="margin-top:10px">Boutique : <span class="mono">${escapeHtml(state.settings.shopName)}</span> ‚Ä¢ ${escapeHtml(formatDateFR(new Date()))}</p>
  `;
  $("#salesLine").textContent = sh.salesLine;
  refreshSidebarMini();
  refreshHomeLastSheet();
}

function copySalesLine(){
  const line = $("#salesLine").textContent;
  if(!line || line === "‚Äî") return toast("Copie", "Aucune phrase.");
  copyToClipboard(line);
  audit("COPY_SALESLINE", "");
}

function printSheet(){
  if(!requireAuth()) return;
  if(!state.client.sheet){ toast("Impression", "Aucune fiche."); return; }

  audit("PRINT_SHEET", "");
  const sh = state.client.sheet;
  const a = state.client.answers;

  const html =
`<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fiche STOOM</title>
<style>
  body{font-family: Arial, sans-serif; padding:24px; color:#0b1220}
  h1{margin:0 0 6px; font-size:18px}
  .sub{color:#334155; margin:0 0 16px; font-size:12px}
  .card{border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin:12px 0}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:12px}
  .muted{color:#475569; font-size:12px; line-height:1.45}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .hr{height:1px; background:#e2e8f0; margin:12px 0}
</style></head><body>
<h1>${escapeHtml(state.settings.shopName)} ‚Ä¢ Fiche recommandation</h1>
<p class="sub">G√©n√©r√© le ${escapeHtml(formatDateFR(new Date()))}</p>

<div class="card">
  <div class="chips">
    <span class="chip"><b>Tirage</b> ${escapeHtml(sh.tirage)}</span>
    <span class="chip"><b>Nicotine</b> ${escapeHtml(sh.nicotine)}</span>
    <span class="chip"><b>Puissance</b> ${escapeHtml(sh.power)}</span>
    <span class="chip"><b>Mat√©riel</b> ${escapeHtml(sh.hardware)}</span>
  </div>
  <p class="muted">${escapeHtml(sh.explain)}</p>
  <div class="hr"></div>
  <div class="chips">
    ${sh.addons.map(a=>`<span class="chip"><b>+</b> ${escapeHtml(a)}</span>`).join("")}
  </div>
</div>

<div class="card">
  <h3>Phrase pr√™te</h3>
  <p class="muted mono">${escapeHtml(sh.salesLine)}</p>
</div>

<div class="card">
  <h3>Profil client</h3>
  <p class="muted">
    Cigs/j: ${escapeHtml(a.cigs||"‚Äî")} ‚Ä¢ Type: ${escapeHtml(a.cigType||"‚Äî")} ‚Ä¢ Moment: ${escapeHtml(a.moments||"‚Äî")} ‚Ä¢ Objectif: ${escapeHtml(a.goal||"‚Äî")} ‚Ä¢ Exp√©rience: ${escapeHtml(a.tried||"‚Äî")}
  </p>
</div>
</body></html>`;

  const w = window.open("", "sheetPrint");
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

/* ---------- SAV ---------- */
const SAV_CHOICES = [
  { key:"leak",   label:"Fuite / glouglou", tips:["V√©rifier joint, airflow ouvert ?", "R√©sistance trop vieille ?", "Liquide trop fluide / pod satur√© ?"] },
  { key:"burnt",  label:"Go√ªt br√ªl√©",       tips:["R√©sistance neuve amorc√©e ?", "Puissance trop haute ?", "Airflow trop ferm√© ?"] },
  { key:"weak",   label:"Peu de vapeur",    tips:["Airflow trop ferm√© ?", "Puissance trop basse ?", "R√©sistance en fin de vie ?"] },
  { key:"hit",    label:"Hit trop fort",    tips:["Baisser nicotine ?", "Changer ratio PG/VG ?", "Airflow + ouvert / baisser puissance"] },
  { key:"charge", label:"Probl√®me charge",  tips:["C√¢ble/port OK ?", "Nettoyer port ?", "Changer adaptateur 5V/2A ?"] },
  { key:"other",  label:"Autre",            tips:["Pr√©ciser le sympt√¥me", "Tester une autre cartouche/r√©sistance", "Tester autre liquide"] },
];

function renderSav(){
  const box = $("#savChoices");
  box.innerHTML = SAV_CHOICES.map(c=>`
    <div class="choice" onclick="selectSav('${c.key}')">
      <div class="ct">${escapeHtml(c.label)}</div>
      <div class="cs">${escapeHtml(c.tips.join(" ‚Ä¢ "))}</div>
    </div>
  `).join("");
  renderSavResult();
}

function selectSav(key){
  state.sav.symptom = key;
  renderSavResult();
  saveState();
  audit("SAV_SELECT", key);
}

function renderSavResult(){
  const box = $("#savResult");
  if(!state.sav.symptom){
    box.innerHTML = `<h3>En attente‚Ä¶</h3> S√©lectionne un sympt√¥me.</p>`;
    return;
  }
  const c = SAV_CHOICES.find(x=>x.key===state.sav.symptom);
  const tips = c?.tips || [];
  box.innerHTML = `
    <h3>${escapeHtml(c.label)}</h3>
    <div class="chips">${tips.map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}</div>
  `;
}

function openSavForm(){
  if(!requireAuth()) return;
  if(!state.sav.symptom){ toast("SAV", "Choisis un sympt√¥me."); return; }
  const c = SAV_CHOICES.find(x=>x.key===state.sav.symptom);
  const problem = state.sav.vendorProblem || "";
  const now = formatDateFR(new Date());

  $("#savForm").innerHTML = `
    <p class="muted">Impression directe. Conserver une copie dans le colis fournisseur.</p>
    <div class="two">
      <div><label>Produit</label><input id="savProduct" type="text" placeholder="Ex: XROS 3 / Zlide..." /></div>
      <div><label>Num√©ro de s√©rie (si dispo)</label><input id="savSerial" type="text" placeholder="SN..." /></div>
    </div>
    <div class="two" style="margin-top:10px">
      <div><label>Client</label><input id="savClient" type="text" placeholder="Nom client" /></div>
      <div><label>Contact</label><input id="savContact" type="text" placeholder="Tel ou email (optionnel)" /></div>
    </div>
    <div style="margin-top:10px">
      <label>Probl√®me (vendeur)</label>
      <textarea id="savProblem">${escapeHtml(problem)}</textarea>
    </div>
    <div style="margin-top:10px">
      <label>Actions faites en boutique</label>
      <textarea id="savActions" placeholder="Test c√¢ble, changement r√©sistance, nettoyage..."></textarea>
    </div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn primary" onclick="printSav()">Imprimer fiche SAV</button>
      <button class="btn" onclick="closeSavModal()">Fermer</button>
    </div>
    <p class="small" style="margin-top:8px">Date: ${escapeHtml(now)} ‚Ä¢ Symptom: ${escapeHtml(c.label)}</p>
  `;
  $("#savModal").classList.add("show");
}

function closeSavModal(){ $("#savModal").classList.remove("show"); }

function printSav(){
  const product = ($("#savProduct").value||"").trim();
  const serial = ($("#savSerial").value||"").trim();
  const client = ($("#savClient").value||"").trim();
  const contact = ($("#savContact").value||"").trim();
  const problem = ($("#savProblem").value||"").trim();
  const actions = ($("#savActions").value||"").trim();

  const now = new Date();
  const html = `
  <!doctype html><html><head><meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fiche SAV</title>
  <style>
    body{font-family: Arial, sans-serif; padding:24px; color:#0b1220}
    h1{margin:0 0 6px; font-size:18px}
    .sub{color:#334155; margin:0 0 12px; font-size:12px}
    .card{border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin:12px 0}
    .muted{color:#475569; font-size:12px; line-height:1.45}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:12px}
  </style></head><body>
  <h1>STOOM ‚Ä¢ Fiche SAV</h1>
  <p class="sub">Imprim√© le ${escapeHtml(formatDateTimeFR(now))}</p>

  <div class="card">
    <p class="muted"><b>Produit:</b> ${escapeHtml(product||"‚Äî")} ‚Ä¢ <b>SN:</b> ${escapeHtml(serial||"‚Äî")}</p>
    <p class="muted"><b>Client:</b> ${escapeHtml(client||"‚Äî")} ‚Ä¢ <b>Contact:</b> ${escapeHtml(contact||"‚Äî")}</p>
    <p class="muted"><b>Sympt√¥me:</b> ${escapeHtml(SAV_CHOICES.find(x=>x.key===state.sav.symptom)?.label || "‚Äî")}</p>
    <p class="muted"><b>Probl√®me vendeur:</b><br/>${escapeHtml(problem||"‚Äî")}</p>
    <p class="muted"><b>Actions boutique:</b><br/>${escapeHtml(actions||"‚Äî")}</p>
  </div>
  </body></html>
  `;

  const w = window.open("", "savPrint");
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();

  state.sav.lastSavSheet = {
    ts: Date.now(),
    product, serial, client, contact,
    symptom: state.sav.symptom,
    problem, actions
  };
  state.sav.history.push({ ...state.sav.lastSavSheet });
  if(state.sav.history.length > 400) state.sav.history.shift();
  audit("SAV_PRINT", state.sav.symptom);
  saveState();
  renderSavHistory();
  closeSavModal();
}

function clearSavProblem(){
  state.sav.vendorProblem = "";
  $("#savVendorProblem").value = "";
  saveState();
}
function closeSavModal(){ $("#savModal").classList.remove("show"); }

function renderSavHistory(filter=""){
  const box = $("#savHistoryList");
  const query = (filter || $("#savHistoryFilter").value || "").toLowerCase();
  let rows = state.sav.history.slice().reverse();
  if(query){
    rows = rows.filter(r=>
      (r.product||"").toLowerCase().includes(query) ||
      (r.symptom||"").toLowerCase().includes(query) ||
      (r.problem||"").toLowerCase().includes(query) ||
      (r.actions||"").toLowerCase().includes(query) ||
      (r.client||"").toLowerCase().includes(query)
    );
  }
  if(rows.length === 0){
    box.innerHTML = `<div class="small">Aucun SAV enregistr√©.</div>`;
    return;
  }
  box.innerHTML = rows.map(r=>{
    const symLabel = SAV_CHOICES.find(x=>x.key===r.symptom)?.label || r.symptom;
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(r.product||"‚Äî")}</strong>
          <span>${escapeHtml(formatDateTimeFR(r.ts))}</span>
        </div>
        <p class="small">Sympt√¥me: ${escapeHtml(symLabel||"‚Äî")} ‚Ä¢ Client: ${escapeHtml(r.client||"‚Äî")} ‚Ä¢ Contact: ${escapeHtml(r.contact||"‚Äî")}</p>
        <p class="small">Probl√®me: ${escapeHtml(r.problem||"‚Äî")}</p>
        <p class="small">Actions: ${escapeHtml(r.actions||"‚Äî")}</p>
      </div>
    `;
  }).join("");
}

function exportSavHistoryCSV(){
  if(!isManager()) return;
  const header = ["timestamp","date","produit","symptome","client","contact","probleme","actions"];
  const lines = [header.join(",")];
  for(const r of state.sav.history){
    lines.push([
      r.ts,
      `"${formatDateTimeFR(r.ts).replace(/"/g,'""')}"`,
      `"${String(r.product||"").replace(/"/g,'""')}"`,
      `"${String(r.symptom||"").replace(/"/g,'""')}"`,
      `"${String(r.client||"").replace(/"/g,'""')}"`,
      `"${String(r.contact||"").replace(/"/g,'""')}"`,
      `"${String(r.problem||"").replace(/"/g,'""')}"`,
      `"${String(r.actions||"").replace(/"/g,'""')}"`,
    ].join(","));
  }
  download(`stoom-sav-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
  audit("SAV_HISTORY_EXPORT", "");
}
function clearSavHistory(){
  if(!isManager()) return;
  if(!confirm("Vider l‚Äôhistorique SAV ?")) return;
  state.sav.history = [];
  audit("SAV_HISTORY_CLEAR", "");
  saveState();
  renderSavHistory();
}

/* ---------- Notes & Followups ---------- */
function saveNote(){
  if(!requireAuth()) return;
  const name = ($("#noteName").value||"").trim();
  const phone = ($("#notePhone").value||"").trim();
  const text = ($("#noteText").value||"").trim();
  if(!name || !text){ toast("Note", "Nom + note requis."); return; }
  state.notes.push({ id: crypto.randomUUID(), name, phone, text, ts: Date.now() });
  audit("NOTE_SAVE", name);
  saveState();
  renderNotes();
  clearNoteForm();
}

function clearNoteForm(){
  $("#noteName").value = "";
  $("#notePhone").value = "";
  $("#noteText").value = "";
}
function toggleMaskPhones(){
  state.settings.maskPhones = !state.settings.maskPhones;
  saveState();
  renderNotes();
}
function renderNotes(){
  const tab = state.notesTab || "notes";
  setNotesTab(tab);
  if(tab === "notes") renderNotesList();
  else renderFollowups();
}
function setNotesTab(tab){
  state.notesTab = tab;
  $("#notesTab-notes").style.display = tab==="notes" ? "block" : "none";
  $("#notesTab-followups").style.display = tab==="followups" ? "block" : "none";
  $all("#notesTabSwitch .tabBtn").forEach(btn=> btn.classList.toggle("active", btn.dataset.tab === tab));
  saveState();
}
function renderNotesList(){
  const box = $("#notesList");
  const filter = ($("#noteFilter").value||"").toLowerCase().trim();
  let rows = state.notes.slice().reverse();
  if(filter){
    rows = rows.filter(n=>
      (n.name||"").toLowerCase().includes(filter) ||
      (n.phone||"").toLowerCase().includes(filter) ||
      (n.text||"").toLowerCase().includes(filter)
    );
  }
  if(rows.length === 0){
    box.innerHTML = `<div class="small">Aucune note.</div>`;
    return;
  }
  const mask = state.settings.maskPhones;
  box.innerHTML = rows.map(n=>{
    const phone = mask ? (n.phone ? n.phone.replace(/\d/g,"‚Ä¢") : "") : n.phone;
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(n.name)}</strong>
          <span>${escapeHtml(formatDateTimeFR(n.ts))}</span>
        </div>
        <p class="small">${escapeHtml(phone||"")}</p>
        <p>${escapeHtml(n.text)}</p>
        <div class="btnrow">
          <button class="btn" onclick="editNote('${n.id}')">Modifier</button>
          ${isManager() ? `<button class="btn danger" onclick="deleteNote('${n.id}')">Supprimer</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
}

function editNote(id){
  const n = state.notes.find(x=>x.id===id);
  if(!n) return;
  const name = prompt("Nom", n.name);
  if(name === null) return;
  const phone = prompt("T√©l√©phone", n.phone);
  if(phone === null) return;
  const text = prompt("Note", n.text);
  if(text === null) return;
  n.name = name.trim() || n.name;
  n.phone = phone.trim();
  n.text = text.trim() || n.text;
  audit("NOTE_EDIT", id);
  saveState();
  renderNotes();
}
function deleteNote(id){
  if(!isManager()) return toast("Suppression", "Responsable uniquement.");
  if(!confirm("Supprimer cette note ?")) return;
  state.notes = state.notes.filter(n=> n.id !== id);
  audit("NOTE_DELETE", id);
  saveState();
  renderNotes();
}

/* ---------- Followups ---------- */
function ensureFollowups(){
  if(!state.followups) state.followups = [];
}
function clearFollowupForm(){
  ensureFollowups();
  $("#followName").value = "";
  $("#followPhone").value = "";
  $("#followDueDate").value = "";
  $("#followDueTime").value = "";
  $("#followSummary").value = "";
  $("#followResult").value = "";
  $("#followDone").checked = false;
}
function saveFollowup(){
  if(!requireAuth()) return;
  ensureFollowups();
  const name = ($("#followName").value||"").trim();
  const phone = ($("#followPhone").value||"").trim();
  const date = $("#followDueDate").value;
  const time = $("#followDueTime").value;
  const summary = ($("#followSummary").value||"").trim();
  const done = $("#followDone").checked;
  const result = ($("#followResult").value||"").trim();

  if(!name || !date){
    toast("Rappel", "Nom + date obligatoires.");
    return;
  }
  const id = crypto.randomUUID();
  state.followups.push({
    id, name, phone, date, time, summary, result, done,
    createdBy: state.currentUser?.name || "‚Äî",
    ts: Date.now()
  });
  audit("FOLLOWUP_ADD", name);
  saveState();
  clearFollowupForm();
  renderFollowups();
  updateFollowUpAlerts(true);
}

function renderFollowups(){
  ensureFollowups();
  const box = $("#followList");
  const filter = ($("#followupFilter").value||"").toLowerCase().trim();
  let rows = state.followups.slice().reverse();
  if(filter){
    rows = rows.filter(f=>
      (f.name||"").toLowerCase().includes(filter) ||
      (f.phone||"").toLowerCase().includes(filter) ||
      (f.summary||"").toLowerCase().includes(filter) ||
      (f.result||"").toLowerCase().includes(filter)
    );
  }
  if(rows.length === 0){
    box.innerHTML = `<div class="small">Aucun rappel.</div>`;
    return;
  }
  box.innerHTML = rows.map(f=>{
    const due = [f.date, f.time].filter(Boolean).join(" ");
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(f.name)}</strong>
          <span>${escapeHtml(due||"‚Äî")}</span>
        </div>
        <p class="small">${escapeHtml(f.summary||"")}</p>
        <p class="small">Cr√©√© par ${escapeHtml(f.createdBy||"‚Äî")}</p>
        <div class="btnrow">
          <button class="btn" onclick="editFollowup('${f.id}')">Modifier</button>
          ${isManager() ? `<button class="btn danger" onclick="deleteFollowup('${f.id}')">Supprimer</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
}

function editFollowup(id){
  const f = state.followups.find(x=>x.id===id);
  if(!f) return;
  const name = prompt("Nom", f.name);
  if(name === null) return;
  const phone = prompt("T√©l√©phone", f.phone);
  if(phone === null) return;
  const date = prompt("Date (YYYY-MM-DD)", f.date);
  if(date === null) return;
  const time = prompt("Heure", f.time);
  if(time === null) return;
  const summary = prompt("R√©sum√©", f.summary);
  if(summary === null) return;
  const result = prompt("R√©sultat", f.result);
  if(result === null) return;
  const done = confirm("Marquer comme fait ?");
  f.name = name.trim() || f.name;
  f.phone = phone.trim();
  f.date = date.trim() || f.date;
  f.time = time.trim();
  f.summary = summary.trim() || f.summary;
  f.result = result.trim();
  f.done = done;
  audit("FOLLOWUP_EDIT", id);
  saveState();
  renderFollowups();
}
function deleteFollowup(id){
  if(!isManager()){ toast("Suppression", "Responsable uniquement."); return; }
  if(!confirm("Supprimer ce rappel ?")) return;
  state.followups = state.followups.filter(f=> f.id !== id);
  audit("FOLLOWUP_DELETE", id);
  saveState();
  renderFollowups();
  updateFollowUpAlerts(true);
}
function exportFollowupsCSV(){
  if(!isManager()) return;
  ensureFollowups();
  const header = ["id","name","phone","date","time","summary","result","done","createdBy","ts"];
  const lines = [header.join(",")];
  for(const f of state.followups){
    lines.push([
      f.id,
      `"${(f.name||"").replace(/"/g,'""')}"`,
      `"${(f.phone||"").replace(/"/g,'""')}"`,
      f.date,
      f.time,
      `"${(f.summary||"").replace(/"/g,'""')}"`,
      `"${(f.result||"").replace(/"/g,'""')}"`,
      f.done ? "yes" : "no",
      `"${(f.createdBy||"").replace(/"/g,'""')}"`,
      f.ts
    ].join(","));
  }
  download(`stoom-followups-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
  audit("FOLLOWUP_EXPORT", "");
}
function clearFollowups(){
  if(!isManager()) return;
  if(!confirm("Vider tous les suivis ?")) return;
  state.followups = [];
  audit("FOLLOWUP_CLEAR", "");
  saveState();
  renderFollowups();
  updateFollowUpAlerts(true);
}

/* ---------- Followup alerts ---------- */
function updateFollowUpAlerts(skipSave=false){
  ensureFollowups();
  const today = new Date().toISOString().slice(0,10);
  const due = state.followups.filter(f=> !f.done && f.date && f.date <= today);
  const banner = $("#homeFollowupBanner");
  const text = $("#homeFollowupText");
  const mini = $("#followupMini");
  mini.textContent = String(due.length || 0);
  if(due.length === 0){
    banner.style.display = "none";
  } else {
    banner.style.display = "flex";
    text.textContent = `${due.length} rappel(s) √† traiter ou en retard.`;
  }
  if(!skipSave) saveState();
}
function openFollowupsTab(){
  state.notesTab = "followups";
  go("notes");
}

/* ---------- Manager: Rules editor ---------- */
function refreshRulesSummary(){
  const r = state.rules?.byCigs || {};
  const parts = [];
  for(const k of ["5-10","10-15","15-20","25+"]){
    const x = r[k];
    if(!x) continue;
    parts.push(`${k}: ${x.nicotine} ‚Ä¢ ${x.tirage} ‚Ä¢ ${x.power}`);
  }
  $("#rulesSummary").textContent = parts.length ? parts.join(" | ") : "‚Äî";
}
function renderRulesEditor(){
  if(!isManager()) return;
  const wrap = $("#rulesEditor");
  const r = state.rules.byCigs;

  const row = (key, label) => {
    const x = r[key];
    return `
      <div class="item">
        <div class="top">
          <strong>${label}</strong>
          <span>${key}</span>
        </div>
        <div class="hr"></div>
        <div class="two">
          <div><label>Nicotine</label><input data-rule="${key}" data-field="nicotine" type="text" value="${escapeHtml(x.nicotine||"")}" /></div>
          <div><label>Tirage</label><input data-rule="${key}" data-field="tirage" type="text" value="${escapeHtml(x.tirage||"")}" /></div>
        </div>
        <div class="two" style="margin-top:10px">
          <div><label>Puissance</label><input data-rule="${key}" data-field="power" type="text" value="${escapeHtml(x.power||"")}" /></div>
          <div><label>Mat√©riel</label><input data-rule="${key}" data-field="hardware" type="text" value="${escapeHtml(x.hardware||"")}" /></div>
        </div>
      </div>
    `;
  };

  wrap.innerHTML = [
    row("5-10", "Profil 5‚Äì10 cig/j"),
    row("10-15","Profil 10‚Äì15 cig/j"),
    row("15-20","Profil 15‚Äì20 cig/j"),
    row("25+","Profil 25+ cig/j"),
  ].join("");
}
function saveRulesFromUI(){
  if(!isManager()) return;
  const inputs = $all("#rulesEditor input[data-rule]");
  inputs.forEach(inp=>{
    const key = inp.getAttribute("data-rule");
    const field = inp.getAttribute("data-field");
    if(!state.rules.byCigs[key]) state.rules.byCigs[key] = {};
    state.rules.byCigs[key][field] = (inp.value||"").trim();
  });
  audit("RULES_SAVE", "");
  saveState();
  toast("R√®gles", "Enregistr√©es.");
}
function resetRules(){
  if(!isManager()) return;
  if(!confirm("R√©initialiser les r√®gles par d√©faut ?")) return;
  state.rules = structuredClone(DEFAULT_STATE.rules);
  audit("RULES_RESET", "");
  saveState();
  renderRulesEditor();
  toast("R√®gles", "R√©initialis√©es.");
}

/* ---------- Manager: Users ---------- */
function slugifyName(name){
  return (name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") || ("u"+Math.random().toString(16).slice(2,7));
}
function renderUsers(){
  if(!isManager()) return;
  const wrap = $("#usersList");
  const users = state.users.slice().sort((a,b)=> a.name.localeCompare(b.name,'fr'));
  wrap.innerHTML = users.map(u=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(u.name)}</strong>
          <span>${escapeHtml(u.role)}</span>
        </div>
        <p class="small mono">id=${escapeHtml(u.id)} ‚Ä¢ PIN=‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
        <div class="btnrow">
          <button class="btn" onclick="openEditUser('${u.id}')">Modifier</button>
          ${u.id === "arnaud" ? `<span class="small">Arnaud prot√©g√©</span>` : `<button class="btn danger" onclick="removeUser('${u.id}')">Supprimer</button>`}
        </div>
      </div>
    `;
  }).join("");

  $("#newUserName").addEventListener("input", ()=>{
    $("#newUserId").value = slugifyName($("#newUserName").value);
  }, { once:false });
}
function addUser(){
  if(!isManager()) return;
  const name = ($("#newUserName").value||"").trim();
  const pin = ($("#newUserPin").value||"").trim();
  const role = $("#newUserRole").value;
  const id = slugifyName(name);

  if(!name){ toast("User", "Nom requis."); return; }
  if(!pin || pin.length < 4){ toast("User", "PIN 4 chiffres mini."); return; }
  if(state.users.some(u=>u.id===id)){ toast("User", "ID existe d√©j√†."); return; }

  state.users.push({ id, name, pin, role });
  audit("USER_ADD", `${id}:${role}`);
  saveState();
  $("#newUserName").value = "";
  $("#newUserPin").value = "";
  $("#newUserId").value = "";
  renderUsers();
  toast("OK", "Utilisateur ajout√©.");
}
function removeUser(id){
  if(!isManager()) return;
  if(!confirm("Supprimer cet utilisateur ?")) return;
  state.users = state.users.filter(u=>u.id!==id);
  audit("USER_REMOVE", id);
  saveState();
  renderUsers();
}
function openEditUser(id){
  const u = state.users.find(x=>x.id===id);
  if(!u) return;

  const name = prompt("Nom", u.name);
  if(name === null) return;
  const role = prompt("R√¥le (seller/manager)", u.role);
  if(role === null) return;
  const pin = prompt("Nouveau PIN (laisser vide pour ne pas changer)", "");
  if(pin === null) return;

  u.name = name.trim() || u.name;
  u.role = (role.trim()==="manager") ? "manager" : "seller";
  if(pin.trim()){
    if(pin.trim().length < 4){ toast("PIN", "4 chiffres mini."); return; }
    u.pin = pin.trim();
  }

  if(state.currentUser?.id === u.id){
    state.currentUser.name = u.name;
    state.currentUser.role = u.role;
  }
  audit("USER_EDIT", `${u.id}:${u.role}`);
  saveState();
  renderUsers();
  refreshAuthUI();
}

/* ---------- Admin accus/chargeurs ---------- */
function saveBattSettings(){
  if(!isManager()) return;
  ensureBattState();
  const minV = Number($("#adminBattMin").value||state.battSettings.battMinV||3.2);
  const margin = Number($("#adminBattMargin").value||state.battSettings.safetyMargin||0.8);
  state.battSettings.battMinV = Math.min(Math.max(minV, 2.8), 3.4);
  state.battSettings.safetyMargin = Math.min(Math.max(margin, 0.5), 1);
  state.batt.battMinV = state.battSettings.battMinV;
  state.batt.safetyMargin = state.battSettings.safetyMargin;
  audit("BATT_ADMIN_SETTINGS", `minV=${state.battSettings.battMinV},margin=${state.battSettings.safetyMargin}`);
  saveState();
  toast("Accus", "Param√®tres mis √† jour.");
  renderBattView();
}
function exportBatteriesCSV(){
  if(!isManager()) return;
  const header = ["id","brand","model","size","chemistry","cdrA","capacitymAh","notes","trusted"];
  const rows = [header.join(",")];
  state.batteriesCatalog.forEach(b=>{
    rows.push([
      b.id,
      `"${(b.brand||"").replace(/"/g,'""')}"`,
      `"${(b.model||"").replace(/"/g,'""')}"`,
      `"${(b.size||"").replace(/"/g,'""')}"`,
      `"${(b.chemistry||"").replace(/"/g,'""')}"`,
      b.cdrA,
      b.capacitymAh,
      `"${(b.notes||"").replace(/"/g,'""')}"`,
      b.trusted ? "yes" : "no"
    ].join(","));
  });
  download(`stoom-accus-${new Date().toISOString().slice(0,10)}.csv`, rows.join("\n"), "text/csv");
  audit("BATT_ADMIN_EXPORT", `count=${state.batteriesCatalog.length}`);
}
function exportChargersCSV(){
  if(!isManager()) return;
  const header = ["id","brand","model","slots","maxCurrentA","usbInput","notes"];
  const rows = [header.join(",")];
  state.chargersCatalog.forEach(c=>{
    rows.push([
      c.id,
      `"${(c.brand||"").replace(/"/g,'""')}"`,
      `"${(c.model||"").replace(/"/g,'""')}"`,
      c.slots,
      c.maxCurrentA,
      `"${(c.usbInput||"").replace(/"/g,'""')}"`,
      `"${(c.notes||"").replace(/"/g,'""')}"`,
    ].join(","));
  });
  download(`stoom-chargeurs-${new Date().toISOString().slice(0,10)}.csv`, rows.join("\n"), "text/csv");
  audit("BATT_ADMIN_EXPORT_CHARGER", `count=${state.chargersCatalog.length}`);
}
function addBatteryFromForm(){
  if(!isManager()) return;
  ensureBattState();
  const brand = ($("#battBrand").value||"").trim();
  const model = ($("#battModel").value||"").trim();
  const size = ($("#battSize").value||"").trim();
  const chemistry = ($("#battChem").value||"").trim();
  const cdrA = Number($("#battCdr").value||0);
  const capacitymAh = Number($("#battCapacity").value||0);
  const notes = ($("#battNotes").value||"").trim();
  const trusted = $("#battTrusted").checked;
  if(!brand || !model || !cdrA || !capacitymAh){ toast("Accus", "Marque, mod√®le, CDR et capacit√© requis."); return; }
  const baseId = slugifyName(`${brand}-${model}`);
  const editingId = $("#addBattBtn").dataset.editing || baseId;
  let existing = state.batteriesCatalog.find(b=> b.id === editingId);
  const payload = { id: editingId, brand, model, size, chemistry, cdrA, capacitymAh, notes, trusted };
  const action = existing ? "BATT_ADMIN_EDIT" : "BATT_ADMIN_ADD";
  if(existing){
    Object.assign(existing, payload);
  } else {
    state.batteriesCatalog.push(payload);
  }
  $("#addBattBtn").dataset.editing = "";
  ["battBrand","battModel","battSize","battChem","battCdr","battCapacity","battNotes"].forEach(id=> $("#"+id).value = "");
  $("#battTrusted").checked = true;
  saveState();
  audit(action, payload.id);
  renderBatteryAdmin();
  renderBattView();
  toast("Accus", existing ? "Accu modifi√©." : "Accu ajout√©.");
}
function editBattery(id){
  if(!isManager()) return;
  const b = state.batteriesCatalog.find(x=>x.id===id);
  if(!b) return;
  $("#battBrand").value = b.brand||"";
  $("#battModel").value = b.model||"";
  $("#battSize").value = b.size||"";
  $("#battChem").value = b.chemistry||"";
  $("#battCdr").value = b.cdrA||"";
  $("#battCapacity").value = b.capacitymAh||"";
  $("#battNotes").value = b.notes||"";
  $("#battTrusted").checked = !!b.trusted;
  $("#addBattBtn").dataset.editing = b.id;
  toast("Edition", "Modifier puis cliquer sur Ajouter/mettre √† jour.");
}
function removeBattery(id){
  if(!isManager()) return;
  if(!confirm("Supprimer cet accu ?")) return;
  state.batteriesCatalog = state.batteriesCatalog.filter(b=> b.id !== id);
  audit("BATT_ADMIN_REMOVE", id);
  saveState();
  renderBatteryAdmin();
  renderBattView();
}
function addChargerFromForm(){
  if(!isManager()) return;
  ensureBattState();
  const brand = ($("#chargerBrand").value||"").trim();
  const model = ($("#chargerModel").value||"").trim();
  const slots = Number($("#chargerSlots").value||0);
  const maxCurrentA = Number($("#chargerCurrent").value||0);
  const notes = ($("#chargerNotes").value||"").trim();
  if(!brand || !model || !slots || !maxCurrentA){ toast("Chargeur", "Marque, mod√®le, slots, courant requis."); return; }
  const baseId = slugifyName(`${brand}-${model}`);
  const editingId = $("#addChargerBtn").dataset.editing || baseId;
  const payload = { id: editingId, brand, model, slots, maxCurrentA, usbInput:"5V", notes };
  const existing = state.chargersCatalog.find(c=> c.id === editingId);
  const action = existing ? "BATT_ADMIN_EDIT_CHARGER" : "BATT_ADMIN_ADD_CHARGER";
  if(existing){ Object.assign(existing, payload); } else { state.chargersCatalog.push(payload); }
  $("#addChargerBtn").dataset.editing = "";
  ["chargerBrand","chargerModel","chargerSlots","chargerCurrent","chargerNotes"].forEach(id=> $("#"+id).value = "");
  saveState();
  audit(action, payload.id);
  renderBatteryAdmin();
  renderChargerAdvice();
  toast("Chargeur", existing ? "Modifi√©." : "Ajout√©.");
}
function editCharger(id){
  if(!isManager()) return;
  const c = state.chargersCatalog.find(x=>x.id===id);
  if(!c) return;
  $("#chargerBrand").value = c.brand||"";
  $("#chargerModel").value = c.model||"";
  $("#chargerSlots").value = c.slots||"";
  $("#chargerCurrent").value = c.maxCurrentA||"";
  $("#chargerNotes").value = c.notes||"";
  $("#addChargerBtn").dataset.editing = c.id;
  toast("Edition", "Modifier puis cliquer sur Ajouter/mettre √† jour.");
}
function removeCharger(id){
  if(!isManager()) return;
  if(!confirm("Supprimer ce chargeur ?")) return;
  state.chargersCatalog = state.chargersCatalog.filter(c=> c.id !== id);
  audit("BATT_ADMIN_REMOVE_CHARGER", id);
  saveState();
  renderBatteryAdmin();
  renderChargerAdvice();
}
function renderBatteryAdmin(){
  const box = $("#battAdminBox");
  if(!box) return;
  if(!isManager()){
    box.innerHTML = `<p class="small">R√©serv√© aux responsables.</p>`;
    return;
  }
  ensureBattState();
  $("#adminBattMin").value = state.battSettings?.battMinV || 3.2;
  $("#adminBattMargin").value = state.battSettings?.safetyMargin || 0.8;

  const battList = $("#battCatalogList");
  battList.innerHTML = state.batteriesCatalog.map(b=>`
    <div class="item">
      <div class="top">
        <strong>${escapeHtml(b.brand)} ${escapeHtml(b.model)}</strong>
        <span>${b.size || "‚Äî"} ‚Ä¢ ${b.cdrA}A ‚Ä¢ ${b.capacitymAh}mAh</span>
      </div>
      <p class="small">${escapeHtml(b.notes||"")} ${b.trusted ? "‚Ä¢ Source fiable" : "‚Ä¢ ‚ö†Ô∏è Rewrap √† v√©rifier"}</p>
      <div class="btnrow">
        <button class="btn" onclick="editBattery('${b.id}')">Modifier</button>
        <button class="btn danger" onclick="removeBattery('${b.id}')">Supprimer</button>
      </div>
    </div>
  `).join("") || `<div class="item"><p class="muted">Aucun accu en base.</p></div>`;

  const chargerList = $("#chargerCatalogList");
  chargerList.innerHTML = state.chargersCatalog.map(c=>`
    <div class="item">
      <div class="top">
        <strong>${escapeHtml(c.brand)} ${escapeHtml(c.model)}</strong>
        <span>${c.slots} slots ‚Ä¢ ${c.maxCurrentA}A</span>
      </div>
      <p class="small">${escapeHtml(c.notes||"")} ‚Ä¢ ${escapeHtml(c.usbInput||"5V")}</p>
      <div class="btnrow">
        <button class="btn" onclick="editCharger('${c.id}')">Modifier</button>
        <button class="btn danger" onclick="removeCharger('${c.id}')">Supprimer</button>
      </div>
    </div>
  `).join("") || `<div class="item"><p class="muted">Aucun chargeur en base.</p></div>`;
}

/* ---------- Audit peek + full (manager only) ---------- */
function renderAuditPeek(){
  const box = $("#auditPeek");
  const last = state.audit.slice(-5).reverse();
  if(last.length === 0){
    box.innerHTML = `<div class="small">Aucune action enregistr√©e.</div>`;
    return;
  }
  box.innerHTML = last.map(e=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(e.who)} ‚Ä¢ ${escapeHtml(e.action)}</strong>
          <span>${escapeHtml(formatDateTimeFR(e.ts))}</span>
        </div>
        <p>${escapeHtml(e.detail||"")}</p>
      </div>
    `;
  }).join("");
}
function renderAudit(){
  if(!isManager()) return;
  const filter = ($("#auditFilter").value||"").toLowerCase().trim();
  const limit = Number($("#auditLimit").value||200);

  let rows = state.audit.slice().reverse();
  if(filter){
    rows = rows.filter(e =>
      (e.who||"").toLowerCase().includes(filter) ||
      (e.action||"").toLowerCase().includes(filter) ||
      (e.detail||"").toLowerCase().includes(filter)
    );
  }
  rows = rows.slice(0, limit);

  const box = $("#auditList");
  if(rows.length === 0){
    box.innerHTML = `<div class="small">Aucune ligne.</div>`;
    return;
  }
  box.innerHTML = rows.map(e=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(e.who)} <span class="small">(${escapeHtml(e.role)})</span> ‚Ä¢ ${escapeHtml(e.action)}</strong>
          <span>${escapeHtml(formatDateTimeFR(e.ts))}</span>
        </div>
        <p>${escapeHtml(e.detail||"")}</p>
      </div>
    `;
  }).join("");
}
function exportAuditJSON(){
  if(!isManager()) return;
  const payload = { exportedAt: new Date().toISOString(), audit: state.audit };
  download(`stoom-audit-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
  audit("AUDIT_EXPORT_JSON", "");
}
function exportAuditCSV(){
  if(!isManager()) return;
  const header = ["timestamp","date","who","role","action","detail"];
  const lines = [header.join(",")];
  for(const e of state.audit){
    const row = [
      e.ts,
      `"${formatDateTimeFR(e.ts).replace(/"/g,'""')}"`,
      `"${String(e.who||"").replace(/"/g,'""')}"`,
      `"${String(e.role||"").replace(/"/g,'""')}"`,
      `"${String(e.action||"").replace(/"/g,'""')}"`,
      `"${String(e.detail||"").replace(/"/g,'""')}"`,
    ];
    lines.push(row.join(","));
  }
  download(`stoom-audit-${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"), "text/csv");
  audit("AUDIT_EXPORT_CSV", "");
}
function clearAudit(){
  if(!isManager()) return;
  if(!confirm("Vider le journal d‚Äôaudit ?")) return;
  state.audit = [];
  audit("AUDIT_CLEARED", "");
  saveState();
  renderAudit();
}

/* ---------- Accus & s√©curit√© ---------- */
function calcBatteryAdvice(){
  if(!requireAuth()) return;
  ensureBattState();
  const boxType = ($("#battBoxType").value||state.batt.boxType||"single");
  const powerW = Number($("#battPower").value||state.batt.powerW||0);
  const res = Number($("#battRes").value||state.batt.resistance||0) || null;
  let battMinV = Number($("#battMinV").value||state.batt.battMinV||state.battSettings?.battMinV||3.2);
  let safetyMargin = Number($("#battMargin").value||state.batt.safetyMargin||state.battSettings?.safetyMargin||0.8);
  if(powerW <= 0){ toast("Accus", "Puissance requise."); return; }
  battMinV = Math.min(Math.max(battMinV, 2.8), 3.4);
  safetyMargin = Math.min(Math.max(safetyMargin, 0.5), 1);

  state.batt.boxType = boxType;
  state.batt.powerW = powerW;
  state.batt.resistance = res;
  state.batt.battMinV = battMinV;
  state.batt.safetyMargin = safetyMargin;

  const cells = boxType === "dual" ? 2 : 1;
  const rawCurrent = powerW / (battMinV * cells);
  const effectiveCurrent = rawCurrent / safetyMargin;
  const perCellPower = powerW / cells;
  const ohm = res ? { voltage: Math.sqrt(powerW * res), current: Math.sqrt(powerW * res) / res } : null;

  const recList = state.batteriesCatalog.map(b=>{
    const marginA = (Number(b.cdrA)||0) - effectiveCurrent;
    return { ...b, marginA, safe: marginA >= 0 };
  });
  const recommended = recList.filter(r=> r.safe)
    .sort((a,b)=> b.marginA - a.marginA || (Number(b.capacitymAh||0) - Number(a.capacitymAh||0)));
  const avoid = recList.filter(r=> !r.safe).sort((a,b)=> a.marginA - b.marginA);

  const bestCdr = Math.max(...state.batteriesCatalog.map(b=> Number(b.cdrA)||0), 0);
  let safety = "OK";
  if(effectiveCurrent > bestCdr){ safety = "DANGEREUX"; }
  else if(effectiveCurrent > bestCdr * 0.85){ safety = "√Ä surveiller"; }

  state.batt.lastResult = {
    boxType, powerW, res, battMinV, safetyMargin,
    rawCurrent, effectiveCurrent, perCellPower, ohm,
    recommended, avoid, safety
  };
  audit("BATT_CALC", `P=${powerW}W,type=${boxType},res=${res||"na"},minV=${battMinV},result=${safety}`);
  saveState();
  renderBatteryResults();
  renderChargerAdvice();
}
function buildBatteryChips(list, ok=true){
  if(!list || list.length===0) return `<p class="muted">${ok ? "Aucun accu ne d√©passe la marge demand√©e." : "Aucun √† √©viter."}</p>`;
  return `<div class="chips">${list.map(b=>{
    const trust = b.trusted ? "" : "‚ö†Ô∏è rewrap/√† v√©rifier";
    const marginLabel = b.marginA !== undefined ? ` ‚Ä¢ marge ${b.marginA.toFixed(1)}A` : "";
    return `<span class="chip"><b>${escapeHtml(b.brand)} ${escapeHtml(b.model)}</b> ${escapeHtml(b.size||"")} ‚Ä¢ ${b.cdrA}A CDR${marginLabel}${trust ? " "+trust:""}${b.notes ? ` ‚Ä¢ ${escapeHtml(b.notes)}`:""}</span>`;
  }).join("")}</div>`;
}
function renderBatteryResults(){
  ensureBattState();
  const box = $("#battResults");
  const r = state.batt.lastResult;
  if(!box) return;
  if(!r){
    box.innerHTML = `<h3>Pr√™t</h3><p class="muted">Puissance + type de box ‚Üí accus conseill√©s + rappel charge.</p>`;
    return;
  }
  const safetyColor = r.safety === "OK" ? "good" : (r.safety === "√Ä surveiller" ? "warn" : "bad");
  box.innerHTML = `
    <h3>Calculs</h3>
    <div class="chips">
      <span class="chip"><b>Type</b> ${escapeHtml(r.boxType==="dual"?"Double (s√©rie)":"Simple")}</span>
      <span class="chip"><b>Puissance</b> ${r.powerW} W</span>
      <span class="chip"><b>Courant / accu (pire cas)</b> ${r.rawCurrent.toFixed(2)} A</span>
      <span class="chip"><b>Exigence avec marge</b> ${r.effectiveCurrent.toFixed(2)} A</span>
      <span class="chip"><b>Puissance / accu</b> ${r.perCellPower.toFixed(1)} W</span>
      <span class="chip"><b>Indice s√©curit√©</b> <span style="color:var(--${safetyColor});font-weight:700">${escapeHtml(r.safety)}</span></span>
    </div>
    ${r.ohm ? `<p class="small mono">Loi d‚ÄôOhm: V‚âà${r.ohm.voltage.toFixed(2)} V ‚Ä¢ I coil‚âà${r.ohm.current.toFixed(2)} A</p>` : ""}
    <div class="hr"></div>
    <h3>Accus recommand√©s</h3>
    ${buildBatteryChips(r.recommended, true)}
    <div class="hr"></div>
    <h3>Accus √† √©viter (CDR insuffisant)</h3>
    ${buildBatteryChips(r.avoid, false)}
    <div class="hr"></div>
    <div class="alertBanner warn">
      <div>
        <strong>Rappels s√©curit√©</strong>
        <div class="small">Wrap intact, accus authentiques, √©viter rewraps marketing douteux. Pas de charge dans la box si port endommag√©. Remplacer en cas de chute, odeur, chauffe anormale.</div>
      </div>
    </div>
  `;
}
function renderChargerAdvice(){
  ensureBattState();
  const list = $("#chargerList");
  if(!list) return;
  const isDual = (state.batt.boxType || $("#battBoxType")?.value || "single") === "dual";
  const minSlots = 2;
  const preferSlots = isDual ? 4 : 2;
  const targetCharge = `0.5‚Äì1A conseill√© (${preferSlots} slots id√©al${preferSlots>2?" en double":""})`;
  const rows = state.chargersCatalog
    .filter(c=> Number(c.slots||0) >= minSlots)
    .sort((a,b)=> Number(b.slots||0) - Number(a.slots||0) || (b.maxCurrentA||0) - (a.maxCurrentA||0));
  if(rows.length === 0){
    list.innerHTML = `<div class="item"><p class="muted">Aucun chargeur en base. Demande au responsable d‚Äôen ajouter.</p></div>`;
    return;
  }
  list.innerHTML = rows.map(c=>{
    return `
      <div class="item">
        <div class="top">
          <strong>${escapeHtml(c.brand)} ${escapeHtml(c.model)}</strong>
          <span>${c.slots} slots ‚Ä¢ ${c.maxCurrentA}A max</span>
        </div>
        <p class="small">${escapeHtml(c.notes||"")} ‚Ä¢ ${targetCharge}</p>
      </div>
    `;
  }).join("");
}
function renderWrapAlert(){
  const alertBox = $("#wrapAlert");
  if(!alertBox) return;
  const damaged = $("#wrapDamaged")?.checked;
  alertBox.style.display = damaged ? "block" : "none";
}
function copyBatteryAdvice(){
  const r = state.batt?.lastResult;
  if(!r){ toast("Copie", "Calcul d‚Äôabord."); return; }
  const top = r.recommended?.[0];
  const summary = [
    `Box: ${r.boxType==="dual"?"double":"simple"}`,
    `Puissance: ${r.powerW}W`,
    `Courant cible: ${r.effectiveCurrent.toFixed(2)}A/accu (min ${r.battMinV}V, marge ${r.safetyMargin})`,
    top ? `Proposition: ${top.brand} ${top.model} (${top.cdrA}A, ${top.capacitymAh}mAh)` : "Aucun accu en base ne passe la marge."
  ].join(" ‚Ä¢ ");
  copyToClipboard(summary);
}
function renderBattView(){
  ensureBattState();
  const minV = state.batt.battMinV || state.battSettings.battMinV || 3.2;
  const margin = state.batt.safetyMargin || state.battSettings.safetyMargin || 0.8;
  $("#battBoxType").value = state.batt.boxType || "single";
  $("#battPower").value = state.batt.powerW || "";
  $("#battRes").value = state.batt.resistance || "";
  $("#battMinV").value = minV;
  $("#battMargin").value = margin;
  renderBatteryResults();
  renderChargerAdvice();
  renderWrapAlert();
}

/* ---------- Sidebar mini + home last sheet ---------- */
function refreshSidebarMini(){
  $("#today").textContent = formatDateFR(new Date());
  $("#userMini").textContent = state.currentUser?.name || "‚Äî";
  $("#roleMini").textContent = state.currentUser ? (isManager() ? "Responsable" : "Vendeur") : "‚Äî";
  $("#sheetMini").textContent = state.client.sheet ? "OK" : "‚Äî";
}
function refreshHomeLastSheet(){
  const box = $("#lastSheetBox");
  if(!state.client.sheet){
    box.innerHTML = `<h3>‚Äî</h3><p class="muted">Aucune fiche pour le moment.</p><div class="btnrow"><button class="btn" onclick="go('client')">Cr√©er une fiche</button></div>`;
    return;
  }
  const sh = state.client.sheet;
  box.innerHTML = `
    <h3>${escapeHtml(sh.title)}</h3>
    <p class="muted">${escapeHtml(sh.tirage)} ‚Ä¢ ${escapeHtml(sh.nicotine)} ‚Ä¢ ${escapeHtml(sh.hardware)}</p>
    <div class="btnrow">
      <button class="btn primary" onclick="go('client')">Voir</button>
      <button class="btn" onclick="printSheet()">Imprimer</button>
    </div>
  `;
}

/* ---------- Keyboard shortcuts ---------- */
function bindKeys(){
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      $("#authModal").classList.remove("show");
      $("#importModal").classList.remove("show");
      $("#savModal").classList.remove("show");
      return;
    }
    if(e.key === "/" && !e.metaKey && !e.ctrlKey){
      e.preventDefault();
      $("#searchInput").focus();
      return;
    }
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    const typing = ["input","textarea","select"].includes(tag);
    if(typing) return;

    const k = e.key.toLowerCase();
    if(k==="h") go("home");
    if(k==="c") go("client");
    if(k==="s") go("sav");
    if(k==="k") go("calc");
    if(k==="b") go("batt");
    if(k==="n"){ state.notesTab = "notes"; go("notes"); }
    if(k==="r"){ state.notesTab = "followups"; go("notes"); }
    if(k==="a") isManager() ? go("manager") : null;

    if((e.ctrlKey || e.metaKey) && k==="p"){
      e.preventDefault();
      printSheet();
    }
  });
}

/* ---------- Bind buttons ---------- */
function bindButtons(){
  $("#authBtn").addEventListener("click", ()=> openAuthModal(false));
  $("#logoutBtn").addEventListener("click", logout);

  $("#quickNew").addEventListener("click", ()=>{
    if(!requireAuth()) return;
    clientReset();
    go("client");
  });

  $("#searchInput").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") runSearch(e.target.value);
  });

  $("#noteFilter").addEventListener("input", renderNotes);
  $("#followupFilter")?.addEventListener("input", renderFollowups);

  $("#printBtn").addEventListener("click", printSheet);

  $("#exportStateBtn").addEventListener("click", exportFullState);
  $("#importStateBtn").addEventListener("click", openImportModal);
  $("#resetBtn").addEventListener("click", clearAll);

  $("#savVendorProblem").addEventListener("input", ()=>{
    state.sav.vendorProblem = ($("#savVendorProblem").value||"").trim();
    saveState();
  });

  $("#battCalcBtn")?.addEventListener("click", calcBatteryAdvice);
  $("#battBoxType")?.addEventListener("change", (e)=>{ ensureBattState(); state.batt.boxType = e.target.value; saveState(); renderChargerAdvice(); });
  $("#battPower")?.addEventListener("input", (e)=>{ ensureBattState(); state.batt.powerW = Number(e.target.value||0); saveState(); });
  $("#battRes")?.addEventListener("input", (e)=>{ ensureBattState(); state.batt.resistance = Number(e.target.value||0); saveState(); });
  $("#battMinV")?.addEventListener("input", (e)=>{ ensureBattState(); state.batt.battMinV = Number(e.target.value||0); saveState(); });
  $("#battMargin")?.addEventListener("input", (e)=>{ ensureBattState(); state.batt.safetyMargin = Number(e.target.value||0); saveState(); });
  $("#wrapDamaged")?.addEventListener("change", renderWrapAlert);
  $("#wrapOk")?.addEventListener("change", renderWrapAlert);

  $("#saveBattSettingsBtn")?.addEventListener("click", saveBattSettings);
  $("#addBattBtn")?.addEventListener("click", addBatteryFromForm);
  $("#addChargerBtn")?.addEventListener("click", addChargerFromForm);
  $("#exportBattCsvBtn")?.addEventListener("click", exportBatteriesCSV);
  $("#exportChargerCsvBtn")?.addEventListener("click", exportChargersCSV);

  $("#authModal").addEventListener("click", (e)=>{ if(e.target.id==="authModal") closeAuthModal(); });
  $("#importModal").addEventListener("click", (e)=>{ if(e.target.id==="importModal") closeImportModal(); });
  $("#savModal").addEventListener("click", (e)=>{ if(e.target.id==="savModal") closeSavModal(); });
}

/* ---------- Init ---------- */
function init(){
  ensureBattState();
  refreshSidebarMini();
  refreshAuthUI();
  refreshRulesSummary();
  ensureFollowups();
  clearFollowupForm();
  renderNotes();
  updateFollowUpAlerts(true);
  renderAuditPeek();
  bindNav();
  bindButtons();
  bindKeys();

  $all(".view").forEach(v=> v.style.display="none");
  $("#view-home").style.display = "block";

  if(!state.currentUser) openAuthModal(true);
}
init();
</script>
</body>
</html>
