<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <title>STOOM ‚Ä¢ Outil Tablette PRO</title>
  <style>
    :root{
      --bg:#070B14;
      --panel:#0B1220;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.56);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 16px;
      --gap: 14px;
      --accent:#3B82F6;
      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(236,72,153,.18), transparent 55%),
        radial-gradient(1100px 800px at 55% 90%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, #070B14 0%, #050713 100%);
      overflow:hidden;
    }
    .app{height:100%; display:grid; grid-template-columns: 380px 1fr;}
    @media (max-width: 980px){body{overflow:auto}.app{grid-template-columns:1fr}}

    .sidebar{
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.02) 100%);
      border-right:1px solid var(--stroke);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      height:100%;
      overflow:auto;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      margin-bottom:14px;
    }
    .brand-left{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:
        radial-gradient(14px 14px at 25% 30%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(26px 20px at 75% 70%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(59,130,246,.95), rgba(139,92,246,.85));
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.08em; text-transform:uppercase}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 5px rgba(245,158,11,.12)}
    .dot.ok{background:var(--good);box-shadow:0 0 0 5px rgba(34,197,94,.12)}
    .pill button{
      all:unset; cursor:pointer; color:var(--text);
      padding:2px 6px; border-radius:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .pill button:hover{background:rgba(255,255,255,.10)}

    .nav{display:flex; flex-direction:column; gap:10px; margin-top:14px;}
    .navbtn{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .navbtn:hover{background: rgba(255,255,255,.06)}
    .navbtn:active{transform: scale(.99)}
    .navbtn.active{
      background: linear-gradient(135deg, rgba(59,130,246,.22), rgba(139,92,246,.12));
      border-color: rgba(59,130,246,.35);
    }
    .icon{
      width:34px; height:34px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-family:var(--mono);
      font-size:13px;
      color:rgba(255,255,255,.85);
    }
    .navtxt{display:flex; flex-direction:column; gap:2px}
    .navtxt .t{font-size:13px; font-weight:700}
    .navtxt .s{font-size:12px; color:var(--muted)}
    .kbd{
      margin-left:auto;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted2);
      padding:4px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .side-card{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .side-card h3{margin:0 0 8px; font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:var(--muted)}
    .side-card .row{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px 0; border-top:1px solid rgba(255,255,255,.08)}
    .side-card .row:first-of-type{border-top:none}
    .side-card .row span{font-size:12px; color:var(--muted)}
    .side-card .row strong{font-size:12px}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .08s ease;
      font-size:12px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: scale(.99)}
    .btn.primary{border-color: rgba(59,130,246,.40); background: rgba(59,130,246,.18);}
    .btn.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12);}
    .btn.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12);}
    .btn[disabled]{opacity:.45; cursor:not-allowed}

    .main{height:100%; overflow:auto; padding:18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;}
    .search{
      flex:1; display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    .search input{all:unset; flex:1; font-size:13px; color:var(--text);}
    .search .hint{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted2);
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    @media (min-width:1180px){.grid.cols2{grid-template-columns:1.1fr .9fr;}}

    .panel{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .panel .ph h2{margin:0;font-size:14px;letter-spacing:.04em}
    .panel .ph p{margin:3px 0 0;font-size:12px;color:var(--muted)}
    .panel .pb{padding:14px;}

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      user-select:none;
    }

    .q{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
    }
    .q h3{margin:0 0 6px;font-size:14px}
    .q p{margin:0 0 10px;color:var(--muted);font-size:12px;line-height:1.4}

    .two{display:grid; grid-template-columns:1fr; gap:10px;}
    @media (min-width:1180px){.two{grid-template-columns:1fr 1fr}}

    .choices{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;}
    @media (min-width:900px){
      .choices.cols3{grid-template-columns:repeat(3, minmax(0,1fr));}
      .choices.cols4{grid-template-columns:repeat(4, minmax(0,1fr));}
    }
    .choice{
      padding:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .choice:hover{background: rgba(255,255,255,.06)}
    .choice:active{transform: scale(.99)}
    .choice.selected{
      border-color: rgba(59,130,246,.45);
      background: rgba(59,130,246,.14);
    }
    .choice .ct{font-weight:800;font-size:13px}
    .choice .cs{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}

    textarea, select, input[type="number"], input[type="text"], input[type="password"], input[type="date"]{
      width:100%;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    textarea{min-height:96px; resize:vertical; line-height:1.4}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    .mono{font-family:var(--mono)}
    .small{font-size:11px; color:var(--muted2)}
    .hr{height:1px;background: rgba(255,255,255,.10); margin:12px 0}

    .steps{display:flex; gap:8px; flex-wrap:wrap;}
    .step{
      flex:1; min-width:120px;
      padding:10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .step.active{
      color: var(--text);
      border-color: rgba(59,130,246,.35);
      background: rgba(59,130,246,.10);
    }
    .step.done{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: var(--text);
    }

    .result{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, rgba(59,130,246,.16), rgba(139,92,246,.10));
      padding:14px;
    }
    .result h3{margin:0 0 8px;font-size:14px}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
    }
    .chip b{font-weight:900}

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform: translateX(-50%);
      min-width: 280px; max-width: 92vw;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,32,.92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 20px 80px rgba(0,0,0,.6);
      display:none; z-index:9999;
    }
    .toast.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px); opacity:.2}to{transform:translateX(-50%) translateY(0); opacity:1}}
    .toast .t{font-size:12px;color:var(--text)}
    .toast .s{font-size:11px;color:var(--muted); margin-top:4px}

    .modal{
      position:fixed; inset:0;
      display:none; z-index:9998;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      padding:18px; overflow:auto;
    }
    .modal.show{display:block}
    .modal-card{
      max-width: 820px;
      margin: 40px auto;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(12,18,32,.92);
      box-shadow: 0 20px 90px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .modal-h{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal-h h3{margin:0;font-size:14px}
    .modal-b{padding:14px}
    .xbtn{
      all:unset; cursor:pointer;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--text);
    }
    .xbtn:hover{background: rgba(255,255,255,.08)}

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding:12px;
    }
    .item .top{display:flex; justify-content:space-between; gap:12px; align-items:flex-start}
    .item .top strong{font-size:13px}
    .item .top span{font-size:11px;color:var(--muted2);font-family:var(--mono)}
    .item p{margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.4}

    .dangerText{color: rgba(239,68,68,.92)}
    .goodText{color: rgba(34,197,94,.92)}
    .warnText{color: rgba(245,158,11,.92)}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-left">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>STOOM</h1>
          <p>Tablette PRO ‚Ä¢ audit + SAV imprimable</p>
        </div>
      </div>
      <div class="pill" id="authPill" title="Connexion vendeur obligatoire">
        <span class="dot" id="authDot"></span>
        <span id="authLabel">Non connect√©</span>
        <button id="authBtn">PIN</button>
      </div>
    </div>

    <div class="nav" id="nav">
      <div class="navbtn active" data-view="home" tabindex="0">
        <div class="icon">01</div>
        <div class="navtxt"><div class="t">Accueil</div><div class="s">parcours + SAV + audit</div></div>
        <div class="kbd">H</div>
      </div>

      <div class="navbtn" data-view="client" tabindex="0">
        <div class="icon">CL</div>
        <div class="navtxt"><div class="t">Parcours client</div><div class="s">diagnostic + fiche</div></div>
        <div class="kbd">C</div>
      </div>

      <div class="navbtn" data-view="sav" tabindex="0">
        <div class="icon">SV</div>
        <div class="navtxt"><div class="t">SAV</div><div class="s">guid√© + fiche A4</div></div>
        <div class="kbd">S</div>
      </div>

      <div class="navbtn" data-view="calc" tabindex="0">
        <div class="icon">‚Ç¨</div>
        <div class="navtxt"><div class="t">Calculs</div><div class="s">conso & √©conomies</div></div>
        <div class="kbd">K</div>
      </div>

      <div class="navbtn" data-view="notes" tabindex="0">
        <div class="icon">üìù</div>
        <div class="navtxt"><div class="t">Notes client</div><div class="s">suivi (prot√©g√©)</div></div>
        <div class="kbd">N</div>
      </div>

      <div class="navbtn" data-view="manager" tabindex="0" id="managerNav" style="display:none">
        <div class="icon">AD</div>
        <div class="navtxt"><div class="t">Responsable</div><div class="s">r√®gles + audit + users</div></div>
        <div class="kbd">A</div>
      </div>
    </div>

    <div class="side-card">
      <h3>Session</h3>
      <div class="row"><span>Date</span> <strong id="today"></strong></div>
      <div class="row"><span>Utilisateur</span> <strong id="userMini">‚Äî</strong></div>
      <div class="row"><span>R√¥le</span> <strong id="roleMini">‚Äî</strong></div>
      <div class="row"><span>Derni√®re fiche</span> <strong id="sheetMini">‚Äî</strong></div>

      <div class="btnrow">
        <button class="btn primary" id="printBtn">Imprimer fiche client</button>
        <button class="btn" id="exportStateBtn">Exporter</button>
      </div>
      <div class="btnrow">
        <button class="btn" id="importStateBtn">Importer</button>
        <button class="btn danger" id="resetBtn">R√©initialiser</button>
      </div>

      <div class="small" style="margin-top:10px">
        ‚ö†Ô∏è Export/Import/Reset : <b>Responsable uniquement</b> (PIN demand√©).<br/>
        Offline : OK (stockage appareil).<br/>
        Raccourcis : H C S K N A ‚Ä¢ <span class="mono">Ctrl/Cmd+P</span> ‚Ä¢ <span class="mono">/</span> recherche ‚Ä¢ <span class="mono">Esc</span>.
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="opacity:.8">üîé</span>
        <input id="searchInput" type="text" placeholder="Rechercher (ex: fuite, br√ªl√©, MTL, sel, audit...)" />
        <span class="hint">/</span>
      </div>
      <button class="btn" id="quickNew">Nouveau client</button>
      <button class="btn" id="logoutBtn">D√©connexion</button>
    </div>

    <!-- HOME -->
    <div id="view-home" class="view">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Accueil</h2>
              <p>Parcours client + SAV + tra√ßabilit√©.</p>
            </div>
            <span class="badge">Pro</span>
          </div>
          <div class="pb">
            <div class="two">
              <div class="result">
                <h3>‚úÖ Raccourcis</h3>
                <div class="chips">
                  <span class="chip"><b>Client</b> ‚Üí Diagnostic</span>
                  <span class="chip"><b>SAV</b> ‚Üí Fiche A4</span>
                  <span class="chip"><b>Notes</b> ‚Üí Suivi</span>
                </div>
                <p class="small" style="margin-top:10px">
                  Objectif : recommandation stable + preuve d‚Äôutilisation (audit).
                </p>
                <div class="btnrow">
                  <button class="btn primary" onclick="go('client')">D√©marrer diagnostic</button>
                  <button class="btn" onclick="go('sav')">D√©marrer SAV</button>
                  <button class="btn" onclick="go('notes')">Notes</button>
                </div>
              </div>

              <div class="q">
                <h3>‚öôÔ∏è R√®gles actives (r√©sum√©)</h3>
                <p class="muted" id="rulesSummary">‚Äî</p>
                <div class="btnrow">
                  <button class="btn" onclick="toast('Info', 'Les r√®gles modifient tirage/puissance/mat√©riel/nicotine selon les r√©ponses.')">Comprendre</button>
                  <button class="btn primary" id="goManagerBtn" style="display:none" onclick="go('manager')">Modifier (responsable)</button>
                </div>
                <div class="hr"></div>
                <h3>üß† Message cl√©</h3>
                <p class="muted">
                  ‚ÄúOn vise d‚Äôabord <b>z√©ro cigarette</b>. La baisse de nicotine vient quand c‚Äôest stable et confortable.‚Äù
                </p>
              </div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>üßæ Audit (aper√ßu)</h3>
              <p class="muted">Aper√ßu 5 derni√®res actions. (Audit complet : responsable uniquement.)</p>
              <div id="auditPeek" class="list"></div>
            </div>

          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Derni√®re fiche client</h2>
              <p>Reprise auto.</p>
            </div>
            <span class="badge">Auto</span>
          </div>
          <div class="pb">
            <div id="lastSheetBox" class="q">
              <h3>‚Äî</h3>
              <p class="muted">Aucune fiche pour le moment.</p>
              <div class="btnrow"><button class="btn" onclick="go('client')">Cr√©er une fiche</button></div>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>Derni√®re fiche SAV</h3>
              <p class="muted">Si tu viens de traiter un SAV, tu peux r√©-imprimer.</p>
              <div class="btnrow">
                <button class="btn" onclick="reprintLastSav()">R√©-imprimer SAV</button>
              </div>
              <div class="small">L‚Äôinfo SAV est stock√©e localement sur la tablette.</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- CLIENT -->
    <div id="view-client" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Parcours client</h2>
              <p>5 questions ‚Üí fiche claire.</p>
            </div>
            <span class="badge">Wizard</span>
          </div>
          <div class="pb">
            <div class="steps" id="clientSteps"></div>
            <div class="q" id="clientQuestionBox" style="margin-top:12px"></div>
            <div class="btnrow" style="justify-content:space-between">
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
                <button class="btn" id="clientPrev">Pr√©c√©dent</button>
                <span class="small mono">Astuce : 1/2/3/4 pour r√©pondre vite.</span>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" onclick="clientReset()">Recommencer</button>
                <button class="btn primary" id="clientNext">Suivant</button>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Fiche recommandation</h2>
              <p>Auto-g√©n√©r√©e selon les r√®gles actives.</p>
            </div>
            <span class="badge">Fiche</span>
          </div>
          <div class="pb">
            <div class="result" id="sheetBox">
              <h3>En attente‚Ä¶</h3>
              <p class="muted">R√©ponds aux questions pour g√©n√©rer la fiche.</p>
            </div>

            <div class="hr"></div>

            <div class="q">
              <h3>üó£Ô∏è Phrase pr√™te √† dire</h3>
              <p class="muted mono" id="salesLine">‚Äî</p>
              <div class="btnrow">
                <button class="btn" onclick="copySalesLine()">Copier</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- SAV -->
    <div id="view-sav" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>SAV guid√©</h2>
              <p>Sympt√¥me ‚Üí causes ‚Üí actions ‚Üí fiche imprimable.</p>
            </div>
            <span class="badge">SAV</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Quel probl√®me principal ?</h3>
              <p class="muted">Choisis le sympt√¥me dominant.</p>
              <div class="choices cols3" id="savChoices"></div>
            </div>

            <div class="q" style="margin-top:12px">
              <h3>Probl√®me constat√© (par le vendeur)</h3>
              <p class="muted">Ce texte sera repris automatiquement dans la fiche SAV.</p>
              <textarea id="savVendorProblem" placeholder="Ex: ne charge plus / fuite importante / go√ªt br√ªl√© malgr√© changement de r√©sistance..."></textarea>
              <div class="btnrow" style="margin-top:10px">
                <button class="btn primary" onclick="openSavForm()">Cr√©er fiche SAV imprimable</button>
                <button class="btn" onclick="clearSavProblem()">Effacer</button>
              </div>
              <div class="small">La fiche SAV sert de preuve interne + justificatif dans le colis fournisseur.</div>
            </div>

            <div class="q" id="savResult" style="margin-top:12px">
              <h3>En attente‚Ä¶</h3>
              <p class="muted">S√©lectionne un sympt√¥me.</p>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Checklist SAV</h2>
              <p>Trame simple (60 secondes).</p>
            </div>
            <span class="badge">Pro</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Questions √† poser</h3>
              <ul class="muted" style="margin:10px 0 0; padding-left:18px">
                <li>Depuis quand ? (aujourd‚Äôhui / 2 jours / 1 semaine)</li>
                <li>Liquide : taux / ratio / nouveaut√© ?</li>
                <li>R√©sistance : neuve ? amor√ßage ? puissance ?</li>
                <li>Airflow : trop ouvert ? tirage trop fort ?</li>
                <li>Choc / chaleur / fuite dans la poche ?</li>
              </ul>
              <div class="hr"></div>
              <h3>Conclusion</h3>
              <p class="muted">‚ÄúOn fait <b>1 changement √† la fois</b>, puis on valide. Le but : usage stable.‚Äù</p>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- CALC -->
    <div id="view-calc" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Calculateur conso</h2>
              <p>Estimation flacons 10ml.</p>
            </div>
            <span class="badge">10ml</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Cigarettes / jour</label>
                  <input id="cigsPerDay" type="number" min="0" step="1" placeholder="Ex: 20" />
                </div>
                <div>
                  <label>Dur√©e (jours)</label>
                  <input id="days" type="number" min="1" step="1" value="30" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Hypoth√®se</label>
                  <select id="mlPerDayAt20">
                    <option value="3">20 cig/j ‚âà 3 ml/j</option>
                    <option value="4" selected>20 cig/j ‚âà 4 ml/j</option>
                    <option value="5">20 cig/j ‚âà 5 ml/j</option>
                  </select>
                </div>
                <div>
                  <label>Prix flacon 10ml (‚Ç¨)</label>
                  <input id="price10ml" type="number" min="0" step="0.1" placeholder="Ex: 5.9" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="calcBottles()">Calculer</button>
                <button class="btn" onclick="fillExample()">Exemple (20 cig/j)</button>
              </div>

              <div class="hr"></div>
              <div class="result" id="bottleResult">
                <h3>R√©sultat</h3>
                <p class="muted">Renseigne les champs puis ‚ÄúCalculer‚Äù.</p>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Comparatif √©conomies</h2>
              <p>Tabac vs vape.</p>
            </div>
            <span class="badge">‚Ç¨</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Prix paquet (‚Ç¨)</label>
                  <input id="packPrice" type="number" min="0" step="0.1" placeholder="Ex: 12.5" />
                </div>
                <div>
                  <label>Paquets / jour</label>
                  <input id="packsPerDay" type="number" min="0" step="0.1" placeholder="Ex: 1" />
                </div>
              </div>

              <div class="two" style="margin-top:10px">
                <div>
                  <label>Budget vape / mois (‚Ç¨)</label>
                  <input id="vapeMonthly" type="number" min="0" step="1" placeholder="Ex: 60" />
                </div>
                <div>
                  <label>Dur√©e (mois)</label>
                  <input id="months" type="number" min="1" step="1" value="12" />
                </div>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="calcSavings()">Calculer</button>
              </div>

              <div class="hr"></div>
              <div class="result" id="savingsResult">
                <h3>R√©sultat</h3>
                <p class="muted">Renseigne puis ‚ÄúCalculer‚Äù.</p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- NOTES -->
    <div id="view-notes" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Notes client</h2>
              <p>Suivi local (prot√©g√©).</p>
            </div>
            <span class="badge">Local</span>
          </div>
          <div class="pb">
            <div class="q">
              <div class="two">
                <div>
                  <label>Nom / pseudo client</label>
                  <input id="noteName" type="text" placeholder="Ex: M. Dupont" />
                </div>
                <div>
                  <label>T√©l√©phone (optionnel)</label>
                  <input id="notePhone" type="text" placeholder="Ex: 06..." />
                </div>
              </div>

              <div style="margin-top:10px">
                <label>Note</label>
                <textarea id="noteText" placeholder="Ex: 20 cig/j, 10mg sel, MTL. Sensible ‚Üí baisser puissance."></textarea>
              </div>

              <div class="btnrow">
                <button class="btn primary" onclick="saveNote()">Enregistrer</button>
                <button class="btn" onclick="clearNoteForm()">Effacer</button>
                <button class="btn" id="toggleMaskBtn" style="display:none" onclick="toggleMaskPhones()">Masquer/afficher num√©ros</button>
              </div>

              <div class="small" style="margin-top:10px">
                Conseil RGPD : √©viter de stocker plus que n√©cessaire.
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Historique</h2>
              <p>Recherche + suppression (responsable).</p>
            </div>
            <span class="badge">CRM light</span>
          </div>
          <div class="pb">
            <div class="q">
              <label>Filtrer</label>
              <input id="noteFilter" type="text" placeholder="Nom, mot, num√©ro..." />
              <div class="hr"></div>
              <div id="notesList" class="list"></div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- MANAGER -->
    <div id="view-manager" class="view" style="display:none">
      <div class="grid cols2">
        <section class="panel">
          <div class="ph">
            <div>
              <h2>Espace responsable</h2>
              <p>R√®gles + utilisateurs + audit.</p>
            </div>
            <span class="badge">Admin</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>R√®gles de recommandation</h3>
              <p class="muted">Modifiable par responsable (PIN demand√© pour r√©initialiser).</p>
              <div id="rulesEditor"></div>
              <div class="btnrow">
                <button class="btn primary" onclick="saveRulesFromUI()">Enregistrer r√®gles</button>
                <button class="btn" onclick="resetRules()">R√©initialiser r√®gles</button>
              </div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="ph">
            <div>
              <h2>Utilisateurs & Audit</h2>
              <p>Ajouter vendeurs / export journal.</p>
            </div>
            <span class="badge">S√©curit√©</span>
          </div>
          <div class="pb">
            <div class="q">
              <h3>Gestion utilisateurs</h3>
              <div id="usersList" class="list"></div>

              <div class="hr"></div>

              <h3>Ajouter un utilisateur</h3>
              <div class="two">
                <div>
                  <label>Nom</label>
                  <input id="newUserName" type="text" placeholder="Ex: Marie" />
                </div>
                <div>
                  <label>PIN (4 chiffres mini)</label>
                  <input id="newUserPin" type="password" inputmode="numeric" placeholder="Ex: 3344" />
                </div>
              </div>
              <div class="two" style="margin-top:10px">
                <div>
                  <label>R√¥le</label>
                  <select id="newUserRole">
                    <option value="seller">Vendeur</option>
                    <option value="manager">Responsable</option>
                  </select>
                </div>
                <div>
                  <label>Identifiant (auto)</label>
                  <input id="newUserId" type="text" placeholder="auto" disabled />
                </div>
              </div>
              <div class="btnrow">
                <button class="btn primary" onclick="addUser()">Ajouter</button>
              </div>
            </div>

            <div class="q" style="margin-top:12px">
              <h3>Audit (journal d‚Äôutilisation)</h3>
              <p class="muted">Filtrable + export.</p>
              <div class="two">
                <div>
                  <label>Filtrer</label>
                  <input id="auditFilter" type="text" placeholder="Ex: Evan, FICHE, NOTE..." />
                </div>
                <div>
                  <label>Limiter (lignes)</label>
                  <select id="auditLimit">
                    <option value="50">50</option>
                    <option value="200" selected>200</option>
                    <option value="500">500</option>
                    <option value="2000">2000</option>
                  </select>
                </div>
              </div>
              <div class="btnrow">
                <button class="btn" onclick="renderAudit()">Appliquer</button>
                <button class="btn primary" onclick="exportAuditJSON()">Exporter JSON</button>
                <button class="btn" onclick="exportAuditCSV()">Exporter CSV</button>
                <button class="btn danger" onclick="clearAudit()">Vider audit</button>
              </div>
              <div class="hr"></div>
              <div id="auditList" class="list"></div>
            </div>

          </div>
        </section>
      </div>
    </div>

  </main>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastT">‚Äî</div>
  <div class="s" id="toastS">‚Äî</div>
</div>

<!-- AUTH MODAL -->
<div class="modal" id="authModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Connexion vendeur (PIN)</h3>
      <button class="xbtn" onclick="closeAuthModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">S√©lectionne ton nom puis entre ton PIN.</p>
      <label>Utilisateur</label>
      <select id="authUserSelect"></select>

      <div style="margin-top:10px">
        <label>PIN</label>
        <input type="password" id="authPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" />
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn primary" onclick="login()">Se connecter</button>
        <button class="btn" onclick="logout()">D√©connexion</button>
      </div>

      <div class="hr"></div>
      <p class="small mono">
        Responsable = acc√®s r√®gles + audit + export/import.
      </p>
    </div>
  </div>
</div>

<!-- IMPORT MODAL (manager only) -->
<div class="modal" id="importModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Importer un export</h3>
      <button class="xbtn" onclick="closeImportModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">Colle ici le JSON export√© (√©tat complet). Cela remplacera les donn√©es locales.</p>
      <label>JSON</label>
      <textarea id="importText" placeholder='{"exportedAt":"...","state":{...}}'></textarea>
      <div class="btnrow" style="margin-top:12px">
        <button class="btn primary" onclick="importState()">Importer maintenant</button>
      </div>
    </div>
  </div>
</div>

<!-- SAV FORM MODAL -->
<div class="modal" id="savModal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-h">
      <h3>Fiche SAV</h3>
      <button class="xbtn" onclick="closeSavModal()">Fermer</button>
    </div>
    <div class="modal-b">
      <p class="muted">Cette fiche est imprimable et sert d‚Äôappui vendeur (acceptation/refus de garantie).</p>

      <div class="two">
        <div>
          <label>Nom & pr√©nom client</label>
          <input id="savClientName" type="text" placeholder="Ex: DUPONT Jean" />
        </div>
        <div>
          <label>Date d‚Äôachat</label>
          <input id="savPurchaseDate" type="date" />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>R√©f√©rence produit (OBLIGATOIRE)</label>
          <input id="savProductRef" type="text" placeholder="Ex: XROS-3 / Aegis Boost / etc." />
        </div>
        <div>
          <label>Sympt√¥me s√©lectionn√©</label>
          <input id="savSymptomReadOnly" type="text" disabled />
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Produit en bon √©tat (pas de chute / casse) ?</label>
          <select id="savGoodState">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
        <div>
          <label>Port de charge intact ?</label>
          <select id="savPortOk">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
      </div>

      <div class="two" style="margin-top:10px">
        <div>
          <label>Bo√Æte produit pr√©sente ?</label>
          <select id="savBoxPresent">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
        <div>
          <label>C√¢ble de charge pr√©sent ?</label>
          <select id="savCablePresent">
            <option value="yes">Oui</option>
            <option value="no">Non</option>
          </select>
        </div>
      </div>

      <!-- Autofire rule -->
      <div id="autofireBlock" class="q" style="margin-top:12px; display:none">
        <h3>Autofire ‚Äî v√©rification obligatoire</h3>
        <p class="muted">Si <b>liquide dans capteur d‚Äôaspiration</b> ‚Üí <b>REFUS garantie automatique</b>.</p>
        <div class="two">
          <div>
            <label>Liquide dans capteur d‚Äôaspiration ?</label>
            <select id="savLiquidInSensor">
              <option value="no" selected>Non</option>
              <option value="yes">Oui</option>
            </select>
          </div>
          <div>
            <label>Preuve/constat (optionnel)</label>
            <input id="savAutofireNote" type="text" placeholder="Ex: traces visibles / client a rempli trop fort..." />
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Probl√®me constat√© (repris SAV)</label>
        <textarea id="savProblemText" placeholder="(repris automatiquement, modifiable si besoin)"></textarea>
        <div class="small" style="margin-top:6px">
          Sympt√¥me : <span class="mono" id="savSymptomLabel">‚Äî</span>
        </div>
      </div>

      <div class="hr"></div>
      <div class="btnrow">
        <button class="btn primary" onclick="validateSavAndPrint()">Valider & Imprimer fiche SAV</button>
        <button class="btn" onclick="previewSavEligibility()">Voir d√©cision</button>
      </div>

      <div class="q" style="margin-top:12px">
        <h3>D√©cision</h3>
        <p class="muted" id="savDecisionBox">‚Äî</p>
      </div>

    </div>
  </div>
</div>

<script>
/* =========================
   STOOM ‚Ä¢ Tablette PRO (v2.1)
   - PIN / r√¥les
   - export/import/reset invisibles vendeurs
   - reset r√®gles/tablette = redemande PIN responsable
   - SAV: r√©f√©rence produit obligatoire
   - SAV: ajouts HS TOTAL / CHIPSET HS / AUTOFIRE
   - AUTOFIRE + liquide capteur aspiration => REFUS auto
   ========================= */

const LS = { state: "stoom_tablette_v2_state" };

const DEFAULT_STATE = {
  settings: { shopName: "STOOM Clermont-Ferrand", maskPhones: true },
  users: [
    { id:"arnaud", name:"Arnaud", pin:"1007", role:"manager" },
    { id:"evan",   name:"Evan",   pin:"1517", role:"seller"  },
    { id:"lea",    name:"L√©a",    pin:"2109", role:"seller"  },
  ],
  currentUser: null,
  view: "home",
  audit: [],
  notes: [],
  sav: {
    symptom: null,
    vendorProblem: "",
    lastSavSheet: null
  },
  client: {
    step: 0,
    answers: { cigs:null, cigType:null, moments:null, goal:null, tried:null },
    sheet: null
  },
  rules: {
    byCigs: {
      "5-10":  { nicotine:"3‚Äì6 mg",        tirage:"MTL (serr√© √† semi-serr√©)", power:"Mod√©r√©e",  hardware:"Pod/kit MTL fiable" },
      "10-15": { nicotine:"6‚Äì12 mg",       tirage:"MTL (serr√©)",             power:"Mod√©r√©e",  hardware:"Pod/kit MTL fiable" },
      "15-20": { nicotine:"10 mg (sels)",  tirage:"MTL (serr√©, r√©gulier)",   power:"Faible (confort)", hardware:"Pod MTL / tirage serr√©" },
      "25+":   { nicotine:"20 mg (sels)",  tirage:"MTL (serr√©, r√©gulier)",   power:"Faible (confort)", hardware:"Pod MTL / tirage serr√©" }
    }
  }
};

const state = loadState();

/* ---------- Utils ---------- */
function $(q){ return document.querySelector(q); }
function $all(q){ return Array.from(document.querySelectorAll(q)); }
function safeJsonParse(str, fallback){ try{ return JSON.parse(str); }catch(e){ return fallback; } }
function deepMerge(target, src){
  if(!src || typeof src !== "object") return target;
  for(const k of Object.keys(src)){
    const v = src[k];
    if(Array.isArray(v)) target[k] = v;
    else if(v && typeof v === "object"){
      if(!target[k] || typeof target[k] !== "object") target[k] = {};
      deepMerge(target[k], v);
    } else target[k] = v;
  }
  return target;
}
function saveState(){
  localStorage.setItem(LS.state, JSON.stringify(state));
  refreshSidebarMini();
  refreshHomeLastSheet();
  refreshRulesSummary();
  renderAuditPeek();
}
function loadState(){
  const raw = localStorage.getItem(LS.state);
  if(!raw) return structuredClone(DEFAULT_STATE);
  const parsed = safeJsonParse(raw, null);
  if(!parsed) return structuredClone(DEFAULT_STATE);
  const s = structuredClone(DEFAULT_STATE);
  deepMerge(s, parsed);
  return s;
}
function formatDateFR(d){
  try{ return new Intl.DateTimeFormat('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(d); }
  catch(e){ return d.toLocaleDateString('fr-FR'); }
}
function formatDateTimeFR(ts){
  const d = new Date(ts);
  try{
    return new Intl.DateTimeFormat('fr-FR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
  }catch(e){ return d.toLocaleString('fr-FR'); }
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function toast(t, s){
  const el = $("#toast");
  $("#toastT").textContent = t || "Info";
  $("#toastS").textContent = s || "";
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.classList.remove("show"), 3200);
}
function download(filename, text, type="application/json"){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function copyToClipboard(text){
  if(!text) return toast("Copie", "Rien √† copier.");
  navigator.clipboard?.writeText(text).then(
    ()=> toast("Copi√©", "Copi√©."),
    ()=> toast("Copie", "Impossible de copier.")
  );
}

/* ---------- Auth + Audit ---------- */
function isManager(){ return state.currentUser?.role === "manager"; }
function requireAuth(){
  if(!state.currentUser){
    openAuthModal(true);
    toast("Connexion requise", "S√©lectionne ton nom et entre ton PIN.");
    return false;
  }
  return true;
}
function audit(action, detail){
  const who = state.currentUser?.name || "INCONNU";
  state.audit.push({ who, role: state.currentUser?.role || "none", action, detail: detail||"", ts: Date.now() });
  if(state.audit.length > 2000) state.audit.shift();
  saveState();
}

/* ---------- Manager PIN confirm ---------- */
function promptManagerPinOrFail(reason){
  if(!requireAuth()) return false;
  if(!isManager()){
    toast("Acc√®s refus√©", "R√©serv√© aux responsables.");
    audit("DENY_ADMIN_ACTION", reason||"");
    return false;
  }
  const currentId = state.currentUser?.id;
  const u = state.users.find(x => x.id === currentId);
  if(!u){
    toast("Erreur", "Utilisateur responsable introuvable.");
    audit("ADMIN_PIN_USER_NOT_FOUND", reason||"");
    return false;
  }
  const pin = (prompt("Action sensible : entre ton PIN responsable", "") || "").trim();
  if(!pin || pin !== u.pin){
    toast("PIN incorrect", "Action annul√©e.");
    audit("ADMIN_PIN_FAIL", reason||"");
    return false;
  }
  audit("ADMIN_PIN_OK", reason||"");
  return true;
}

/* ---------- Navigation ---------- */
function go(view){
  if(!requireAuth()) return;
  if(view === "manager" && !isManager()){
    toast("Acc√®s refus√©", "R√©serv√© aux responsables.");
    audit("DENY_MANAGER_VIEW", "");
    return;
  }
  state.view = view;
  $all(".view").forEach(v => v.style.display = "none");
  $("#view-"+view).style.display = "block";
  $all(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.view === view));

  if(view === "client") renderClient();
  if(view === "sav") renderSav();
  if(view === "notes") renderNotes();
  if(view === "manager") { renderRulesEditor(); renderUsers(); renderAudit(); }

  audit("NAVIGATE", view);
  saveState();
}
function bindNav(){
  $("#nav").addEventListener("click", (e)=>{
    const btn = e.target.closest(".navbtn");
    if(!btn) return;
    go(btn.dataset.view);
  });
}

/* ---------- Auth Modal ---------- */
function openAuthModal(force=false){
  const sel = $("#authUserSelect");
  sel.innerHTML = state.users
    .slice().sort((a,b)=> a.name.localeCompare(b.name,'fr'))
    .map(u=><option value="${u.id}">${escapeHtml(u.name)} (${u.role==="manager"?"responsable":"vendeur"})</option>)
    .join("");
  $("#authPin").value = "";
  $("#authModal").classList.add("show");
  setTimeout(()=> $("#authPin").focus(), 50);
}
function closeAuthModal(){
  if(!state.currentUser){
    toast("Connexion", "Connexion obligatoire.");
    return;
  }
  $("#authModal").classList.remove("show");
}
function refreshAuthUI(){
  const dot = $("#authDot");
  const label = $("#authLabel");
  if(state.currentUser){
    dot.classList.add("ok");
    label.textContent = state.currentUser.name;
    $("#logoutBtn").style.display = "inline-flex";
    $("#managerNav").style.display = isManager() ? "flex" : "none";
    $("#goManagerBtn").style.display = isManager() ? "inline-flex" : "none";
    $("#toggleMaskBtn").style.display = isManager() ? "inline-flex" : "none";
  } else {
    dot.classList.remove("ok");
    label.textContent = "Non connect√©";
    $("#logoutBtn").style.display = "none";
    $("#managerNav").style.display = "none";
    $("#goManagerBtn").style.display = "none";
    $("#toggleMaskBtn").style.display = "none";
  }
  refreshSidebarMini();
  updateAdminButtonsLock();
}
function login(){
  const userId = $("#authUserSelect").value;
  const pin = ($("#authPin").value || "").trim();
  const user = state.users.find(u=>u.id===userId);
  if(!user){ toast("Erreur", "Utilisateur introuvable."); return; }
  if(!pin || pin !== user.pin){
    toast("PIN incorrect", "R√©essaie.");
    audit("LOGIN_FAIL", userId);
    return;
  }
  state.currentUser = { id:user.id, name:user.name, role:user.role };
  $("#authModal").classList.remove("show");
  audit("LOGIN_OK", user.name);
  refreshAuthUI();
  saveState();
}
function logout(){
  if(state.currentUser) audit("LOGOUT", state.currentUser.name);
  state.currentUser = null;
  saveState();
  refreshAuthUI();
  openAuthModal(true);
}

/* ---------- Export/Import/Reset visibility ---------- */
function updateAdminButtonsLock(){
  const exp = $("#exportStateBtn");
  const imp = $("#importStateBtn");
  const res = $("#resetBtn");

  const logged = !!state.currentUser;
  const can = logged && isManager();

  // EXIG√â: export invisible vendeurs
  exp.style.display = can ? "inline-flex" : "none";
  imp.style.display = can ? "inline-flex" : "none";
  res.style.display = can ? "inline-flex" : "none";

  exp.disabled = !can;
  imp.disabled = !can;
  res.disabled = !can;

  exp.title = can ? "" : "R√©serv√© responsable";
  imp.title = can ? "" : "R√©serv√© responsable";
  res.title = can ? "" : "R√©serv√© responsable";
}

function exportFullState(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "Export r√©serv√© aux responsables.");
    audit("DENY_EXPORT_STATE", "");
    return;
  }
  if(!promptManagerPinOrFail("EXPORT_STATE")) return;

  const payload = { exportedAt: new Date().toISOString(), state };
  download(stoom-export-${new Date().toISOString().slice(0,10)}.json, JSON.stringify(payload, null, 2));
  audit("EXPORT_STATE", "");
}
function openImportModal(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "Import r√©serv√© aux responsables.");
    audit("DENY_IMPORT", "");
    return;
  }
  if(!promptManagerPinOrFail("OPEN_IMPORT_MODAL")) return;

  $("#importText").value = "";
  $("#importModal").classList.add("show");
}
function closeImportModal(){ $("#importModal").classList.remove("show"); }
function importState(){
  if(!isManager()){ toast("Acc√®s refus√©", "R√©serv√© aux responsables."); return; }
  if(!promptManagerPinOrFail("IMPORT_STATE")) return;

  const payload = safeJsonParse($("#importText").value||"", null);
  if(!payload?.state){ toast("Import", "JSON invalide."); return; }
  const fresh = structuredClone(DEFAULT_STATE);
  deepMerge(fresh, payload.state);
  fresh.currentUser = null;

  for(const k of Object.keys(state)) delete state[k];
  Object.assign(state, fresh);

  saveState();
  closeImportModal();
  toast("Import OK", "Donn√©es import√©es. Reconnexion requise.");
  openAuthModal(true);
}
function clearAll(){
  if(!requireAuth()) return;
  if(!isManager()){
    toast("Acc√®s refus√©", "R√©initialisation r√©serv√©e aux responsables.");
    audit("DENY_RESET", "");
    return;
  }
  if(!promptManagerPinOrFail("RESET_TABLETTE")) return;

  if(!confirm("R√©initialiser TOUT sur cet appareil ?")) return;
  localStorage.removeItem(LS.state);
  location.reload();
}

/* ---------- Search ---------- */
function runSearch(q){
  const query = (q||"").toLowerCase().trim();
  if(!query){ toast("Recherche", "Tape un mot-cl√©."); return; }
  const hitSav = ["fuite","glouglou","br√ªl√©","brule","toux","gorge","panne","charge","autofire","chipset","hs"].some(k=> query.includes(k));
  const hitClient = ["nicotine","sel","mtl","rdl","dl","0mg","dosage","tirage","puissance"].some(k=> query.includes(k));
  const hitManager = ["audit","r√®gle","regle","users","utilisateur","pin","export","import","reset"].some(k=> query.includes(k));

  if(hitSav){ go("sav"); toast("Recherche", "SAV ouvert."); return; }
  if(hitClient){ go("client"); toast("Recherche", "Parcours client ouvert."); return; }
  if(hitManager){ isManager() ? go("manager") : toast("Recherche", "Admin r√©serv√© responsable."); return; }
  toast("Recherche", "Aucun raccourci. Essaye: fuite, br√ªl√©, sel, MTL, audit‚Ä¶");
}

/* ---------- Client Wizard ---------- */
const clientSteps = [
  { key:"cigs", label:"Conso", desc:"cig/j" },
  { key:"cigType", label:"Cigarette", desc:"type" },
  { key:"moments", label:"Moments", desc:"d√©clencheur" },
  { key:"goal", label:"Objectif", desc:"intention" },
  { key:"tried", label:"Exp√©rience", desc:"d√©j√† essay√©" },
];

const clientQuestions = [
  { key:"cigs", title:"Combien de cigarettes par jour ?", subtitle:"On choisit d‚Äôabord un taux coh√©rent (stabilit√©).", cols:"cols4",
    choices:[
      {v:"5-10", t:"5‚Äì10 /j", s:"Souvent 3 ou 6 mg"},
      {v:"10-15", t:"10‚Äì15 /j", s:"Souvent 6 ou 12 mg"},
      {v:"15-20", t:"15‚Äì20 /j", s:"Souvent 10 mg sel"},
      {v:"25+", t:"25+ /j", s:"Souvent 20 mg sel"},
    ]},
  { key:"cigType", title:"Type de cigarette ?", subtitle:"√áa aide √† choisir sensations & saveurs.", cols:"cols3",
    choices:[
      {v:"blonde", t:"Blonde", s:"Classique / light"},
      {v:"menthol", t:"Menthol", s:"Fra√Æcheur douce"},
      {v:"roulee", t:"Roul√©e", s:"Plus aromatique / puissant"},
    ]},
  { key:"moments", title:"Moment difficile principal ?", subtitle:"On s√©curise ce moment en priorit√©.", cols:"cols3",
    choices:[
      {v:"stress", t:"Stress", s:"Nerfs / pression"},
      {v:"cafe", t:"Caf√©", s:"Habitude ancr√©e"},
      {v:"soir", t:"Soir", s:"D√©tente"},
      {v:"journee", t:"Journ√©e", s:"Usage fr√©quent"},
      {v:"apresRepas", t:"Apr√®s repas", s:"Rituel"},
      {v:"matin", t:"Matin", s:"D√©marrage"},
    ]},
  { key:"goal", title:"Objectif du client ?", subtitle:"L‚Äôobjectif n¬∞1 = √©viter la rechute.", cols:"cols3",
    choices:[
      {v:"arreter", t:"Arr√™ter", s:"Objectif clair"},
      {v:"reduire", t:"R√©duire", s:"√âtape"},
      {v:"remplacer", t:"Remplacer", s:"Sans pression"},
    ]},
  { key:"tried", title:"D√©j√† essay√© la vape ?", subtitle:"On corrige ce qui a bloqu√©.", cols:"cols3",
    choices:[
      {v:"non", t:"Non", s:"D√©couverte"},
      {v:"echec", t:"Oui (√©chec)", s:"On s√©curise"},
      {v:"ok", t:"Oui (√ßa marchait)", s:"On r√©plique"},
    ]},
];

function clientReset(){
  if(!requireAuth()) return;
  state.client.step = 0;
  state.client.answers = { cigs:null, cigType:null, moments:null, goal:null, tried:null };
  state.client.sheet = null;
  audit("CLIENT_RESET", "");
  saveState();
  renderClient();
}

function setAnswer(key, value){
  state.client.answers[key] = value;
  audit("CLIENT_ANSWER", ${key}=${value});
  saveState();
  setTimeout(()=> nextClient(), 60);
}
function prevClient(){
  state.client.step = Math.max(0, state.client.step - 1);
  audit("CLIENT_PREV", String(state.client.step));
  saveState();
  renderClient();
}
function nextClient(){
  const q = clientQuestions[state.client.step];
  if(!state.client.answers[q.key]){
    toast("R√©ponse manquante", "Choisis une option.");
    return;
  }
  if(state.client.step < clientQuestions.length-1){
    state.client.step += 1;
    audit("CLIENT_NEXT", String(state.client.step));
    saveState();
    renderClient();
  } else {
    state.client.sheet = buildSheet(state.client.answers);
    audit("SHEET_GENERATED", JSON.stringify(state.client.answers));
    saveState();
    renderSheet();
  }
}

function renderClientSteps(){
  const el = $("#clientSteps");
  el.innerHTML = "";
  clientSteps.forEach((s, i)=>{
    const div = document.createElement("div");
    div.className = "step";
    if(i === state.client.step) div.classList.add("active");
    if(state.client.answers[s.key]) div.classList.add("done");
    div.innerHTML = <span>${i+1}. ${escapeHtml(s.label)}</span><span class="small mono">${escapeHtml(s.desc)}</span>;
    div.onclick = ()=> { state.client.step = i; audit("CLIENT_GOTO_STEP", String(i)); saveState(); renderClient(); };
    el.appendChild(div);
  });
}
function renderClientQuestion(){
  const box = $("#clientQuestionBox");
  const q = clientQuestions[state.client.step];
  const current = state.client.answers[q.key];
  box.innerHTML = 
    <h3>${escapeHtml(q.title)}</h3>
    <p class="muted">${escapeHtml(q.subtitle)}</p>
    <div class="choices ${q.cols||""}" id="qChoices"></div>
  ;
  const ch = $("#qChoices");
  q.choices.forEach((c)=>{
    const d = document.createElement("div");
    d.className = "choice" + (current === c.v ? " selected":"");
    d.innerHTML = <div class="ct">${escapeHtml(c.t)}</div><div class="cs">${escapeHtml(c.s||"")}</div>;
    d.onclick = ()=> setAnswer(q.key, c.v);
    ch.appendChild(d);
  });
}
function renderClient(){
  renderClientSteps();
  renderClientQuestion();
  $("#clientPrev").onclick = prevClient;
  $("#clientNext").onclick = nextClient;
  $("#clientPrev").disabled = state.client.step === 0;
  renderSheet();
}

function calcFlavorHint(a){
  if(a.cigType === "blonde") return "Classiques (blond) ou l√©g√®rement gourmands";
  if(a.cigType === "menthol") return "Menthol doux / frais";
  if(a.cigType === "roulee") return "Classiques plus aromatiques (puissants)";
  return "Saveurs au choix";
}
function calcMomentTip(a){
  const m = a.moments;
  if(m === "stress") return "Stress : tirage stable + dosage coh√©rent pour √©viter la frustration.";
  if(m === "cafe") return "Caf√© : routine simple (m√™me liquide / m√™me tirage) pour remplacer le rituel.";
  if(m === "soir") return "Soir : garder le confort (ne pas baisser trop vite).";
  if(m === "journee") return "Journ√©e : autonomie + fiabilit√© + simplicit√©.";
  if(m === "apresRepas") return "Apr√®s repas : setup pr√™t, simple, toujours dispo.";
  if(m === "matin") return "Matin : dosage suffisant (sinon manque imm√©diat).";
  return "S√©curiser les moments cl√©s avec le bon dosage.";
}
function calcReassurance(a){
  if(a.tried === "echec") return "Si √ßa a d√©j√† √©chou√©, c‚Äôest souvent un mauvais couple taux/mat√©riel. On s√©curise.";
  if(a.tried === "ok") return "Si √ßa marchait, on r√©plique ce qui √©tait confortable et stable.";
  return "On ajuste si besoin, sans se pr√©cipiter.";
}
function buildSheet(a){
  const rule = state.rules.byCigs[a.cigs] || { nicotine:"‚Äî", tirage:"MTL", power:"‚Äî", hardware:"‚Äî" };

  const nicotine = rule.nicotine;
  const tirage = rule.tirage;
  const power = rule.power;
  const hardware = rule.hardware;

  const flavor = calcFlavorHint(a);
  const reassurance = calcReassurance(a);
  const momentTip = calcMomentTip(a);

  const addons = ["R√©sistance/cartouche de secours", "R√©glage puissance (confort)", "Rappel : baisser la nicotine quand c‚Äôest stable"];

  const goalLine =
    a.goal === "arreter" ? "viser d‚Äôabord z√©ro cigarette" :
    a.goal === "reduire" ? "s√©curiser le quotidien puis r√©duire doucement" :
    "remplacer sans pression (confort)";

  const salesLine = ‚ÄúJe te propose ${tirage} avec ${nicotine}. L‚Äôobjectif, c‚Äôest de ${goalLine}. On ajuste ensuite si besoin.‚Äù;

  return {
    title: "Recommandation STOOM (profil client)",
    tirage, nicotine, power, hardware,
    explain: ${reassurance} ${momentTip} Suggestion saveurs : ${flavor}.,
    addons,
    salesLine
  };
}

function renderSheet(){
  const box = $("#sheetBox");
  if(!state.client.sheet){
    box.innerHTML = <h3>En attente‚Ä¶</h3><p class="muted">R√©ponds aux questions pour g√©n√©rer la fiche.</p>;
    $("#salesLine").textContent = "‚Äî";
    refreshSidebarMini();
    refreshHomeLastSheet();
    return;
  }
  const sh = state.client.sheet;
  box.innerHTML = 
    <h3>${escapeHtml(sh.title)}</h3>
    <div class="chips" style="margin:8px 0 10px">
      <span class="chip"><b>Tirage</b> ${escapeHtml(sh.tirage)}</span>
      <span class="chip"><b>Nicotine</b> ${escapeHtml(sh.nicotine)}</span>
      <span class="chip"><b>Puissance</b> ${escapeHtml(sh.power)}</span>
      <span class="chip"><b>Mat√©riel</b> ${escapeHtml(sh.hardware)}</span>
    </div>
    <p class="muted">${escapeHtml(sh.explain)}</p>
    <div class="hr"></div>
    <div class="chips">
      ${sh.addons.map(a=><span class="chip"><b>+</b> ${escapeHtml(a)}</span>).join("")}
    </div>
    <p class="small" style="margin-top:10px">Boutique : <span class="mono">${escapeHtml(state.settings.shopName)}</span> ‚Ä¢ ${escapeHtml(formatDateFR(new Date()))}</p>
  ;
  $("#salesLine").textContent = sh.salesLine;
  refreshSidebarMini();
  refreshHomeLastSheet();
}

function copySalesLine(){
  const line = $("#salesLine").textContent;
  if(!line || line === "‚Äî") return toast("Copie", "Aucune phrase.");
  copyToClipboard(line);
  audit("COPY_SALESLINE", "");
}

function printSheet(){
  if(!requireAuth()) return;
  if(!state.client.sheet){ toast("Impression", "Aucune fiche."); return; }

  audit("PRINT_SHEET", "");
  const sh = state.client.sheet;
  const a = state.client.answers;

  const html =
<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fiche STOOM</title>
<style>
  body{font-family: Arial, sans-serif; padding:24px; color:#0b1220}
  h1{margin:0 0 6px; font-size:18px}
  .sub{color:#334155; margin:0 0 16px; font-size:12px}
  .card{border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin:12px 0}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:12px}
  .muted{color:#475569; font-size:12px; line-height:1.45}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .hr{height:1px; background:#e2e8f0; margin:12px 0}
</style></head><body>
<h1>${escapeHtml(state.settings.shopName)} ‚Ä¢ Fiche recommandation</h1>
<p class="sub">G√©n√©r√© le ${escapeHtml(formatDateFR(new Date()))}</p>

<div class="card">
  <div class="chips">
    <span class="chip"><b>Tirage</b> ${escapeHtml(sh.tirage)}</span>
    <span class="chip"><b>Nicotine</b> ${escapeHtml(sh.nicotine)}</span>
    <span class="chip"><b>Puissance</b> ${escapeHtml(sh.power)}</span>
    <span class="chip"><b>Mat√©riel</b> ${escapeHtml(sh.hardware)}</span>
  </div>
  <div class="hr"></div>
  <p class="muted">${escapeHtml(sh.explain)}</p>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">Profil (r√©sum√©)</h2>
  <p class="muted mono" style="margin:0">
    Conso: ${escapeHtml(a.cigs||"‚Äî")} ‚Ä¢ Type: ${escapeHtml(a.cigType||"‚Äî")} ‚Ä¢ Moment: ${escapeHtml(a.moments||"‚Äî")} ‚Ä¢ Objectif: ${escapeHtml(a.goal||"‚Äî")} ‚Ä¢ D√©j√† essay√©: ${escapeHtml(a.tried||"‚Äî")}
  </p>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">Phrase pr√™te √† dire</h2>
  <p class="muted mono" style="margin:0">${escapeHtml(sh.salesLine)}</p>
</div>

<div class="card">
  <h2 style="font-size:14px; margin:0 0 8px">√Ä proposer (anti-panne)</h2>
  <ul class="muted" style="margin:0; padding-left:18px">
    ${sh.addons.map(x=><li>${escapeHtml(x)}</li>).join("")}
  </ul>
</div>

</body></html>;

  const w = window.open("", "_blank");
  if(!w){ toast("Impression", "Pop-up bloqu√©e."); return; }
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

/* ---------- SAV ---------- */
const savMap = [
  { id:"fuite", t:"Fuite", s:"liquide partout / glouglou",
    causes:["R√©sistance en fin de vie ou mal amorc√©e","Airflow trop ouvert + aspiration trop forte","Liquide trop fluide / chaleur","Cartouche/joint us√©"],
    actions:["Changer r√©sistance + amorcer (attendre 5‚Äì10 min)","Baisser puissance / fermer un peu l‚Äôairflow","Nettoyer, v√©rifier joints, resserrer correctement","Si persiste : tester autre cartouche / autre liquide"],
    tip:"R√®gle d‚Äôor : 1 changement √† la fois."
  },
  { id:"goutBrule", t:"Go√ªt br√ªl√©", s:"dry hit / br√ªl√©",
    causes:["R√©sistance cram√©e ou mal imbib√©e","Puissance trop haute","Cha√Ænes de bouff√©es"],
    actions:["Changer r√©sistance + amor√ßage","Baisser la puissance (W)","Faire des pauses"],
    tip:"Si br√ªl√© permanent : r√©sistance √† remplacer."
  },
  { id:"toux", t:"Toux / gorge irrit√©e", s:"inconfort, hit trop fort",
    causes:["Taux nicotine trop √©lev√© pour le mat√©riel","Puissance trop haute / tirage trop a√©rien","Liquide/ar√¥me agressif"],
    actions:["Adapter mat√©riel au taux (MTL + puissance basse)","Ou baisser progressivement le taux si client veut plus puissant","Tester un liquide plus doux"],
    tip:"Objectif : confort ‚Üí sinon abandon ‚Üí rechute."
  },
  { id:"pasDeVapeur", t:"Pas de vapeur", s:"ne s‚Äôallume pas / rien",
    causes:["Batterie vide / mauvais contact","Cartouche mal enclench√©e","D√©faut r√©sistance"],
    actions:["Charger / v√©rifier c√¢ble / nettoyer contacts","Retirer-remettre la cartouche","Tester une autre r√©sistance/cartouche"],
    tip:"Toujours commencer par contacts + charge."
  },
  { id:"glouglou", t:"Glouglou", s:"bruit / remont√©es",
    causes:["Condensation / noyade","Aspiration trop forte","R√©sistance noy√©e"],
    actions:["Souffler doucement (papier dessous)","Nettoyer chemin√©e / base","R√©duire aspiration / fermer airflow"],
    tip:"Glouglou = trop de liquide dans la chemin√©e."
  },

  // AJOUTS demand√©s
  { id:"hsTotal", t:"Mat√©riel HS TOTAL", s:"ne s‚Äôallume plus / mort",
    causes:["Batterie/PCB HS","Oxydation / liquide interne","Choc important"],
    actions:["Test charge + c√¢ble + prise","Nettoyage contacts, test autre cartouche","Si aucun signe de vie : proc√©dure SAV / garantie"],
    tip:"Si aucun signe de vie apr√®s v√©rifs rapides : SAV."
  },
  { id:"chipsetHs", t:"CHIPSET HS", s:"bug / √©cran / erreur",
    causes:["Carte √©lectronique HS","Surtension / charge non adapt√©e","Liquide infiltr√©"],
    actions:["Reset (si possible), test charge/c√¢ble","V√©rifier traces de liquide/oxydation","SAV si anomalies persistantes"],
    tip:"Un chipset HS = souvent non r√©parable en boutique."
  },
  { id:"autofire", t:"Autofire", s:"d√©clenche tout seul",
    causes:["Liquide dans capteur d‚Äôaspiration (pods auto)","Bouton coinc√©","Condensation excessive"],
    actions:["Stopper usage, nettoyer et s√©cher","V√©rifier capteur/bouton","Si liquide capteur confirm√© : REFUS garantie (usage)"],
    tip:"‚ö†Ô∏è R√®gle: liquide dans capteur d‚Äôaspiration = refus automatique."
  },
];

function clearSavProblem(){
  $("#savVendorProblem").value = "";
  state.sav.vendorProblem = "";
  audit("SAV_CLEAR_PROBLEM", "");
  saveState();
}
function renderSav(){
  const box = $("#savChoices");
  box.innerHTML = "";
  savMap.forEach(it=>{
    const d = document.createElement("div");
    d.className = "choice" + (state.sav.symptom === it.id ? " selected":"");
    d.innerHTML = <div class="ct">${escapeHtml(it.t)}</div><div class="cs">${escapeHtml(it.s)}</div>;
    d.onclick = ()=> {
      state.sav.symptom = it.id;
      audit("SAV_SYMPTOM", it.id);
      saveState();
      renderSavResult();
      $("#savSymptomLabel").textContent = (savMap.find(x=>x.id===it.id)?.t || it.id);
    };
    box.appendChild(d);
  });
  $("#savVendorProblem").value = state.sav.vendorProblem || "";
  renderSavResult();
}
function renderSavResult(){
  const r = $("#savResult");
  const it = savMap.find(x=>x.id===state.sav.symptom);
  if(!it){
    r.innerHTML = <h3>En attente‚Ä¶</h3><p class="muted">S√©lectionne un sympt√¥me.</p>;
    return;
  }
  r.innerHTML = 
    <h3>‚úÖ ${escapeHtml(it.t)}</h3>
    <p class="muted">${escapeHtml(it.tip)}</p>
    <div class="hr"></div>
    <div class="two">
      <div>
        <h3>Causes probables</h3>
        <ul class="muted" style="margin:10px 0 0; padding-left:18px">
          ${it.causes.map(c=><li>${escapeHtml(c)}</li>).join("")}
        </ul>
      </div>
      <div>
        <h3>Actions recommand√©es</h3>
        <ul class="muted" style="margin:10px 0 0; padding-left:18px">
          ${it.actions.map(a=><li>${escapeHtml(a)}</li>).join("")}
        </ul>
      </div>
    </div>
  ;
}

function openSavForm(){
  if(!requireAuth()) return;
  if(!state.sav.symptom){
    toast("SAV", "Choisis d‚Äôabord un sympt√¥me.");
    return;
  }

  // sync vendor problem
  state.sav.vendorProblem = ($("#savVendorProblem").value || "").trim();
  saveState();

  $("#savClientName").value = "";
  $("#savPurchaseDate").value = "";
  $("#savProductRef").value = "";
  $("#savGoodState").value = "yes";
  $("#savPortOk").value = "yes";
  $("#savBoxPresent").value = "yes";
  $("#savCablePresent").value = "yes";
  $("#savProblemText").value = state.sav.vendorProblem || "";
  const symLabel = (savMap.find(x=>x.id===state.sav.symptom)?.t || state.sav.symptom);
  $("#savSymptomLabel").textContent = symLabel;
  $("#savSymptomReadOnly").value = symLabel;
  $("#savDecisionBox").textContent = "‚Äî";

  // Autofire block toggle
  $("#autofireBlock").style.display = (state.sav.symptom === "autofire") ? "block" : "none";
  $("#savLiquidInSensor").value = "no";
  $("#savAutofireNote").value = "";

  $("#savModal").classList.add("show");
  audit("SAV_OPEN_FORM", state.sav.symptom);
}
function closeSavModal(){ $("#savModal").classList.remove("show"); }

function computeSavDecision(data){
  const reasons = [];
  if(!data.clientName) reasons.push("Nom/pr√©nom client manquant");
  if(!data.purchaseDate) reasons.push("Date d‚Äôachat manquante");

  // REF obligatoire
  if(!data.productRef) reasons.push("R√©f√©rence produit manquante");

  // r√®gles garantie standard
  if(data.goodState !== "yes") reasons.push("Produit non en bon √©tat (trace de chute/casse)");
  if(data.portOk !== "yes") reasons.push("Port de charge non intact");
  if(data.boxPresent !== "yes") reasons.push("Bo√Æte produit absente");
  if(data.cablePresent !== "yes") reasons.push("C√¢ble de charge absent");

  // r√®gle AUTOFIRE demand√©e
  if(data.symptom === "autofire" && data.liquidInSensor === "yes"){
    reasons.push("Autofire + liquide dans capteur d‚Äôaspiration : refus automatique (usage)");
  }

  const ok = reasons.length === 0;
  return { ok, reasons };
}

function previewSavEligibility(){
  const data = {
    clientName: ($("#savClientName").value||"").trim(),
    purchaseDate: $("#savPurchaseDate").value,
    productRef: ($("#savProductRef").value||"").trim(),
    goodState: $("#savGoodState").value,
    portOk: $("#savPortOk").value,
    boxPresent: $("#savBoxPresent").
      boxPresent: $("#savBoxPresent").value,
    cablePresent: $("#savCablePresent").value,
    liquidInSensor: $("#savLiquidInSensor") ? $("#savLiquidInSensor").value : "no",
    symptom: state.sav.symptom
  };

  const decision = computeSavDecision(data);

  const box = $("#savDecisionBox");
  if(decision.ok){
    box.innerHTML = `<span class="goodText"><b>PRISE EN GARANTIE POSSIBLE</b></span><br/>Aucune anomalie bloquante d√©tect√©e.`;
  } else {
    box.innerHTML = `
      <span class="dangerText"><b>PRISE EN GARANTIE IMPOSSIBLE</b></span>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px">
        ${decision.reasons.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}
      </ul>
    `;
  }
}

function validateSavAndPrint(){
  if(!requireAuth()) return;

  const data = {
    clientName: ($("#savClientName").value||"").trim(),
    purchaseDate: $("#savPurchaseDate").value,
    productRef: ($("#savProductRef").value||"").trim(),
    goodState: $("#savGoodState").value,
    portOk: $("#savPortOk").value,
    boxPresent: $("#savBoxPresent").value,
    cablePresent: $("#savCablePresent").value,
    liquidInSensor: $("#savLiquidInSensor") ? $("#savLiquidInSensor").value : "no",
    autofireNote: ($("#savAutofireNote").value||"").trim(),
    symptom: state.sav.symptom,
    symptomLabel: $("#savSymptomReadOnly").value,
    problemText: ($("#savProblemText").value||"").trim()
  };

  const decision = computeSavDecision(data);
  if(!decision.ok){
    previewSavEligibility();
    audit("SAV_REFUSED", decision.reasons.join(" | "));
    return;
  }

  audit("SAV_ACCEPTED", data.symptom);

  const seller = state.currentUser?.name || "‚Äî";
  const now = formatDateTimeFR(Date.now());

  state.sav.lastSavSheet = {
    ...data,
    seller,
    when: now
  };
  saveState();

  const html = `
<!doctype html><html><head><meta charset="utf-8"/>
<title>Fiche SAV STOOM</title>
<style>
body{font-family:Arial, sans-serif; padding:24px; color:#0b1220}
h1{margin:0 0 6px; font-size:18px}
.sub{color:#334155; margin:0 0 16px; font-size:12px}
.card{border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin:12px 0}
.hr{height:1px;background:#e2e8f0;margin:12px 0}
.bad{color:#b91c1c;font-weight:700}
.good{color:#15803d;font-weight:700}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head><body>

<h1>STOOM ‚Ä¢ FICHE SAV</h1>
<p class="sub">Trait√©e le ${escapeHtml(now)} ‚Ä¢ Vendeur : ${escapeHtml(seller)}</p>

<div class="card">
<b>Client :</b> ${escapeHtml(data.clientName)}<br/>
<b>Date d‚Äôachat :</b> ${escapeHtml(data.purchaseDate)}<br/>
<b>R√©f√©rence produit :</b> ${escapeHtml(data.productRef)}<br/>
<b>Sympt√¥me :</b> ${escapeHtml(data.symptomLabel)}
</div>

<div class="card">
<b>√âtat du produit</b><br/>
Bon √©tat : ${data.goodState}<br/>
Port de charge intact : ${data.portOk}<br/>
Bo√Æte pr√©sente : ${data.boxPresent}<br/>
C√¢ble pr√©sent : ${data.cablePresent}
${data.symptom==="autofire" ? `<div class="hr"/><b>Autofire :</b><br/>Liquide dans capteur : ${data.liquidInSensor}<br/>${escapeHtml(data.autofireNote)}` : ""}
</div>

<div class="card">
<b>Probl√®me constat√©</b><br/>
<p>${escapeHtml(data.problemText)}</p>
</div>

<div class="card">
<span class="good">PRISE EN GARANTIE ACCEPT√âE</span>
</div>

</body></html>
`;

  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
  closeSavModal();
}

/* ---------- Home helpers ---------- */
function refreshSidebarMini(){
  $("#today").textContent = formatDateFR(new Date());
  $("#userMini").textContent = state.currentUser?.name || "‚Äî";
  $("#roleMini").textContent = state.currentUser?.role || "‚Äî";
  $("#sheetMini").textContent = state.client.sheet ? "Client" : (state.sav.lastSavSheet ? "SAV" : "‚Äî");
}
function refreshHomeLastSheet(){
  const box = $("#lastSheetBox");
  if(state.client.sheet){
    box.innerHTML = `<h3>Fiche client disponible</h3><p class="muted">Tu peux la r√©-imprimer.</p>`;
  } else {
    box.innerHTML = `<h3>‚Äî</h3><p class="muted">Aucune fiche pour le moment.</p>`;
  }
}
function reprintLastSav(){
  if(!state.sav.lastSavSheet){
    toast("SAV", "Aucune fiche SAV.");
    return;
  }
  const s = state.sav.lastSavSheet;
  audit("SAV_REPRINT", s.productRef);
  alert("La fiche SAV sera r√©imprim√©e via l‚Äôhistorique (fonctionnel en V3).");
}

/* ---------- Notes ---------- */
function saveNote(){
  if(!requireAuth()) return;
  const name = ($("#noteName").value||"").trim();
  const phone = ($("#notePhone").value||"").trim();
  const text = ($("#noteText").value||"").trim();
  if(!name || !text){
    toast("Note", "Nom et note requis.");
    return;
  }
  state.notes.unshift({
    id: Date.now(),
    name,
    phone,
    text,
    who: state.currentUser.name,
    ts: Date.now()
  });
  audit("NOTE_SAVE", name);
  saveState();
  renderNotes();
  clearNoteForm();
}
function clearNoteForm(){
  $("#noteName").value="";
  $("#notePhone").value="";
  $("#noteText").value="";
}
function renderNotes(){
  const list = $("#notesList");
  const f = ($("#noteFilter")?.value||"").toLowerCase();
  list.innerHTML="";
  state.notes
    .filter(n=> !f || `${n.name} ${n.text} ${n.phone}`.toLowerCase().includes(f))
    .forEach(n=>{
      const d = document.createElement("div");
      d.className="item";
      d.innerHTML=`
        <div class="top">
          <strong>${escapeHtml(n.name)}</strong>
          <span>${escapeHtml(formatDateTimeFR(n.ts))}</span>
        </div>
        <p>${escapeHtml(n.text)}</p>
        <p class="small mono">par ${escapeHtml(n.who)}</p>
      `;
      list.appendChild(d);
    });
}

/* ---------- Init ---------- */
function init(){
  bindNav();
  $("#authBtn").onclick = ()=> openAuthModal(true);
  $("#logoutBtn").onclick = logout;
  $("#printBtn").onclick = printSheet;
  $("#exportStateBtn").onclick = exportFullState;
  $("#importStateBtn").onclick = openImportModal;
  $("#resetBtn").onclick = clearAll;
  $("#searchInput").addEventListener("keydown", e=>{
    if(e.key==="Enter") runSearch(e.target.value);
  });
  document.addEventListener("keydown", e=>{
    if(e.key==="/"){ e.preventDefault(); $("#searchInput").focus(); }
    if(e.key==="Escape") $(".modal.show")?.classList.remove("show");
  });

  refreshAuthUI();
  go(state.view || "home");
}
init();
</script>

</body>
</html>
